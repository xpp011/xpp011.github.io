<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon2.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xpp011.cn","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#836FFF","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="目前国内企业使用的微服务框架主要是Spring Cloud和Dubbo（或者DubboX），但是Dubbo那两年的停更严重打击了开发人员对它的信心，Spring Cloud已经逐渐成为主流，比较两个框架的优劣势的文章在网上有很多，这里就不重复了，选择什么框架还是按业务需求来吧，业务框架决定技术框架。 Spring Cloud全家桶提供了各种各样的组件，基本可以覆盖微服务的服务治理的方方面面，以下列">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud学习笔记">
<meta property="og:url" content="http://xpp011.cn/2021/11/04/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="鸟窝">
<meta property="og:description" content="目前国内企业使用的微服务框架主要是Spring Cloud和Dubbo（或者DubboX），但是Dubbo那两年的停更严重打击了开发人员对它的信心，Spring Cloud已经逐渐成为主流，比较两个框架的优劣势的文章在网上有很多，这里就不重复了，选择什么框架还是按业务需求来吧，业务框架决定技术框架。 Spring Cloud全家桶提供了各种各样的组件，基本可以覆盖微服务的服务治理的方方面面，以下列">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mrhelloworld.com/resources/articles/spring/spring-cloud/nacos/cap.jpg">
<meta property="og:image" content="http://www.hollischuang.com/wp-content/uploads/2016/03/intro_thumb.png">
<meta property="og:image" content="http://www.hollischuang.com/wp-content/uploads/2016/03/scenario1_thumb.png">
<meta property="og:image" content="http://www.hollischuang.com/wp-content/uploads/2016/03/scenario2_thumb.png">
<meta property="og:image" content="https://spring.io/images/cloud-diagram-1a4cad7294b4452864b5ff57175dd983.svg">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7584230-15823c00f06065e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/805/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7584230-86a2f52455c26c42.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/883/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7584230-52d4cbf05f0694c8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/928/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7584230-878e10904e206df0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/750/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7584230-9ec9d0d62f548d00.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/753/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7584230-186f38bae8b64850.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/661/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7584230-16df8f7fbee37f37.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp">
<meta property="og:image" content="http://xpp011.cn/.cn//C:%5CUsers%5C25001%5CDownloads%5CSpringCloud%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/20/16e86737ea057126~tplv-t2oaga2asx-watermark.awebp">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20210828215534455.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20210828225616988.png">
<meta property="og:image" content="http://xpp011.cn/.cn//C:%5CUsers%5C25001%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210828233330338.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20210828233602228.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829162245744.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829185008406.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829165523568.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829185235783.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829190509879.png">
<meta property="og:image" content="https://pic2.zhimg.com/80/v2-658f17773d4ec949a32affb2a7476779_720w.jpg">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-0104febb658f8eeaa626654f5be980d2_720w.jpg">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-4fb6c809e868f2a897f87580f2786d4c_720w.jpg">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-8f08b87f73a9707c9b25a7d711e4b74e_720w.jpg">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-05b0cfff0ccb3fc5093b4581d3d7399a_720w.jpg">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20190708203002230.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F3ZTg2MzE0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905175006524.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905180346665.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905180405626.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905180419978.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905215249994.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905220859704.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905222855447.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905224409054.png">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/874963/201807/874963-20180730172725624-245631738.png">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/874963/201807/874963-20180730172821821-960520983.png">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/874963/201807/874963-20180730172949326-29467411.png">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/874963/201807/874963-20180730173442729-1485668320.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210914221535525.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210914225806424.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210919232336198.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210920093306269.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/17742950-f8db8dc0ceb552d0.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/426/format/webp">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/17742950-9cedc9cd8d8d650f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/222/format/webp">
<meta property="og:image" content="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9mUm1lRHh6TWwwY29CbDhpY1dRYWlhUzkxMjBlb3NMeFBJcmpSOHJVanVibWR0ZGljNjVZOFpscFNwS0E4VVNaMm5WeXppY0lzak9pY0x0aHk0Zkh5aWNGNlVZdy82NDA?x-oss-process=image/format,png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210920214244811.png">
<meta property="og:image" content="http://xpp011.cn/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210920233734739.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211002203840220.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211002222438403.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211002222617485.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-7032af539f437112f77049540c43a4d4_720w.jpg">
<meta property="og:image" content="https://imgconvert.csdnimg.cn/aHR0cDovL2Nvcy5yYWluMTAyNC5jb20vbWFya2Rvd24vaW1hZ2UtMjAxOTEwMDgxNjA3MTM4MjIucG5n?x-oss-process=image/format,png">
<meta property="og:image" content="https://imgconvert.csdnimg.cn/aHR0cDovL2Nvcy5yYWluMTAyNC5jb20vbWFya2Rvd24vaW1hZ2UtMjAxOTEwMDgxNjA4MDkxNDYucG5n?x-oss-process=image/format,png">
<meta property="og:image" content="https://imgconvert.csdnimg.cn/aHR0cDovL2Nvcy5yYWluMTAyNC5jb20vbWFya2Rvd24vaW1hZ2UtMjAxOTEwMDgxNjA4MjU3MzEucG5n?x-oss-process=image/format,png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211004215809123.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211004221257312.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211004223328304.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211004234409248.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211004234509330.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211006220125018.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211006214022352.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211006222548407.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211006233429203.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211007233342550.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010212147266.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010214218994.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010214014644.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010214941171.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010215344172.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010222054367.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010222358996.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010223044389.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010223305669.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010223929087.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211010231555727.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211011233415816.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211011233951478.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20181204172531555.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4Mjg4NjA2,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211012233333782.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211012233456226.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211012233655669.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211013225729943.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211013232651862.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211014233758209.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211017230643101.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211017230810336.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211018234828163.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211018234917430.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211018233825488.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211018234719180.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-dda8eb422443d1fe51778449322c6710_720w.jpg">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-5c0639334a2dd2ed64883842e0a5c9e6_720w.jpg">
<meta property="og:image" content="https://pic2.zhimg.com/80/v2-456c15a52635b52f91de335afeccba2d_720w.jpg">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-412974ef70e7998f6537e394d40660df_720w.jpg">
<meta property="og:image" content="https://pic2.zhimg.com/80/v2-613fbad15779ac22757cdaa2cab3f801_720w.jpg">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211019215225929.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211019215515317.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211020225210766.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211020225359060.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211019215225929.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211021225253496.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211021231318886.png">
<meta property="og:image" content="https://mrhelloworld.com/resources/articles/spring/spring-cloud/sleuth/v2-a32471042408c726c7c944456f8e1e34_hd.jpg">
<meta property="og:image" content="https://mrhelloworld.com/resources/articles/spring/spring-cloud/sleuth/zipkin.jpg">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211023235811506.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211023232332840.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211023232508959.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211023235840371.png">
<meta property="og:image" content="https://mrhelloworld.com/resources/articles/spring/spring-cloud/sleuth/1569484-20190414155801823-317987095.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211024174147995.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211024225729852.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211024230719477.png">
<meta property="og:image" content="https://mrhelloworld.com/resources/articles/spring/spring-cloud/nacos/timg.jpg">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211028223900047.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211031175252944.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211031215829446.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211031222347831.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211031231823009.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211101211125724.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211101210710702.png">
<meta property="og:image" content="http://typora.xpp011.cn/typora/img/image-20211101211632460.png">
<meta property="article:published_time" content="2021-11-03T16:00:50.000Z">
<meta property="article:modified_time" content="2021-11-06T07:51:35.444Z">
<meta property="article:author" content="xpp011">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mrhelloworld.com/resources/articles/spring/spring-cloud/nacos/cap.jpg">

<link rel="canonical" href="http://xpp011.cn/2021/11/04/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SpringCloud学习笔记 | 鸟窝</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">鸟窝</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/xpp011" class="github-corner" title="叽叽叽叽" aria-label="叽叽叽叽" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xpp011.cn/2021/11/04/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tx.png">
      <meta itemprop="name" content="xpp011">
      <meta itemprop="description" content="欢迎来到我的博客，希望你能在这里找到有用的东西">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鸟窝">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringCloud学习笔记
        </h1>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-04 00:00:50" itemprop="dateCreated datePublished" datetime="2021-11-04T00:00:50+08:00">2021-11-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-06 15:51:35" itemprop="dateModified" datetime="2021-11-06T15:51:35+08:00">2021-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringCloud/" itemprop="url" rel="index"><span itemprop="name">SpringCloud</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringCloud/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          
          
          <br>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/11/04/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/11/04/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>119k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:48</span>
            </span>
            <div class="post-description">目前国内企业使用的微服务框架主要是Spring Cloud和Dubbo（或者DubboX），但是Dubbo那两年的停更严重打击了开发人员对它的信心，Spring Cloud已经逐渐成为主流，比较两个框架的优劣势的文章在网上有很多，这里就不重复了，选择什么框架还是按业务需求来吧，业务框架决定技术框架。 Spring Cloud全家桶提供了各种各样的组件，基本可以覆盖微服务的服务治理的方方面面，以下列出了Spring Cloud一些常用组件：</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>SpringCloud</p>
<p>各大网站收录的不安全端口列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>,    <span class="comment">// tcpmux</span></span><br><span class="line"><span class="number">7</span>,    <span class="comment">// echo</span></span><br><span class="line"><span class="number">9</span>,    <span class="comment">// discard</span></span><br><span class="line"><span class="number">11</span>,   <span class="comment">// systat</span></span><br><span class="line"><span class="number">13</span>,   <span class="comment">// daytime</span></span><br><span class="line"><span class="number">15</span>,   <span class="comment">// netstat</span></span><br><span class="line"><span class="number">17</span>,   <span class="comment">// qotd</span></span><br><span class="line"><span class="number">19</span>,   <span class="comment">// chargen</span></span><br><span class="line"><span class="number">20</span>,   <span class="comment">// ftp data</span></span><br><span class="line"><span class="number">21</span>,   <span class="comment">// ftp access</span></span><br><span class="line"><span class="number">22</span>,   <span class="comment">// ssh</span></span><br><span class="line"><span class="number">23</span>,   <span class="comment">// telnet</span></span><br><span class="line"><span class="number">25</span>,   <span class="comment">// smtp</span></span><br><span class="line"><span class="number">37</span>,   <span class="comment">// time</span></span><br><span class="line"><span class="number">42</span>,   <span class="comment">// name</span></span><br><span class="line"><span class="number">43</span>,   <span class="comment">// nicname</span></span><br><span class="line"><span class="number">53</span>,   <span class="comment">// domain</span></span><br><span class="line"><span class="number">77</span>,   <span class="comment">// priv-rjs</span></span><br><span class="line"><span class="number">79</span>,   <span class="comment">// finger</span></span><br><span class="line"><span class="number">87</span>,   <span class="comment">// ttylink</span></span><br><span class="line"><span class="number">95</span>,   <span class="comment">// supdup</span></span><br><span class="line"><span class="number">101</span>,  <span class="comment">// hostriame</span></span><br><span class="line"><span class="number">102</span>,  <span class="comment">// iso-tsap</span></span><br><span class="line"><span class="number">103</span>,  <span class="comment">// gppitnp</span></span><br><span class="line"><span class="number">104</span>,  <span class="comment">// acr-nema</span></span><br><span class="line"><span class="number">109</span>,  <span class="comment">// pop2</span></span><br><span class="line"><span class="number">110</span>,  <span class="comment">// pop3</span></span><br><span class="line"><span class="number">111</span>,  <span class="comment">// sunrpc</span></span><br><span class="line"><span class="number">113</span>,  <span class="comment">// auth</span></span><br><span class="line"><span class="number">115</span>,  <span class="comment">// sftp</span></span><br><span class="line"><span class="number">117</span>,  <span class="comment">// uucp-path</span></span><br><span class="line"><span class="number">119</span>,  <span class="comment">// nntp</span></span><br><span class="line"><span class="number">123</span>,  <span class="comment">// NTP</span></span><br><span class="line"><span class="number">135</span>,  <span class="comment">// loc-srv /epmap</span></span><br><span class="line"><span class="number">139</span>,  <span class="comment">// netbios</span></span><br><span class="line"><span class="number">143</span>,  <span class="comment">// imap2</span></span><br><span class="line"><span class="number">179</span>,  <span class="comment">// BGP</span></span><br><span class="line"><span class="number">389</span>,  <span class="comment">// ldap</span></span><br><span class="line"><span class="number">465</span>,  <span class="comment">// smtp+ssl</span></span><br><span class="line"><span class="number">512</span>,  <span class="comment">// print / exec</span></span><br><span class="line"><span class="number">513</span>,  <span class="comment">// login</span></span><br><span class="line"><span class="number">514</span>,  <span class="comment">// shell</span></span><br><span class="line"><span class="number">515</span>,  <span class="comment">// printer</span></span><br><span class="line"><span class="number">526</span>,  <span class="comment">// tempo</span></span><br><span class="line"><span class="number">530</span>,  <span class="comment">// courier</span></span><br><span class="line"><span class="number">531</span>,  <span class="comment">// chat</span></span><br><span class="line"><span class="number">532</span>,  <span class="comment">// netnews</span></span><br><span class="line"><span class="number">540</span>,  <span class="comment">// uucp</span></span><br><span class="line"><span class="number">556</span>,  <span class="comment">// remotefs</span></span><br><span class="line"><span class="number">563</span>,  <span class="comment">// nntp+ssl</span></span><br><span class="line"><span class="number">587</span>,  <span class="comment">// stmp?</span></span><br><span class="line"><span class="number">601</span>,  <span class="comment">// ??</span></span><br><span class="line"><span class="number">636</span>,  <span class="comment">// ldap+ssl</span></span><br><span class="line"><span class="number">993</span>,  <span class="comment">// ldap+ssl</span></span><br><span class="line"><span class="number">995</span>,  <span class="comment">// pop3+ssl</span></span><br><span class="line"><span class="number">2049</span>, <span class="comment">// nfs</span></span><br><span class="line"><span class="number">3659</span>, <span class="comment">// apple-sasl / PasswordServer</span></span><br><span class="line"><span class="number">4045</span>, <span class="comment">// lockd</span></span><br><span class="line"><span class="number">6000</span>, <span class="comment">// X11</span></span><br><span class="line"><span class="number">6665</span>, <span class="comment">// Alternate IRC</span></span><br><span class="line"><span class="number">6666</span>, <span class="comment">// Alternate IRC</span></span><br><span class="line"><span class="number">6667</span>, <span class="comment">// Standard IRC</span></span><br><span class="line"><span class="number">6668</span>, <span class="comment">// Alternate IRC</span></span><br><span class="line"><span class="number">6669</span>, <span class="comment">// Alternate IRC</span></span><br></pre></td></tr></table></figure>
<h2 id="CAP-原则与-BASE-理论">CAP 原则与 BASE 理论</h2>
<p></p>
<h3 id="CAP-原则">CAP 原则</h3>
<p></p>
<p><a target="_blank" rel="noopener" href="https://mrhelloworld.com/resources/articles/spring/spring-cloud/nacos/cap.jpg"><img src="https://mrhelloworld.com/resources/articles/spring/spring-cloud/nacos/cap.jpg" alt="/resources/articles/spring/spring-cloud/nacos/cap.jpg"></a></p>
<p></p>
<p>CAP 原则又称 CAP 定理，指的是在一个分布式系统中， Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼。</p>
<p>CAP 由 Eric Brewer 在 2000 年 PODC 会议上提出。该猜想在提出两年后被证明成立，成为我们熟知的 CAP 定理。CAP 三者不可兼得。</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>定理</th>
</tr>
</thead>
<tbody>
<tr>
<td>Consistency</td>
<td>也叫做数据原子性，系统在执行某项操作后仍然处于一致的状态。在分布式系统中，更新操作执行成功后所有的用户都应该读到最新的值，这样的系统被认为是具有强一致性的。等同于所有节点访问同一份最新的数据副本。</td>
</tr>
<tr>
<td>Availability</td>
<td>每一个操作总是能够在一定的时间内返回结果，这里需要注意的是&quot;一定时间内&quot;和&quot;返回结果”。一定时间内指的是，在可以容忍的范围内返回结果，结果可以是成功或者是失败。</td>
</tr>
<tr>
<td>Partition tolerance</td>
<td>在网络分区的情况下，被分隔的节点仍能正常对外提供服务(分布式集群，数据被分布存储在不同的服务器上，无论什么情况，服务器都能正常被访问)。</td>
</tr>
</tbody>
</table>
<p></p>
<h4 id="CAP的证明">CAP的证明</h4>
<p><img src="http://www.hollischuang.com/wp-content/uploads/2016/03/intro_thumb.png" alt="intro_thumb"></p>
<p>如上图，是我们证明CAP的基本场景，网络中有两个节点N1和N2，可以简单的理解N1和N2分别是两台计算机，他们之间网络可以连通，N1中有一个应用程序A，和一个数据库V，N2也有一个应用程序B2和一个数据库V。现在，A和B是分布式系统的两个部分，V是分布式系统的数据存储的两个子数据库。</p>
<p>在满足一致性的时候，N1和N2中的数据是一样的，V0=V0。在满足可用性的时候，用户不管是请求N1或者N2，都会得到立即响应。在满足分区容错性的情况下，N1和N2有任何一方宕机，或者网络不通的时候，都不会影响N1和N2彼此之间的正常运作。</p>
<p><img src="http://www.hollischuang.com/wp-content/uploads/2016/03/scenario1_thumb.png" alt="scenario1_thumb"></p>
<p>如上图，是分布式系统正常运转的流程，用户向N1机器请求数据更新，程序A更新数据库Vo为V1，分布式系统将数据进行同步操作M，将V1同步的N2中V0，使得N2中的数据V0也更新为V1，N2中的数据再响应N2的请求。</p>
<p>这里，可以定义N1和N2的数据库V之间的数据是否一样为一致性；外部对N1和N2的请求响应为可用行；N1和N2之间的网络环境为分区容错性。这是正常运作的场景，也是理想的场景，然而现实是残酷的，当错误发生的时候，一致性和可用性还有分区容错性，是否能同时满足，还是说要进行取舍呢？</p>
<p>作为一个分布式系统，它和单机系统的最大区别，就在于网络，现在假设一种极端情况，N1和N2之间的网络断开了，我们要支持这种网络异常，相当于要满足分区容错性，能不能同时满足一致性和响应性呢？还是说要对他们进行取舍。</p>
<p><img src="http://www.hollischuang.com/wp-content/uploads/2016/03/scenario2_thumb.png" alt="scenario2_thumb"></p>
<p>假设在N1和N2之间网络断开的时候，有用户向N1发送数据更新请求，那N1中的数据V0将被更新为V1，由于网络是断开的，所以分布式系统同步操作M，所以N2中的数据依旧是V0；这个时候，有用户向N2发送数据读取请求，由于数据还没有进行同步，应用程序没办法立即给用户返回最新的数据V1，怎么办呢？</p>
<p>有二种选择，第一，牺牲数据一致性，保证可用性。响应旧的数据V0给用户；</p>
<p>第二，牺牲可用性，保证数据一致性。阻塞等待，直到网络连接恢复，数据更新操作M完成之后，再给用户响应最新的数据V1。</p>
<p>这个过程，证明了要满足分区容错性的分布式系统，只能在一致性和可用性两者中，选择其中一个。</p>
<h4 id="取舍策略">取舍策略</h4>
<p></p>
<p>CAP 三个特性只能满足其中两个，那么取舍的策略就共有三种：</p>
<ul>
<li><strong>CA without P</strong>：如果不要求P（不允许分区），则C（强一致性）和A（可用性）是可以保证的。但放弃 P 的同时也就意味着放弃了系统的扩展性，也就是分布式节点受限，没办法部署子节点，这是违背分布式系统设计的初衷的。</li>
<li><strong>CP without A</strong>：如果不要求A（可用），相当于每个请求都需要在服务器之间保持强一致，而P（分区）会导致同步时间无限延长（也就是等待数据同步完才能正常访问服务），一旦发生网络故障或者消息丢失等情况，就要牺牲用户的体验，等待所有数据全部一致了之后再让用户访问系统。设计成 CP 的系统其实不少，最典型的就是分布式数据库，如 Redis、HBase 等。对于这些分布式数据库来说，数据的一致性是最基本的要求，因为如果连这个标准都达不到，那么直接采用关系型数据库就好，没必要再浪费资源来部署分布式数据库。</li>
<li><strong>AP without C</strong>：要高可用并允许分区，则需放弃一致性。一旦分区发生，节点之间可能会失去联系，为了高可用，每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。典型的应用就如某米的抢购手机场景，可能前几秒你浏览商品的时候页面提示是有库存的，当你选择完商品准备下单的时候，系统提示你下单失败，商品已售完。这其实就是先在 A（可用性）方面保证系统可以正常的服务，然后在数据的一致性方面做了些牺牲，虽然多少会影响一些用户体验，但也不至于造成用户购物流程的严重阻塞。</li>
</ul>
<p></p>
<h4 id="总结">总结</h4>
<p></p>
<p>现如今，对于多数大型互联网应用的场景，主机众多、部署分散，而且现在的集群规模越来越大，节点只会越来越多，所以节点故障、网络故障是常态，因此分区容错性也就成为了一个分布式系统必然要面对的问题。那么就只能在 C 和 A 之间进行取舍。但对于传统的项目就可能有所不同，拿银行的转账系统来说，涉及到金钱的对于数据一致性不能做出一丝的让步，C 必须保证，出现网络故障的话，宁可停止服务，可以在 A 和 P 之间做取舍。</p>
<p>总而言之，没有最好的策略，好的系统应该是根据业务场景来进行架构设计的，只有适合的才是最好的。</p>
<p></p>
<h3 id="BASE-理论">BASE 理论</h3>
<p></p>
<p>CAP 理论已经提出好多年了，难道真的没有办法解决这个问题吗？也许可以做些改变。比如 C 不必使用那么强的一致性，可以先将数据存起来，稍后再更新，实现所谓的 “最终一致性”。</p>
<p>这个思路又是一个庞大的问题，同时也引出了第二个理论 BASE 理论。</p>
<blockquote>
<p>BASE：全称 Basically Available（基本可用），Soft state（软状态），和 Eventually consistent（最终一致性）三个短语的缩写，来自 ebay 的架构师提出。</p>
</blockquote>
<p>BASE 理论是对 CAP 中一致性和可用性权衡的结果，其来源于对大型互联网分布式实践的总结，是基于 CAP 定理逐步演化而来的。其核心思想是：</p>
<blockquote>
<p>既然无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。</p>
</blockquote>
<p></p>
<h4 id="Basically-Available（基本可用）">Basically Available（基本可用）</h4>
<p></p>
<p>基本可用是指分布式系统在出现故障的时候，允许损失部分可用性（例如响应时间、功能上的可用性）。需要注意的是，基本可用绝不等价于系统不可用。</p>
<ul>
<li>响应时间上的损失：正常情况下搜索引擎需要在 0.5 秒之内返回给用户相应的查询结果，但由于出现故障（比如系统部分机房发生断电或断网故障），查询结果的响应时间增加到了 1~2 秒。</li>
<li>功能上的损失：购物网站在购物高峰（如双十一）时，为了保护系统的稳定性，部分消费者可能会被引导到一个降级页面。</li>
</ul>
<p></p>
<h4 id="Soft-state（软状态）">Soft state（软状态）</h4>
<p></p>
<p>什么是软状态呢？相对于原子性而言，要求多个节点的数据副本都是一致的，这是一种 “硬状态”。</p>
<p>软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据会有多个副本，允许不同副本数据同步的延时就是软状态的体现。</p>
<p></p>
<h4 id="Eventually-consistent（最终一致性）">Eventually consistent（最终一致性）</h4>
<p></p>
<p>系统不可能一直是软状态，必须有个时间期限。在期限过后，应当保证所有副本保持数据一致性。从而达到数据的最终一致性。这个时间期限取决于网络延时，系统负载，数据复制方案设计等等因素。</p>
<p>实际上，不只是分布式系统使用最终一致性，关系型数据库在某个功能上，也是使用最终一致性的，比如备份，数据库的复制都是需要时间的，这个复制过程中，业务读取到的值就是旧值。当然，最终还是达成了数据一致性。这也算是一个最终一致性的经典案例。</p>
<p></p>
<h4 id="总结-2">总结</h4>
<p></p>
<p>总的来说，BASE 理论面向的是大型高可用可扩展的分布式系统，和传统事务的 ACID 是相反的，它完全不同于 ACID 的强一致性模型，而是通过牺牲强一致性来获得可用性，并允许数据在一段时间是不一致的。</p>
<p></p>
<h2 id="一，微服务介绍">一，微服务介绍</h2>
<p><img src="https://spring.io/images/cloud-diagram-1a4cad7294b4452864b5ff57175dd983.svg" alt="Spring Cloud diagram"></p>
<p>刚开始进入软件行业时还是单体应用的时代，前后端分离的概念都还没普及，开发的时候需要花大量的时间在“强大”的JSP上面，那时候SOA已经算是新技术了。现在，微服务已经大行其道，有哪个互联网产品不说自己是微服务架构呢？</p>
<p>但是，对于微服务的理解每个人都不太一样，这篇文章主要是聊一聊我对微服务的理解以及如何搭建经典的微服务架构，目的是梳理一下自己的一些想法，如果存在不同看法的欢迎指正！</p>
<h3 id="什么是微服务">什么是微服务</h3>
<p>首先，什么是微服务呢？</p>
<h3 id="单体应用">单体应用</h3>
<p>相对的，要理解什么是微服务，那么可以先理解什么是单体应用，在没有提出微服务的概念的“远古”年代，一个软件应用，往往会将应用所有功能都开发和打包在一起，那时候的一个B/S应用架构往往是这样的：</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/7584230-15823c00f06065e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/805/format/webp" alt="img"></p>
<p>​																		 <a href>B/S</a></p>
<p>但是，当用户访问量变大导致一台服务器无法支撑时怎么办呢？加服务器加负载均衡，架构就变成这样了：</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/7584230-86a2f52455c26c42.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/883/format/webp" alt="img"></p>
<p>​															<a href>B/S+负载均衡</a></p>
<p>后面发现把静态文件独立出来，通过CDN等手段进行加速，可以提升应用的整体相应，单体应用的架构就变成：</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/7584230-52d4cbf05f0694c8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/928/format/webp" alt="img"></p>
<p>​															<a href>B/S+前后端分离</a></p>
<p>上面3中架构都还是单体应用，只是在部署方面进行了优化，所以避免不了单体应用的根本的缺点：</p>
<ul>
<li>代码臃肿，应用启动时间长；（代码超过1G的项目都有！）</li>
<li>回归测试周期长，修复一个小小bug可能都需要对所有关键业务进行回归测试。</li>
<li>应用容错性差，某个小小功能的程序错误可能导致整个系统宕机；</li>
<li>伸缩困难，单体应用扩展性能时只能整个应用进行扩展，造成计算资源浪费。</li>
<li>开发协作困难，一个大型应用系统，可能几十个甚至上百个开发人员，大家都在维护一套代码的话，代码merge复杂度急剧增加。</li>
</ul>
<h3 id="微服务">微服务</h3>
<p>我认为任何技术的演进都是有迹可循的，任何新技术的出现都是为了解决原有技术无法解决的需求，所以，微服务的出现就是因为原来单体应用架构已经无法满足当前互联网产品的技术需求。</p>
<p>在微服务架构之前还有一个概念：SOA（Service-Oriented Architecture）-面向服务的体系架构。我认为的SOA只是一个架构模型的方法论，并不是一个明确而严谨的架构标准，只是后面很多人将SOA与The Open Group的SOA参考模型等同了，认为严格按照TOG-SOA标准的才算真正的SOA架构。SOA就已经提出的面向服务的架构思想，所以微服务应该算是SOA的一种演进吧。</p>
<p>撇开架构先不说，什么样的服务才算微服务呢？</p>
<ul>
<li>单一职责的。一个微服务应该都是单一职责的，这才是“微”的体现，一个微服务解决一个业务问题（注意是一个业务问题而不是一个接口）。</li>
<li>面向服务的。将自己的业务能力封装并对外提供服务，这是继承SOA的核心思想，一个微服务本身也可能使用到其它微服务的能力。<br>
<strong>我觉得满足以上两点就可以认为典型的微服务。</strong></li>
</ul>
<h3 id="微服务典型架构">微服务典型架构</h3>
<p>微服务架构，核心是为了解决应用微服务化之后的服务治理问题。</p>
<p>应用微服务化之后，首先遇到的第一个问题就是服务发现问题，一个微服务如何发现其他微服务呢？最简单的方式就是每个微服务里面配置其他微服务的地址，但是当微服务数量众多的时候，这样做明显不现实。所以需要使用到微服务架构中的一个最重要的组件：<strong>服务注册中心</strong>，所有服务都注册到服务注册中心，同时也可以从服务注册中心获取当前可用的服务清单：</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/7584230-878e10904e206df0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/750/format/webp" alt="img"></p>
<p>​																												 <a href>服务注册中心</a></p>
<p>解决服务发现问题后，接着需要解决微服务分布式部署带来的第二个问题：服务配置管理的问题。当服务数量超过一定程度之后，如果需要在每个服务里面分别维护每一个服务的配置文件，运维人员估计要哭了。那么，就需要用到微服务架构里面第二个重要的组件：<strong>配置中心</strong>，微服务架构就变成下面这样了：</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/7584230-9ec9d0d62f548d00.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/753/format/webp" alt="img"></p>
<p>​																<a href>配置中心</a></p>
<p>以上应用内部的服务治理，当客户端或外部应用调用服务的时候怎么处理呢？服务A可能有多个节点，服务A、服务B和服务C的服务地址都不同，服务授权验证在哪里做？这时，就需要使用到服务网关提供统一的服务入口，最终形成典型微服务架构：</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/7584230-186f38bae8b64850.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/661/format/webp" alt="img"></p>
<p>​													<a href>典型微服务架构</a></p>
<p>上面是一个典型的微服务架构，当然微服务的服务治理还涉及很多内容，比如：</p>
<ul>
<li>通过熔断、限流等机制保证高可用；</li>
<li>微服务之间调用的负载均衡；</li>
<li>分布式事务（2PC、3PC、TCC、LCN等）；</li>
<li>服务调用链跟踪等等。</li>
</ul>
<h3 id="微服务框架">微服务框架</h3>
<p>目前国内企业使用的微服务框架主要是Spring Cloud和Dubbo（或者DubboX），但是Dubbo那两年的停更严重打击了开发人员对它的信心，Spring Cloud已经逐渐成为主流，比较两个框架的优劣势的文章在网上有很多，这里就不重复了，选择什么框架还是按业务需求来吧，业务框架决定技术框架。<br>
Spring Cloud全家桶提供了各种各样的组件，基本可以覆盖微服务的服务治理的方方面面，以下列出了Spring Cloud一些常用组件：</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/7584230-16df8f7fbee37f37.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p>​												<a href>Spring Cloud常用组件</a></p>
<h2 id="二，SpringCloud介绍">二，SpringCloud介绍</h2>
<p>​						<img src="/.cn//C:%5CUsers%5C25001%5CDownloads%5CSpringCloud%E6%9E%B6%E6%9E%84.png" alt="SpringCloud架构">															  	<a target="_blank" rel="noopener" href="https://www.processon.com/view/link/612a0d2e637689579630c761">总体架构</a></p>
<h3 id="什么是Spring-cloud">什么是Spring cloud</h3>
<blockquote>
<p>构建分布式系统不需要复杂和容易出错。Spring Cloud 为最常见的分布式系统模式提供了一种简单且易于接受的编程模型，帮助开发人员构建有弹性的、可靠的、协调的应用程序。Spring Cloud 构建于 Spring Boot 之上，使得开发者很容易入手并快速应用于生产中。</p>
</blockquote>
<p>官方果然官方，介绍都这么有板有眼的。</p>
<p>我所理解的 <code>Spring Cloud</code> 就是微服务系统架构的一站式解决方案，在平时我们构建微服务的过程中需要做如 <strong>服务发现注册</strong> 、<strong>配置中心</strong> 、<strong>消息总线</strong> 、<strong>负载均衡</strong> 、<strong>断路器</strong> 、<strong>数据监控</strong> 等操作，而 Spring Cloud 为我们提供了一套简易的编程模型，使我们能在 Spring Boot 的基础上轻松地实现微服务项目的构建。</p>
<h4 id="Spring-Cloud-的版本">Spring Cloud 的版本</h4>
<p>当然这个只是个题外话。</p>
<p>Spring Cloud 的版本号并不是我们通常见的数字版本号，而是一些很奇怪的单词。这些单词均为英国伦敦地铁站的站名。同时根据字母表的顺序来对应版本时间顺序，比如：最早 的 Release 版本 Angel，第二个 Release 版本 Brixton（英国地名），然后是 Camden、 Dalston、Edgware、Finchley、Greenwich、Hoxton。</p>
<h2 id="三，Eureka">三，Eureka</h2>
<h3 id="Spring-Cloud-的服务发现框架——Eureka">Spring Cloud 的服务发现框架——Eureka</h3>
<blockquote>
<p>Eureka是基于REST（代表性状态转移）的服务，主要在AWS云中用于定位服务，以实现负载均衡和中间层服务器的故障转移。我们称此服务为Eureka服务器。Eureka还带有一个基于Java的客户端组件Eureka Client，它使与服务的交互变得更加容易。客户端还具有一个内置的负载平衡器，可以执行基本的循环负载平衡。在Netflix，更复杂的负载均衡器将Eureka包装起来，以基于流量，资源使用，错误条件等多种因素提供加权负载均衡，以提供出色的弹性。</p>
</blockquote>
<p>总的来说，<code>Eureka</code> 就是一个服务发现框架。何为服务，何又为发现呢？</p>
<p>举一个生活中的例子，就比如我们平时租房子找中介的事情。</p>
<p>在没有中介的时候我们需要一个一个去寻找是否有房屋要出租的房东，这显然会非常的费力，一你找凭一个人的能力是找不到很多房源供你选择，再者你也懒得这么找下去(找了这么久，没有合适的只能将就)。<strong>这里的我们就相当于微服务中的</strong> <strong><code>Consumer</code></strong> <strong>，而那些房东就相当于微服务中的</strong> **<code>Provider</code> **。<strong>消费者 <code>Consumer</code></strong> <strong>需要调用提供者</strong> <strong><code>Provider</code></strong> <strong>提供的一些服务，就像我们现在需要租他们的房子一样。</strong></p>
<h4 id="角色">角色</h4>
<p><strong>服务提供者</strong>： 就是提供一些自己能够执行的一些服务给外界。</p>
<p><strong>服务消费者</strong>： 就是需要使用一些服务的“用户”。</p>
<p><strong>服务中介</strong>： 其实就是服务提供者和服务消费者之间的“桥梁”，服务提供者可以把自己注册到服务中介那里，而服务消费者如需要消费一些服务(使用一些功能)就可以在服务中介中寻找注册在服务中介的服务提供者。</p>
<p>可以充当服务发现的组件有很多：<code>Zookeeper</code> ，<code>Consul</code> ， <code>Eureka</code> 等。</p>
<h4 id="基础概念">基础概念</h4>
<ul>
<li>
<p><strong>服务注册 Register</strong>：当 <code>Eureka</code> 客户端向 <code>Eureka Server</code> 注册时，它提供自身的元数据，比如IP地址、端口，运行状况指示符URL，主页等。</p>
</li>
<li>
<p><strong>服务续约 Renew</strong>：<code>Eureka</code> 客户会每隔30秒(默认情况下)发送一次心跳来续约。 通过续约来告知 <code>Eureka Server</code> 该 <code>Eureka</code> 客户仍然存在，没有出现问题。 正常情况下，如果 <code>Eureka Server</code> 在90秒没有收到 <code>Eureka</code> 客户的续约，它会将实例从其注册表中删除。</p>
</li>
<li>
<p><strong>获取注册列表信息 Fetch Registries</strong>： <code>Eureka</code> 客户端从服务器获取注册表信息，并将其缓存在本地。客户端会使用该信息查找其他服务，从而进行远程调用。该注册列表信息定期（每30秒钟）更新一次。每次返回注册列表信息可能与 <code>Eureka</code> 客户端的缓存信息不同, <code>Eureka</code> 客户端自动处理。如果由于某种原因导致注册列表信息不能及时匹配，<code>Eureka</code> 客户端则会重新获取整个注册表信息。 <code>Eureka</code> 服务器缓存注册列表信息，整个注册表以及每个应用程序的信息进行了压缩，压缩内容和没有压缩的内容完全相同。<code>Eureka</code> 客户端和 <code>Eureka</code> 服务器可以使用JSON / XML格式进行通讯。在默认的情况下 <code>Eureka</code> 客户端使用压缩 <code>JSON</code> 格式来获取注册列表的信息。</p>
</li>
<li>
<p><strong>服务下线 Cancel</strong>：Eureka客户端在程序关闭时向Eureka服务器发送取消请求。 发送请求后，该客户端实例信息将从服务器的实例注册表中删除。该下线请求不会自动完成，它需要调用以下内容：<code>DiscoveryManager.getInstance().shutdownComponent();</code></p>
</li>
<li>
<p><strong>服务剔除 Eviction</strong>： 在默认的情况下，当Eureka客户端连续90秒(3个续约周期)没有向Eureka服务器发送服务续约，即心跳，Eureka服务器会将该服务实例从服务注册列表删除，即服务剔除。</p>
</li>
</ul>
<h4 id="Eureka架构">Eureka架构</h4>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/20/16e86737ea057126~tplv-t2oaga2asx-watermark.awebp" alt="Eureka架构图"></p>
<p>蓝色的 <code>Eureka Server</code> 是 <code>Eureka</code> 服务器，这三个代表的是集群，而且他们是去中心化的。</p>
<p>绿色的 <code>Application Client</code> 是 <code>Eureka</code> 客户端，其中可以是<strong>消费者</strong>和<strong>提供者</strong>，最左边的就是典型的提供者，它需要向 <code>Eureka</code> 服务器注册自己和发送心跳包进行续约，而其他消费者则通过 <code>Eureka</code> 服务器来获取提供者的信息以调用他们</p>
<h4 id="Eureka-与-Zookeeper-对比">Eureka 与 Zookeeper 对比</h4>
<ul>
<li>Eureka： <strong>符合AP原则</strong>  为了保证了可用性，<code>Eureka</code> 不会等待集群所有节点都已同步信息完成，它会无时无刻提供服务。</li>
<li>Zookeeper： <strong>符合CP原则</strong> 为了保证一致性，在所有节点同步完成之前是阻塞状态的。</li>
</ul>
<h3 id="创建EurekaServer">创建EurekaServer</h3>
<p>首先创建一个Maven工程，我们之后所有的SpringCloud组件都将在这个Maven中创建和完善</p>
<p>在Maven工程中新建一个SpringBoot项目，其中我们勾选<code>Spring Cloud DisCovery</code>中的<code>Eureka</code>依赖</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20210828215534455.png" alt="image-20210828215534455"></p>
<p>我们在SpringBoot启动类上加上注解<code>@EnableEurekaServer</code>，表示启动Eureka服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;SpringApplication.run(EurekaApplication.class, args);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后在配置文件中配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#单机版</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#端口</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">1111</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#应用名称  如果不配置 instance-id 那么此项为客户端在注册中心的名称默认值</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka-server</span></span><br><span class="line"></span><br><span class="line"><span class="meta">eureka.instance.hostname</span>=<span class="string">eureka</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#由于是单机版，eureka现在两重身份——注册中心，微服务应用  所有我们需要不让当前的服务在注册中心注册</span></span><br><span class="line"><span class="comment">#register-with-eureka=false  为取消在注册中心注册</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#由于是注册中心所以不需要从注册中心拉取注册服务信息</span></span><br><span class="line"><span class="comment">#eureka.client.fetch-registry=false 取消获取注册列表信息</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#单机版时需要修改defalutZone默认属性http://localhost:8761</span></span><br><span class="line"><span class="comment">#修改为当前地址端口后，才不会反复注册到localhost:8761</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:1111/eureka</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#猜测主机名时，应该优先使用服务器的IP地址而不是操作系统报告的主机名。</span></span><br><span class="line"><span class="meta">eureka.instance.prefer-ip-address</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#开启自我保护</span></span><br><span class="line"><span class="meta">eureka.server.enable-self-preservation</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#自我保护的续约百分比   即15分钟内续约的服务低于百分之85则开启自我保护，暂停剔除服务，并不将数据同步到其他注册中心上</span></span><br><span class="line"><span class="meta">eureka.server.renewal-percent-threshold</span>=<span class="string">0.85</span></span><br></pre></td></tr></table></figure>
<p>完成配置后我们只需启动服务即可，访问端口1111，就会看到eureka的首页</p>
<p>首页信息如下</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20210828225616988.png" alt="image-20210828225616988"></p>
<h3 id="Eureka集群">Eureka集群</h3>
<p>使用了注册中心之后，所有的服务都要通过服务注册中心来进行信息交换。服务注册中心的稳定性就非常重要了，一旦服务注册中心掉线，会影响到整个系统的稳定性。所以，在实际开发中，Eureka 一般都是以集群的形式出现的。</p>
<p>Eureka 集群，实际上就是启动多个 Eureka 实例，多个 Eureka 实例之间，互相注册，互相同步数据，共同组成一个 Eureka 集群。</p>
<p>前面单机的时候 eureka注册中心实例名称 是localhost，现在是集群，不能三个实例都是localhost，这里复杂的办法是搞三个虚拟机，麻烦，这里有简单办法，直接配置本机hosts，来实现本机域名映射；</p>
<p>找到 <strong>C:\Windows\System32\drivers\etc</strong> 打开hosts，加配置</p>
<p><img src="/.cn//C:%5CUsers%5C25001%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210828233330338.png" alt="image-20210828233330338"></p>
<p>我们修改一下配置文件</p>
<p>application-a.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#集群版</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#端口</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">1111</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#spring服务名称</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka-a</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#当前实例的主机名称</span></span><br><span class="line"><span class="meta">eureka.instance.hostname</span>=<span class="string">eurekaA</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#eureka实例名称</span></span><br><span class="line"><span class="meta">eureka.instance.instance-id</span>=<span class="string">eurekaA</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#集群模式   将注册中心A注册到注册到注册中心B上去</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#集群模式   拉取注册中心B的注册列表信息  确保注册中心的数据一致</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#注册中心的URL  端口1112为注册中心B</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://eurekaB:1112/eureka</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#猜测主机名时，应该优先使用服务器的IP地址而不是操作系统报告的主机名。</span></span><br><span class="line"><span class="meta">eureka.instance.prefer-ip-address</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#开启自我保护</span></span><br><span class="line"><span class="meta">eureka.server.enable-self-preservation</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#自我保护的续约百分比   即15分钟内续约的服务低于百分之85则开启自我保护，暂停剔除服务，并不将数据同步到其他注册中心上</span></span><br><span class="line"><span class="meta">eureka.server.renewal-percent-threshold</span>=<span class="string">0.85</span></span><br></pre></td></tr></table></figure>
<p>application-b.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#集群版</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#端口</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">1112</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#spring服务名称  如果不配置 instance-id 那么此项为客户端在注册中心的名称默认值</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">eureka-b</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#当前实例的主机名称</span></span><br><span class="line"><span class="meta">eureka.instance.hostname</span>=<span class="string">eurekaB</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#eureka实例名称</span></span><br><span class="line"><span class="meta">eureka.instance.instance-id</span>=<span class="string">eurekaB</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#集群模式   将注册中心B注册到注册到注册中心A上去</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#集群模式   拉取注册中心A的注册列表信息 确保注册中心的数据一致</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#注册中心的URL  端口1111为注册中心A</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://eurekaA:1111/eureka</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#猜测主机名时，应该优先使用服务器的IP地址而不是操作系统报告的主机名。</span></span><br><span class="line"><span class="meta">eureka.instance.prefer-ip-address</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#开启自我保护</span></span><br><span class="line"><span class="meta">eureka.server.enable-self-preservation</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#自我保护的续约百分比   即15分钟内续约的服务低于百分之85则开启自我保护，暂停剔除服务，并不将数据同步到其他注册中心上</span></span><br><span class="line"><span class="meta">eureka.server.renewal-percent-threshold</span>=<span class="string">0.85</span></span><br></pre></td></tr></table></figure>
<p>我们将服务打成jar包分别启动注册中心A和注册中心B</p>
<p>然后我们分别访问1111和1112即可</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20210828233602228.png" alt="image-20210828233602228"></p>
<h3 id="创建EurekaClient">创建EurekaClient</h3>
<h4 id="Provider">Provider</h4>
<p>Proivder供应者</p>
<p>创建SpringBoot项目时，勾选<code>Web</code>依赖和一个<code>Eureka Discovery Client</code>依赖</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829162245744.png" alt="image-20210829162245744"></p>
<ol>
<li>
<p>在启动类上加上<code>@EnableEurekaClient</code><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829185008406.png" alt="image-20210829185008406"></p>
</li>
<li>
<p>书写配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#消费者服务</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#端口</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#服务名称</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">provider-application</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#实例名称</span></span><br><span class="line"><span class="meta">eureka.instance.instance-id</span>=<span class="string">provider</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#注册到eureka</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#从eureka拉取服务列表信息</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#注册中心</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:1111/eureka</span></span><br><span class="line"></span><br><span class="line"><span class="meta">eureka.instance.prefer-ip-address</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>书写一个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    Integer port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/provider/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello,Consumer&quot;</span>+name+<span class="string">&quot;,来自Provider:&quot;</span>+port+<span class="string">&quot;的问候&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Consumer">Consumer</h4>
<p>Consumer消费者</p>
<p>创建SpringBoot项目时，勾选<code>Web</code>依赖和一个<code>Eureka Discovery Client</code>依赖</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829165523568.png" alt="image-20210829165523568"></p>
<ol>
<li>
<p>在启动类上加上<code>@EnableEurekaClient</code><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829185235783.png" alt="image-20210829185235783"></p>
</li>
<li>
<p>书写配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#消费者服务</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#端口</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#服务名称</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">consumer-application</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#实例名称</span></span><br><span class="line"><span class="meta">eureka.instance.instance-id</span>=<span class="string">consumer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#注册到eureka</span></span><br><span class="line"><span class="meta">eureka.client.register-with-eureka</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#从eureka拉取服务列表信息</span></span><br><span class="line"><span class="meta">eureka.client.fetch-registry</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#注册中心</span></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:1111/eureka</span></span><br><span class="line"></span><br><span class="line"><span class="meta">eureka.instance.prefer-ip-address</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>接口一</p>
<blockquote>
<p>​	使用固定ip形式，充分体现了，注册中心的重要性</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: demo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: xpp011</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2021-08-29 17:09</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不使用eureka提供的服务列表信息,主要先凸显一下注册中心的好处</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello1/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello1</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        HttpURLConnection con=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//注意这里的url是写死的，也就意味着一旦提供服务的服务ip或者端口发生变化，就会波及到当前服务</span></span><br><span class="line">            <span class="comment">//需要修改这里的ip或者端口</span></span><br><span class="line">            URL url=<span class="keyword">new</span> URL(<span class="string">&quot;http://localhost:8080/provider/&quot;</span>+name);</span><br><span class="line">            con = (HttpURLConnection) url.openConnection();</span><br><span class="line">            <span class="keyword">if</span> (con.getResponseCode()==<span class="number">200</span>) &#123;</span><br><span class="line">                BufferedReader stream=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(con.getInputStream()));</span><br><span class="line">                <span class="keyword">return</span> stream.readLine();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>接口二</p>
<blockquote>
<p>实现了从注册中心拉取服务信息列表</p>
<p>动态的修改供应者服务ip以及端口号</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: demo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: xpp011</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2021-08-29 17:09</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用eureka提供的discoveryClient来获取服务列表信息</span></span><br><span class="line"><span class="comment">     * 从而动态的获取服务的ip和端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello2/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello2</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        <span class="comment">//根据服务名称获取服务的实例列表</span></span><br><span class="line">        <span class="comment">//由于同一个服务模块有个服务，也即是集群部署  所以返回值为list</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;PROVIDER-APPLICATION&quot;</span>);</span><br><span class="line">        ServiceInstance serviceInstance = instances.get(<span class="number">0</span>);</span><br><span class="line">        URI uri = serviceInstance.getUri();</span><br><span class="line"></span><br><span class="line">        HttpURLConnection con=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url=<span class="keyword">new</span> URL(uri+<span class="string">&quot;/provider/&quot;</span>+name);</span><br><span class="line">            con = (HttpURLConnection) url.openConnection();</span><br><span class="line">            <span class="keyword">if</span> (con.getResponseCode()==<span class="number">200</span>) &#123;</span><br><span class="line">                BufferedReader stream=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(con.getInputStream()));</span><br><span class="line">                <span class="keyword">return</span> stream.readLine();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>接口三</p>
<ol>
<li>
<p>将Provider的jar包启动两个，注意修改第二个Provider的实例名称，不然两个重名在eureka上不显示</p>
<blockquote>
<p>$  java -jar Provider-0.0.1-SNAPSHOT.jar --server.por<br>
t=8082 --eureka.instance.instance-id=provider2</p>
</blockquote>
<blockquote>
<p>简单实现负载均衡</p>
</blockquote>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: demo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: xpp011</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2021-08-29 17:09</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 简单实现线性负载均衡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello3/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello3</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        <span class="comment">//获取服务的实例列表</span></span><br><span class="line">        <span class="comment">//由于同一个服务模块有个服务，也即是集群部署  所以返回值为list</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;PROVIDER-APPLICATION&quot;</span>);</span><br><span class="line">        ServiceInstance serviceInstance = instances.get(count++%instances.size());</span><br><span class="line">        URI uri = serviceInstance.getUri();</span><br><span class="line"></span><br><span class="line">        HttpURLConnection con=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url=<span class="keyword">new</span> URL(uri+<span class="string">&quot;/provider/&quot;</span>+name);</span><br><span class="line">            con = (HttpURLConnection) url.openConnection();</span><br><span class="line">            <span class="keyword">if</span> (con.getResponseCode()==<span class="number">200</span>) &#123;</span><br><span class="line">                BufferedReader stream=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(con.getInputStream()));</span><br><span class="line">                <span class="keyword">return</span> stream.readLine();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>接口四</p>
<blockquote>
<p>通过一个支持<code>Ribbon</code>功能的<code>RestTemplate</code>调用请求</p>
</blockquote>
<p><strong>Ribbon简介</strong></p>
<p>Spring Cloud Ribbon是一个基于HTTP和TCP的客户端负载均衡工具，它基于Netflix Ribbon实现。通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。Spring Cloud Ribbon虽然只是一个工具类框架，它不像服务注册中心、配置中心、API网关那样需要独立部署，但是它几乎存在于每一个Spring Cloud构建的微服务和基础设施中。因为微服务间的调用，API网关的请求转发等内容，实际上都是通过Ribbon来实现的，包括后续我们将要介绍的Feign，它也是基于Ribbon实现的工具。所以，对Spring Cloud Ribbon的理解和使用，对于我们使用Spring Cloud来构建微服务非常重要。</p>
<p>我们可以通过注解<code>@LoadBalanced</code>获取一个具有Ribbon功能的RestTemplate</p>
<blockquote>
<p>RestTemplate使用手册</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1bd66db5dc46">https://www.jianshu.com/p/1bd66db5dc46</a></p>
</blockquote>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​		然后我们就可以极其方便的调用其他服务请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/hello4/&#123;name&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello4</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://PROVIDER-APPLICATION/provider/hello/&quot;</span>+name,String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>最后我们看一下eureka所展示的页面</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210829190509879.png" alt="image-20210829190509879"></p>
<h4 id="客户端负载均衡Ribbon">客户端负载均衡Ribbon</h4>
<ul>
<li>
<h5 id="什么是-RestTemplate">什么是 RestTemplate?</h5>
</li>
</ul>
<p>不是讲 <code>Ribbon</code> 么？怎么扯到了 <code>RestTemplate</code> 了？你先别急，听我慢慢道来。</p>
<p>我不听我不听我不听 。</p>
<p>我就说一句！<strong><code>RestTemplate</code>是<code>Spring</code>提供的一个访问Http服务的客户端类</strong>，怎么说呢？就是微服务之间的调用是使用的 <code>RestTemplate</code> 。比如这个时候我们 消费者B 需要调用 提供者A 所提供的服务我们就需要这么写。如我下面的伪代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"><span class="comment">// 这里是提供者A的ip地址，但是如果使用了 Eureka 那么就应该是提供者A的名称</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_PROVIDER_A = <span class="string">&quot;http://localhost:8081&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@PostMapping(&quot;/judge&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">judge</span><span class="params">(<span class="meta">@RequestBody</span> Request request)</span> </span>&#123;</span><br><span class="line">    String url = SERVICE_PROVIDER_A + <span class="string">&quot;/service1&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.postForObject(url, request, Boolean.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你对源码感兴趣的话，你会发现上面我们所讲的 <code>Eureka</code> 框架中的 <strong>注册</strong>、<strong>续约</strong> 等，底层都是使用的 <code>RestTemplate</code> 。</p>
<ul>
<li>
<h5 id="为什么需要-Ribbon？">为什么需要 Ribbon？</h5>
</li>
</ul>
<p><code>Ribbon</code> 是 <code>Netflix</code> 公司的一个开源的负载均衡 项目，是一个客户端/进程内负载均衡器，<strong>运行在消费者端</strong>。</p>
<p>我们再举个 ，比如我们设计了一个秒杀系统，但是为了整个系统的 <strong>高可用</strong> ，我们需要将这个系统做一个集群，而这个时候我们消费者就可以拥有多个秒杀系统的调用途径了，如下图。</p>
<p><img src="https://pic2.zhimg.com/80/v2-658f17773d4ec949a32affb2a7476779_720w.jpg" alt="img"></p>
<p>如果这个时候我们没有进行一些 <strong>均衡操作</strong> ，如果我们对 <code>秒杀系统1</code> 进行大量的调用，而另外两个基本不请求，就会导致 <code>秒杀系统1</code> 崩溃，而另外两个就变成了傀儡，那么我们为什么还要做集群，我们高可用体现的意义又在哪呢？</p>
<p>所以 <code>Ribbon</code> 出现了，注意我们上面加粗的几个字——<strong>运行在消费者端</strong>。指的是，<code>Ribbon</code> 是运行在消费者端的负载均衡器，如下图。</p>
<p><img src="https://pic3.zhimg.com/80/v2-0104febb658f8eeaa626654f5be980d2_720w.jpg" alt="img"></p>
<p>其工作原理就是 <code>Consumer</code> 端获取到了所有的服务列表之后，在其<strong>内部</strong>使用<strong>负载均衡算法</strong>，进行对多个系统的调用。</p>
<ul>
<li>
<h5 id="Nginx-和-Ribbon-的对比">Nginx 和 Ribbon 的对比</h5>
</li>
</ul>
<p>提到 <strong>负载均衡</strong> 就不得不提到大名鼎鼎的 <code>Nignx</code> 了，而和 <code>Ribbon</code> 不同的是，它是一种<strong>集中式</strong>的负载均衡器。</p>
<p>何为集中式呢？简单理解就是 <strong>将所有请求都集中起来，然后再进行负载均衡</strong>。如下图。</p>
<p><img src="https://pic1.zhimg.com/80/v2-4fb6c809e868f2a897f87580f2786d4c_720w.jpg" alt="img"></p>
<p>我们可以看到 <code>Nginx</code> 是接收了所有的请求进行负载均衡的，而对于 <code>Ribbon</code> 来说它是在消费者端进行的负载均衡。如下图。</p>
<p><img src="https://pic3.zhimg.com/80/v2-8f08b87f73a9707c9b25a7d711e4b74e_720w.jpg" alt="img"></p>
<blockquote>
<p>请注意 <code>Request</code> 的位置，在 <code>Nginx</code> 中请求是先进入负载均衡器，而在 <code>Ribbon</code> 中是先在客户端进行负载均衡才进行请求的。</p>
</blockquote>
<ul>
<li>
<h5 id="Ribbon-的几种负载均衡算法">Ribbon 的几种负载均衡算法</h5>
</li>
</ul>
<p>负载均衡，不管 <code>Nginx</code> 还是 <code>Ribbon</code> 都需要其算法的支持，如果我没记错的话 <code>Nginx</code> 使用的是 轮询和加权轮询算法。而在 <code>Ribbon</code> 中有更多的负载均衡调度算法，其默认是使用的 <code>RoundRobinRule</code> 轮询策略。</p>
<ul>
<li><strong>RoundRobinRule</strong>：轮询策略。<code>Ribbon</code> 默认采用的策略。若经过一轮轮询没有找到可用的 <code>provider</code>，其最多轮询 10 轮。若最终还没有找到，则返回 null。</li>
<li><strong>RandomRule</strong>: 随机策略，从所有可用的 provider 中随机选择一个。</li>
<li><strong>RetryRule</strong>: 重试策略。先按照 RoundRobinRule 策略获取 provider，若获取失败，则在指定的时限内重试。默认的时限为 500 毫秒。</li>
</ul>
<p>还有很多，这里不一一举 了，你最需要知道的是默认轮询算法，并且可以更换默认的负载均衡算法，只需要在配置文件中做出修改就行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">providerName:</span><br><span class="line">  ribbon:</span><br><span class="line">    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule</span><br></pre></td></tr></table></figure>
<p>当然，在 <code>Ribbon</code> 中你还可以<strong>自定义负载均衡算法</strong>，你只需要实现 <code>IRule</code> 接口，然后修改配置文件或者自定义 <code>Java Config</code> 类。</p>
<ul>
<li>
<p><strong>Ribbon原理概述(背下来)</strong></p>
<p><font color="red">通过源码分析，个人认为可以拆解为如下部分：</font></p>
</li>
</ul>
<ol>
<li><strong>获取<code>@LoadBalanced</code>注解标记的<code>RestTemplate</code>。</strong></li>
<li><strong><code>RestTemplate</code>添加一个拦截器(filter)，当使用<code>RestTemplate</code>发起http调用时进行拦截。</strong></li>
<li><strong>在filter拦截到该请求时，获取该次请求服务集群的全部列表信息。</strong></li>
<li><strong>根据规则从集群中选取一个服务作为此次请求访问的目标。</strong></li>
<li><strong>将<code>originalURI</code>的服务名称通过<code>reconstructURI()</code>方法解析为可访问的<code>IP</code>和端口</strong></li>
<li><strong>访问该目标，并获取返回结果。</strong></li>
</ol>
<p><font color="red">Ribbon现在以及是SpringCloud自带的负载均衡服务了</font></p>
<h2 id="a-name-ribbon-四，Ribbon源码解析-a"><strong><a name="ribbon">四，Ribbon源码解析</a></strong></h2>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/31744266">Ribbon源码解析参考链接</a> (版本有些老了，和新版代码有些冲突)</p>
<h3 id="简介"><strong>简介</strong></h3>
<p>Spring cloud ribbon在spring cloud微服务体系中充当着负载均衡的角色。这个负载均衡指的是客户端的负载均衡。本文是ribbon源码分析系列的第一篇，主要内容如下：</p>
<ul>
<li>怎样使用spring cloud ribbon</li>
<li>ribbon原理概览</li>
</ul>
<h3 id="怎样使用Spring-cloud-ribbon"><strong>怎样使用Spring cloud ribbon</strong></h3>
<p>我们知道ribbon是客户端负载均衡，也就是说在相同的服务集群中选择一个，然后进行访问，并从该服务获取到结果。这里面会引申出一个问题，就是相同服务集群的来源。ribbon有两种方式获取，第一种是通过<code>Eureka</code>(注册中心)，这种方式需要使用ribbon的工程是一个Eureka Client也就是说需要在工程的主函数上使用(<code>@EnableDiscoveryClient</code>),第二种方式是通过<code>properties</code>进行配置。<br>
本文主要介绍的是第二种。<br>
下面结合一个例子来说明：</p>
<h3 id="添加对应依赖"><strong>添加对应依赖</strong></h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-ribbon&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h3 id="定义配置类"><strong>定义配置类</strong></h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上图所示在该配置类中创建<code>RestTemplate</code>，并且使用<code>@LoadBalanced</code>注解。该注解使得<code>RestTemplate</code>具有了客户端负载均衡的能力。</p>
<h3 id="properties文件"><strong>properties文件</strong></h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=ribbon-client</span><br><span class="line">users.ribbon.listOfServers=http:<span class="comment">//localhost:8081,http://localhost:8082</span></span><br><span class="line">users.ribbon.listOfServers`这个参数很关键，它的含义是指定服务(集群)的地址，其中`users`是自定义的Key。本文中有两个相同的服务，它们的地址分别为`http:<span class="comment">//localhost:8081`以及`http://localhost:8082</span></span><br></pre></td></tr></table></figure>
<h3 id="定义一个Controller-Ribbon-Client端"><strong>定义一个Controller(Ribbon-Client端)</strong></h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL = <span class="string">&quot;http://users/hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/ribbon&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">ribbon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForObject(DemoController.URL, String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="后端Server代码-8081、8082"><strong>后端Server代码(8081、8082)</strong></h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;demo&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;this is 8081 server...&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;demo&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;this is 8082 server...&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时当我们访问[<a target="_blank" rel="noopener" href="http://localhost:8080/ribbon%E5%B9%B6%E4%B8%94%E4%B8%8D%E6%96%AD%E5%88%B7%E6%96%B0%E6%B5%8F%E8%A7%88%E5%99%A8(%E5%A4%9A%E6%AC%A1%E8%AE%BF%E9%97%AE%E8%AF%A5%E6%8E%A5%E5%8F%A3)%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0">http://localhost:8080/ribbon并且不断刷新浏览器(多次访问该接口)，我们可以看到</a><code>http://localhost:8081/hello</code>、<code>http://localhost:8082/hello</code>这两个接口反复被调用。(交替返回)<br>
至此通过这个例子我们完成了使用ribbon来完成客户端负载均衡的功能，接下来通过源码了解下其中的原理。</p>
<h3 id="Ribbon原理概览"><strong>Ribbon原理概览</strong></h3>
<p><font color="red">通过源码分析，个人认为可以拆解为如下部分：</font></p>
<ol>
<li><strong>获取<code>@LoadBalanced</code>注解标记的<code>RestTemplate</code>。</strong></li>
<li><strong><code>RestTemplate</code>添加一个拦截器(filter)，当使用<code>RestTemplate</code>发起http调用时进行拦截。</strong></li>
<li><strong>在filter拦截到该请求时，获取该次请求服务集群的全部列表信息。</strong></li>
<li><strong>根据规则从集群中选取一个服务作为此次请求访问的目标。</strong></li>
<li><strong>将<code>originalURI</code>的服务名称通过<code>reconstructURI()</code>方法解析为可访问的<code>IP</code>和端口</strong></li>
<li><strong>访问该目标，并获取返回结果。</strong></li>
</ol>
<h3 id="获取-LoadBalanced注解标记的RestTemplate。"><strong>获取<a href="https://link.zhihu.com/?target=https%3A//github.com/LoadBalanced">@LoadBalanced</a>注解标记的RestTemplate。</strong></h3>
<p>Ribbon将所有标记<code>@LoadBalanced</code>注解的<code>RestTemplate</code>保存到一个List集合当中，具体源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="meta">@Autowired(required = false)</span></span><br><span class="line"><span class="keyword">private</span> List&lt;RestTemplate&gt; restTemplates = Collections.emptyList();</span><br></pre></td></tr></table></figure>
<p>具体源码位置是在<code>LoadBalancerAutoConfiguration</code>中。</p>
<h3 id="RestTemplate添加一个拦截器-filter"><strong>RestTemplate添加一个拦截器(filter)</strong></h3>
<p>RestTemplate添加拦截器需要有两个步骤，首先是定义一个拦截器，其次是将定义的拦截器添加到RestTemplate中。</p>
<h3 id="定义一个拦截器"><strong>定义一个拦截器</strong></h3>
<p>实现<code>ClientHttpRequestInterceptor</code>接口就具备了拦截请求的功能，该接口源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *实现该方法，在该方法内完成拦截请求后的逻辑内容。</span></span><br><span class="line"><span class="comment">     *对于ribbon而言，在该方法内完成了根据具体规则从</span></span><br><span class="line"><span class="comment">     *服务集群中选取一个服务，并向该服务发起请求的操作。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="function">ClientHttpResponse <span class="title">intercept</span><span class="params">(HttpRequest request, <span class="keyword">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ribbon中对应的实现类是<code>LoadBalancerInterceptor</code>(不使用<code>spring-retry</code>的情况下)具体源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBalancerInterceptor</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> LoadBalancerClient loadBalancer;</span><br><span class="line">   <span class="keyword">private</span> LoadBalancerRequestFactory requestFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略构造器代码...</span></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(<span class="keyword">final</span> HttpRequest request, <span class="keyword">final</span> <span class="keyword">byte</span>[] body,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="keyword">final</span> ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> URI originalUri = request.getURI();</span><br><span class="line">      String serviceName = originalUri.getHost();</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       *拦截请求，并调用loadBalancer.execute()方法</span></span><br><span class="line"><span class="comment">       *在该方法内部完成server的选取。向选取的server</span></span><br><span class="line"><span class="comment">       *发起请求，并获得返回结果。</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.loadBalancer.execute(serviceName, requestFactory.createRequest(request, body, execution));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="将拦截器添加到RestTemplate中"><strong>将拦截器添加到RestTemplate中</strong></h3>
<p><code>RestTemplate</code>继承了<code>InterceptingHttpAccessor</code>，在<code>InterceptingHttpAccessor</code>中提供了获取以及添加拦截器的方法，具体源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptingHttpAccessor</span> <span class="keyword">extends</span> <span class="title">HttpAccessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有的拦截器是以一个List集合形式进行保存。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;ClientHttpRequestInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;ClientHttpRequestInterceptor&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 设置拦截器。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInterceptors</span><span class="params">(List&lt;ClientHttpRequestInterceptor&gt; interceptors)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.interceptors = interceptors;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取当前的拦截器。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;ClientHttpRequestInterceptor&gt; <span class="title">getInterceptors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> interceptors;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//省略部分代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这两个方法我们就可以将刚才定义的<code>LoadBalancerInterceptor</code>添加到有<code>@LoadBalanced</code>注解标识的<code>RestTemplate</code>中。具体的源码如下(LoadBalancerAutoConfiguration)省略部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBalancerAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 获取所有带有<span class="doctag">@LoadBalanced</span>注解的restTemplate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="meta">@LoadBalanced</span></span><br><span class="line">   <span class="meta">@Autowired(required = false)</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;RestTemplate&gt; restTemplates = Collections.emptyList();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建SmartInitializingSingleton接口的实现类。Spring会在所有</span></span><br><span class="line"><span class="comment">     * 单例Bean初始化完成后回调该实现类的afterSingletonsInstantiated()</span></span><br><span class="line"><span class="comment">     * 方法。在这个方法中会为所有被<span class="doctag">@LoadBalanced</span>注解标识的</span></span><br><span class="line"><span class="comment">     * RestTemplate添加ribbon的自定义拦截器LoadBalancerInterceptor。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> SmartInitializingSingleton <span class="title">loadBalancedRestTemplateInitializer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="keyword">final</span> List&lt;RestTemplateCustomizer&gt; customizers)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> SmartInitializingSingleton() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (RestTemplate restTemplate : LoadBalancerAutoConfiguration.<span class="keyword">this</span>.restTemplates) &#123;</span><br><span class="line">               <span class="keyword">for</span> (RestTemplateCustomizer customizer : customizers) &#123;</span><br><span class="line">                  customizer.customize(restTemplate);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建Ribbon自定义拦截器LoadBalancerInterceptor</span></span><br><span class="line"><span class="comment">     * 创建前提是当前classpath下不存在spring-retry。</span></span><br><span class="line"><span class="comment">     * 所以LoadBalancerInterceptor是默认的Ribbon拦截</span></span><br><span class="line"><span class="comment">     * 请求的拦截器。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingClass(&quot;org.springframework.retry.support.RetryTemplate&quot;)</span></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBalancerInterceptorConfig</span> </span>&#123;</span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> LoadBalancerInterceptor <span class="title">ribbonInterceptor</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            LoadBalancerClient loadBalancerClient,</span></span></span><br><span class="line"><span class="params"><span class="function">            LoadBalancerRequestFactory requestFactory)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> LoadBalancerInterceptor(loadBalancerClient, requestFactory);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 添加拦截器具体方法。首先获取当前拦截器集合(List)</span></span><br><span class="line"><span class="comment">       * 然后将loadBalancerInterceptor添加到当前集合中</span></span><br><span class="line"><span class="comment">       * 最后将新的集合放回到restTemplate中。</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> RestTemplateCustomizer <span class="title">restTemplateCustomizer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">final</span> LoadBalancerInterceptor loadBalancerInterceptor)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> RestTemplateCustomizer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(RestTemplate restTemplate)</span> </span>&#123;</span><br><span class="line">               List&lt;ClientHttpRequestInterceptor&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(</span><br><span class="line">                     restTemplate.getInterceptors());</span><br><span class="line">               list.add(loadBalancerInterceptor);</span><br><span class="line">               restTemplate.setInterceptors(list);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此知道了ribbon拦截请求的基本原理，接下来我们看看Ribbon是怎样选取server的。</p>
<h3 id="Ribbon选取server原理概览"><strong>Ribbon选取server原理概览</strong></h3>
<p>通过上面的介绍我们知道了当发起请求时ribbon会用<code>LoadBalancerInterceptor</code>这个拦截器进行拦截。并在接口<code>LoadBalancerClient</code>的实现类<code>BlockingLoadBalancerClient.execute()</code>该方法具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, LoadBalancerRequest&lt;T&gt; request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String hint = getHint(serviceId);</span><br><span class="line">    LoadBalancerRequestAdapter&lt;T, DefaultRequestContext&gt; lbRequest = <span class="keyword">new</span> LoadBalancerRequestAdapter&lt;&gt;(request,</span><br><span class="line">            <span class="keyword">new</span> DefaultRequestContext(request, hint));</span><br><span class="line">    Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors = getSupportedLifecycleProcessors(serviceId);</span><br><span class="line">    supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onStart(lbRequest));</span><br><span class="line">    <span class="comment">//根据规则选择一个服务实例</span></span><br><span class="line">    ServiceInstance serviceInstance = choose(serviceId, lbRequest);</span><br><span class="line">    <span class="keyword">if</span> (serviceInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onComplete(</span><br><span class="line">                <span class="keyword">new</span> CompletionContext&lt;&gt;(CompletionContext.Status.DISCARD, lbRequest, <span class="keyword">new</span> EmptyResponse())));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No instances available for &quot;</span> + serviceId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> execute(serviceId, serviceInstance, lbRequest);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest&lt;T&gt; request)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    DefaultResponse defaultResponse = <span class="keyword">new</span> DefaultResponse(serviceInstance);</span><br><span class="line">    Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors = getSupportedLifecycleProcessors(serviceId);</span><br><span class="line">    Request lbRequest = request <span class="keyword">instanceof</span> Request ? (Request) request : <span class="keyword">new</span> DefaultRequest&lt;&gt;();</span><br><span class="line">    supportedLifecycleProcessors</span><br><span class="line">            .forEach(lifecycle -&gt; lifecycle.onStartRequest(lbRequest, <span class="keyword">new</span> DefaultResponse(serviceInstance)));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//将URi的服务名称替换为服务实例可访问的ip和端口</span></span><br><span class="line">        T response = request.apply(serviceInstance);</span><br><span class="line">        Object clientResponse = getClientResponse(response);</span><br><span class="line">        supportedLifecycleProcessors</span><br><span class="line">                .forEach(lifecycle -&gt; lifecycle.onComplete(<span class="keyword">new</span> CompletionContext&lt;&gt;(CompletionContext.Status.SUCCESS,</span><br><span class="line">                        lbRequest, defaultResponse, clientResponse)));</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException iOException) &#123;</span><br><span class="line">        supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onComplete(</span><br><span class="line">                <span class="keyword">new</span> CompletionContext&lt;&gt;(CompletionContext.Status.FAILED, iOException, lbRequest, defaultResponse)));</span><br><span class="line">        <span class="keyword">throw</span> iOException;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">        supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onComplete(</span><br><span class="line">                <span class="keyword">new</span> CompletionContext&lt;&gt;(CompletionContext.Status.FAILED, exception, lbRequest, defaultResponse)));</span><br><span class="line">        ReflectionUtils.rethrowRuntimeException(exception);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过代码我们可知，首先创建一个<code>ILoadBalancer</code>，这个<code>ILoadBalancer</code>是Ribbon的核心类。可以理解成它包含了选取服务的规则(<code>IRule</code>)、服务集群的列表(<code>ServerList</code>)、检验服务是否存活(<code>IPing</code>)等特性，同时它也具有了根据这些特性从服务集群中选取具体一个服务的能力。</p>
<p><code>Server server = getServer(loadBalancer);</code>这行代码就是选取举一个具体server。</p>
<p>最终调用了内部的<code>execute</code>方法，该方法代码如下(只保留了核心代码)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest&lt;T&gt; request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//发起调用</span></span><br><span class="line">      T returnVal = request.apply(serviceInstance);</span><br><span class="line">      statsRecorder.recordStats(returnVal);</span><br><span class="line">      <span class="keyword">return</span> returnVal;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      statsRecorder.recordStats(ex);</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      statsRecorder.recordStats(ex);</span><br><span class="line">      ReflectionUtils.rethrowRuntimeException(ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看下<code>request.apply(serviceInstance)</code>方法的具体做了那些事情(LoadBalancerRequestFactory中)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">apply</span><span class="params">(<span class="keyword">final</span> ServiceInstance instance)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   HttpRequest serviceRequest = <span class="keyword">new</span> ServiceRequestWrapper(request, instance, loadBalancer);</span><br><span class="line">   <span class="comment">//省略部分代码...</span></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 发起真正请求。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">return</span> execution.execute(serviceRequest, body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这里整体流程的原理就说完了，接下来我们结合一张图来回顾下整个过程：</p>
<p><img src="https://pic3.zhimg.com/80/v2-05b0cfff0ccb3fc5093b4581d3d7399a_720w.jpg" alt="img"></p>
<p>首先获取所有标识<code>@LoadBalanced</code>注解的<code>RestTemplate</code>(可以理解成获取那些开启了Ribbon负载均衡功能的<code>RestTemplate</code>)，然后将Ribbon默认的拦截器<code>LoadBalancerInterceptor</code>添加到<code>RestTemplate</code>中，这样当使用<code>RestTemplate</code>发起http请求时就会起到拦截的作用。当有请求发起时，ribbon默认的拦截器首先会创建<code>ILoadBalancer</code>(里面包含了选取服务的规则(<code>IRule</code>)、服务集群的列表(<code>ServerList</code>)、检验服务是否存活(<code>IPing</code>)等特性)。在代码层面的含义是加载<code>RibbonClientConfiguration</code>配置类)。然后使用<code>ILoadBalancer</code>从服务集群中选择一个服务，最后向这个服务发送请求。</p>
<h2 id="五，Consul">五，Consul</h2>
<h3 id="简介-2">简介</h3>
<p>Consul 是 HashiCorp 公司推出的开源产品，用于实现分布式系统的服务发现、服务隔离、服务配置，这些功能中的每一个都可以根据需要单独使用，也可以同时使用所有功能。Consul 官网目前主要推 Consul 在服务网格中的使用。</p>
<p>与其它分布式服务注册与发现的方案相比，Consul 的方案更“一站式”——内置了<strong>服务注册与发现框架</strong>、<strong>分布一致性协议实现</strong>、<strong>健康检查</strong>、<strong>Key/Value 存储</strong>、多数据中心方案，不再需要依赖其它工具。Consul 本身使用 go 语言开发，具有跨平台、运行高效等特点，也非常方便和 Docker 配合使用。</p>
<p>Consul 的主要特点有：</p>
<ul>
<li>
<p><strong>Service Discovery :</strong></p>
<blockquote>
<p>服务注册与发现，Consul 的客户端可以做为一个服务注册到 Consul，也可以通过 Consul 来查找特定的服务提供者，并且根据提供的信息进行调用。</p>
</blockquote>
</li>
<li>
<p><strong>Health Checking</strong>:</p>
<blockquote>
<p>Consul 客户端会定期发送一些健康检查数据和服务端进行通讯，判断客户端的状态、内存使用情况是否正常，用来监控整个集群的状态，防止服务转发到故障的服务上面。</p>
</blockquote>
</li>
<li>
<p><strong>KV Store</strong>:</p>
<blockquote>
<p>Consul 还提供了一个容易使用的键值存储。这可以用来保持动态配置，协助服务协调、建立 Leader 选举，以及开发者想构造的其它一些事务。</p>
</blockquote>
</li>
<li>
<p><strong>Secure Service Communication</strong>:</p>
<blockquote>
<p>Consul 可以为服务生成分布式的 TLS 证书，以建立相互的 TLS 连接。 可以使用 intentions 定义允许哪些服务进行通信。 可以使用 intentions 轻松管理服务隔离，而不是使用复杂的网络拓扑和静态防火墙规则。</p>
</blockquote>
</li>
<li>
<p><strong>Multi Datacenter</strong>:</p>
<blockquote>
<p>Consul 支持开箱即用的多数据中心，这意味着用户不需要担心需要建立额外的抽象层让业务扩展到多个区域。</p>
</blockquote>
</li>
</ul>
<p><strong>Consul 角色:</strong></p>
<ul>
<li>
<p>Server: 服务端, 保存配置信息, 高可用集群, 在局域网内与本地客户端通讯, 通过广域网与其它数据中心通讯。 每个数据中心的 Server 数量推荐为 3 个或是 5 个。</p>
</li>
<li>
<p>Client: 客户端, 无状态, 将 HTTP 和 DNS 接口请求转发给局域网内的服务端集群。</p>
</li>
</ul>
<p>Consul 旨在对 DevOps 社区和应用程序开发人员友好，使其成为现代、弹性基础架构的理想选择。</p>
<h3 id="使用Consul-的优势">使用Consul 的优势</h3>
<p>使用 Raft 算法来保证一致性, 比复杂的 Paxos 算法更直接。相比较而言, zookeeper 采用的是 Paxos, 而 etcd 使用的则是 Raft。</p>
<p>支持多数据中心，内外网的服务采用不同的端口进行监听。多数据中心集群可以避免单数据中心的单点故障，而其部署则需要考虑网络延迟, 分片等情况等。 zookeeper 和 etcd 均不提供多数据中心功能的支持。</p>
<p>支持健康检查。 etcd 不提供此功能。</p>
<p>支持 http 和 dns 协议接口。 zookeeper 的集成较为复杂, etcd 只支持 http 协议。</p>
<p>官方提供 Web 管理界面, etcd 无此功能。</p>
<p>Consul 保持了 CAP 中的 CP，保持了强一致性和分区容错性。</p>
<p>Consul 支持 Http\gRPC\DNS 多种访问方式。</p>
<h3 id="Consul-的调用过程">Consul 的调用过程</h3>
<p>首先我们根据一张图来了解一下 Consul 服务调用过程：</p>
<p><img src="https://img-blog.csdnimg.cn/20190708203002230.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F3ZTg2MzE0,size_16,color_FFFFFF,t_70" alt></p>
<p>1、当 Producer 启动的时候，会向 Consul 发送一个 post 请求，告诉 Consul 自己的 IP 和 Port；</p>
<p>2、Consul 接收到 Producer 的注册后，每隔 10s（默认）会向 Producer 发送一个健康检查的请求，检验 Producer 是否健康；</p>
<p>3、当 Consumer 发送 GET 方式请求 /api/address 到 Producer 时，会先从 Consul 中拿到一个存储服务 IP 和 Port 的临时表，从表中拿到 Producer 的 IP 和 Port 后再发送 GET 方式请求 /api/address；</p>
<p>4、该临时表每隔 10s 会更新，只包含有通过了健康检查的 Producer。</p>
<p>Spring Cloud Consul 项目是针对 Consul 的服务治理实现。Consul 是一个分布式高可用的系统，它包含多个组件，但是作为一个整体，在微服务架构中，为我们的基础设施提供服务发现和服务配置的工具。</p>
<h3 id="Consul-和-eureka的对比">Consul 和 eureka的对比</h3>
<p>我们先来通过一个表格做简单对比</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Euerka</th>
<th>Consul</th>
</tr>
</thead>
<tbody>
<tr>
<td>服务健康检查</td>
<td>可配支持</td>
<td>服务状态，内存，硬盘等</td>
</tr>
<tr>
<td>多数据中心</td>
<td>—</td>
<td>支持</td>
</tr>
<tr>
<td>kv 存储服务</td>
<td>—</td>
<td>支持</td>
</tr>
<tr>
<td>一致性</td>
<td>—</td>
<td>raft</td>
</tr>
<tr>
<td>cap</td>
<td>ap</td>
<td>cp</td>
</tr>
<tr>
<td>使用接口(多语言能力)</td>
<td>http（sidecar）</td>
<td>支持 http 和 dns</td>
</tr>
<tr>
<td>watch 支持</td>
<td>支持 long polling/大部分增量</td>
<td>全量/支持long polling</td>
</tr>
<tr>
<td>自身监控</td>
<td>metrics</td>
<td>metrics</td>
</tr>
<tr>
<td>安全</td>
<td>—</td>
<td>acl /https</td>
</tr>
<tr>
<td>编程语言</td>
<td>Java</td>
<td>go</td>
</tr>
<tr>
<td>Spring Cloud 集成</td>
<td>已支持</td>
<td>已支持</td>
</tr>
</tbody>
</table>
<p>通过对比可以得知， Consul 功能更强大，Euerka 更容易使用。</p>
<p><strong>Consul 强一致性©带来的是：</strong></p>
<p>服务注册相比 Eureka 会稍慢一些。因为 Consul 的 raft 协议要求必须过半数的节点都写入成功才认为注册成功,。Leader 挂掉时，重新选举期间整个 Consul 不可用。保证了强一致性但牺牲了可用性。</p>
<p>Consul 强烈的一致性意味着它可以作为领导选举和集群协调的锁定服务。</p>
<p><strong>Eureka 保证高可用(A)和最终一致性：</strong></p>
<p>服务注册相对要快，因为不需要等注册信息 replicate 到其它节点，也不保证注册信息是否 replicate 成功。当数据出现不一致时，虽然 A, B 上的注册信息不完全相同，但每个 Eureka 节点依然能够正常对外提供服务，这会出现查询服务信息时如果请求 A 查不到，但请求 B 就能查到。如此保证了可用性但牺牲了一致性。</p>
<h3 id="安装">安装</h3>
<h3 id="windows安装">windows安装</h3>
<p>Consul 不同于 Eureka 是由 go 语言开发而成，因此需要我们单独来安装。</p>
<p>打开 <a target="_blank" rel="noopener" href="https://www.consul.io/">Consul</a>官网根据不同的操作系统选择最新的 Consul 版本，我们这里以 Windows 64 操作系统为例，可以看出 Consul 目前的最新版本为 1.10.2</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905175006524.png" alt="image-20210905175006524"></p>
<p>下载下来是一个 consul_1.4.4_windows_amd64.zip 的压缩包，解压是一个 consul.exe 的执行文件。</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905180346665.png" alt="image-20210905180346665"></p>
<p>cd 到对应的目录下，使用 cmd 启动 Consul：</p>
<blockquote>
<p>cd D:\Common Files\consul</p>
</blockquote>
<p>#cmd启动： consul agent -dev # -dev表示开发模式运行，另外还有-server表示服务模式运行</p>
<p>为了方便启动，可以在同级目录下创建一个 run.bat 脚本来启动，脚本内容如下：</p>
<blockquote>
<p>@echo off</p>
<p>rem -dev开发模式启动   -server服务器启动<br>
consul agent -dev</p>
</blockquote>
<p>下次启动的时候直接双击 run.bat 文件即可；当然也可以把 consul 的 exe 文件路径加入到本机的 path 路径下，这样后期只需要在 cmd 命令行下运行</p>
<p>执行命令后，命令行会输出如下信息：</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905180405626.png" alt="image-20210905180405626"></p>
<p>启动成功之后访问：localhost:8500,就可以看到Consul的管理界面</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905180419978.png" alt="image-20210905180419978"></p>
<p>Consul 的 Web 管理界面有一些菜单，我们这里做一下简单的介绍：</p>
<ul>
<li>
<p><strong>Services</strong></p>
<blockquote>
<p>管理界面的默认页面，用来展示注册到 Consul 的服务，启动后默认会有一个 consul 服务，也就是它本身。</p>
</blockquote>
</li>
<li>
<p><strong>Nodes</strong></p>
<blockquote>
<p>在 Services 界面双击服务名就会来到 Services 对于的 Nodes 界面，Services 是按照服务的抽象来展示的，Nodes 展示的是此服务的具体节点信息。比如启动了两个订单服务实例，Services 界面会出现一个订单服务，Nodes 界面会展示两个订单服务的节点。</p>
</blockquote>
</li>
<li>
<p><strong>Key/Value</strong></p>
<blockquote>
<p>如果有用到 Key/Value 存储，可以在界面进行配置、查询。</p>
</blockquote>
</li>
<li>
<p><strong>Intentions</strong></p>
<blockquote>
<p>可以在页面配置请求权限。</p>
</blockquote>
</li>
</ul>
<p>当我们看到这个页面后，也就意味着 Consul 已经安装成功了。</p>
<h3 id="Linux安装">Linux安装</h3>
<p>下载Consul</p>
<blockquote>
<p>sudo  wget <a target="_blank" rel="noopener" href="https://releases.hashicorp.com/consul/1.10.2/consul_1.10.2_linux_amd64.zip">https://releases.hashicorp.com/consul/1.10.2/consul_1.10.2_linux_amd64.zip</a></p>
</blockquote>
<p>解压Consul.zip文件</p>
<blockquote>
<p>sudo   unzip consul_1.10.2_linux_amd64.zip</p>
</blockquote>
<p>启动</p>
<p>-dev表示开发环境允许     -node后面则是consul的名称</p>
<blockquote>
<p>./consul agent -dev -ui -node=consul-dev -client=192.168.32.131</p>
</blockquote>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905215249994.png" alt="image-20210905215249994"></p>
<p>此时我们的注册中心就创建好了(Consul是一个独立的服务)</p>
<h3 id="注册服务">注册服务</h3>
<p>创建一个SpringBoot工程</p>
<p>加入以下依赖</p>
<ul>
<li>Spring Web</li>
<li>Consul Discovery</li>
<li>Spring Boot Actuator</li>
</ul>
<p>由于Consul具有服务健康检查功能，所以我们需要加入<code>Spring Boot Actuator</code>依赖，将该服务的健康信息加载到<code>Consul</code>中</p>
<p><strong>Spring boot actuator介绍</strong><br>
Spring Boot包含许多其他功能，可帮助您在将应用程序推送到生产环境时监视和管理应用程序。</p>
<p>您可以选择使用HTTP端点或JMX来管理和监视应用程序。</p>
<p>审核，运行状况和指标收集也可以自动应用于您的应用程序。</p>
<p>总之Spring Boot Actuator就是一款可以帮助你监控系统数据的框架,其可以监控很多很多的系统数据,它有对应用系统的自省和监控的集成功能，可以查看应用配置的详细信息,如:</p>
<ul>
<li>
<p>显示应用程序员的Health健康信息</p>
</li>
<li>
<p>显示Info应用信息</p>
</li>
<li>
<p>显示HTTP Request跟踪信息</p>
</li>
<li>
<p>显示当前应用程序的“Metrics”信息</p>
</li>
<li>
<p>显示所有的@RequestMapping的路径信息</p>
</li>
<li>
<p>显示应用程序的各种配置信息</p>
</li>
<li>
<p>显示你的程序请求的次数 时间 等各种信息</p>
</li>
</ul>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905220859704.png" alt="image-20210905220859704"></p>
<p>properties配置信息</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务名称</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">Consul-Provider</span></span><br><span class="line"><span class="comment">#端口</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">5555</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#consul注册中心的ip</span></span><br><span class="line"><span class="meta">spring.cloud.consul.host</span>=<span class="string">192.168.32.131</span></span><br><span class="line"><span class="comment">#注册中心端口</span></span><br><span class="line"><span class="meta">spring.cloud.consul.port</span>=<span class="string">8500</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#服务名称和spring.application.name效果相同，不过会覆盖spring.application.name的值</span></span><br><span class="line"><span class="meta">spring.cloud.consul.discovery.service-name</span>=<span class="string">consul-provider-1</span></span><br><span class="line"><span class="comment">#服务实例名称</span></span><br><span class="line"><span class="meta">spring.cloud.consul.discovery.instance-id</span>=<span class="string">provider1</span></span><br></pre></td></tr></table></figure>
<p>在启动类中加入<code>@EnableDiscoveryClient</code>注解</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905222855447.png" alt="image-20210905222855447"></p>
<h4 id="集群版"><strong>集群版</strong></h4>
<p><strong>Provider</strong></p>
<p>只需启动两个provider即可</p>
<blockquote>
<p>java -jar Consul-Provider-0.0.1-SNAPSHOT.ja<br>
r --server.port=6666 --spring.cloud.consul.discovery.instance-id=provider2</p>
</blockquote>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210905224409054.png" alt="image-20210905224409054"></p>
<p><strong>Consumer</strong></p>
<p>Consumer的创建方式和Provider方式一样</p>
<p>不做过多赘述</p>
<p>我们来直接看负载均衡调用</p>
<p>创建一个带负载均衡<code>RestTemplat</code>的Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发起调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LoadBalancerClient loadBalancerClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//发起调用</span></span><br><span class="line">        String vale = restTemplate.getForObject(<span class="string">&quot;http://consul-provider&quot;</span> + <span class="string">&quot;/hello&quot;</span>, String.class);</span><br><span class="line">        <span class="keyword">return</span> vale;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><font color="red">Ribbon现在以及是SpringCloud自带的负载均衡服务了</font></p>
<p>Ribbon的负载均衡原理请看<a href="#ribbon">四，Ribbon源码解析</a></p>
<h2 id="六，Hystrix">六，Hystrix</h2>
<h3 id="Hystrix是什么">Hystrix是什么</h3>
<p>在分布式环境中，许多服务依赖项中的一些必然会失败。Hystrix是一个库，通过添加延迟容忍和容错逻辑，帮助你控制这些分布式服务之间的交互。Hystrix通过隔离服务之间的访问点、停止级联失败和提供回退选项来实现这一点，所有这些都可以提高系统的整体弹性。</p>
<h3 id="Hystrix为了什么">Hystrix为了什么</h3>
<p>Hystrix被设计的目标是：</p>
<ol>
<li>对通过第三方客户端库访问的依赖项（通常是通过网络）的延迟和故障进行保护和控制。</li>
<li>在复杂的分布式系统中阻止级联故障。</li>
<li>快速失败，快速恢复。</li>
<li>回退，尽可能优雅地降级。</li>
<li>启用近实时监控、警报和操作控制。</li>
</ol>
<h3 id="Hystrix解决了什么问题">Hystrix解决了什么问题</h3>
<p>复杂分布式体系结构中的应用程序有许多依赖项，每个依赖项在某些时候都不可避免地会失败。如果主机应用程序没有与这些外部故障隔离，那么它有可能被他们拖垮。</p>
<p>例如，对于一个依赖于30个服务的应用程序，每个服务都有99.99%的正常运行时间，你可以期望如下：</p>
<p><strong>99.9930 = 99.7%</strong> 可用</p>
<p>也就是说一亿个请求的<strong>0.03% = 3000000</strong> 会失败</p>
<p>如果一切正常，那么<strong>每个月有2个小时服务是不可用的</strong></p>
<p>现实通常是更糟糕</p>
<hr>
<p>当一切正常时，请求看起来是这样的：</p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201807/874963-20180730172725624-245631738.png" alt="img"></p>
<p>当其中有一个系统有延迟时，它可能阻塞整个用户请求：</p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201807/874963-20180730172821821-960520983.png" alt="img"></p>
<p>在高流量的情况下，一个后端依赖项的延迟可能导致所有服务器上的所有资源在数秒内饱和（PS：意味着后续再有请求将无法立即提供服务）</p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201807/874963-20180730172949326-29467411.png" alt="img"></p>
<h3 id="Hystrix设计原则是什么">Hystrix设计原则是什么</h3>
<ul>
<li>防止任何单个依赖项耗尽所有容器（如Tomcat）用户线程。</li>
<li>甩掉包袱，快速失败而不是排队。</li>
<li>在任何可行的地方提供回退，以保护用户不受失败的影响。</li>
<li>使用隔离技术（如隔离板、泳道和断路器模式）来限制任何一个依赖项的影响。</li>
<li>通过近实时的度量、监视和警报来优化发现时间。</li>
<li>通过配置的低延迟传播来优化恢复时间。</li>
<li>支持对Hystrix的大多数方面的动态属性更改，允许使用低延迟反馈循环进行实时操作修改。</li>
<li>避免在整个依赖客户端执行中出现故障，而不仅仅是在网络流量中。</li>
</ul>
<h3 id="Hystrix是如何实现它的目标的">Hystrix是如何实现它的目标的</h3>
<ol>
<li>用一个HystrixCommand 或者 HystrixObservableCommand （这是命令模式的一个例子）包装所有的对外部系统（或者依赖）的调用，典型地它们在一个单独的线程中执行</li>
<li>调用超时时间比你自己定义的阈值要长。有一个默认值，对于大多数的依赖项你是可以自定义超时时间的。</li>
<li>为每个依赖项维护一个小的线程池(或信号量)；如果线程池满了，那么该依赖性将会立即拒绝请求，而不是排队。</li>
<li>调用的结果有这么几种：成功、失败（客户端抛出异常）、超时、拒绝。</li>
<li>在一段时间内，如果服务的错误百分比超过了一个阈值，就会触发一个断路器来停止对特定服务的所有请求，无论是手动的还是自动的。</li>
<li>当请求失败、被拒绝、超时或短路时，执行回退逻辑。</li>
<li>近实时监控指标和配置变化。</li>
</ol>
<p>当你使用Hystrix来包装每个依赖项时，上图中所示的架构会发生变化，如下图所示：</p>
<p>每个依赖项相互隔离，当延迟发生时，它会被限制在资源中，并包含回退逻辑，该逻辑决定在依赖项中发生任何类型的故障时应作出何种响应：</p>
<p><img src="https://images2018.cnblogs.com/blog/874963/201807/874963-20180730173442729-1485668320.png" alt="img"></p>
<h2 id="八，OpenFeign">八，OpenFeign</h2>
<h3 id="简介-3">简介</h3>
<p>OpenFeign是一种声明式、模板化的HTTP客户端。在Spring Cloud中使用OpenFeign，可以做到使用HTTP请求访问远程服务，就像调用本地方法一样的，开发者完全感知不到这是在调用远程方法，更感知不到在访问HTTP请求</p>
<h3 id="构建OpenFigen应用">构建OpenFigen应用</h3>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210914221535525.png" alt="image-20210914221535525"></p>
<p>配置文件</p>
<p>主要配置Eureka信息</p>
<p>注意<code>eurekaA</code>已在本地host文件中映射到<code>1270.0.1</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=OpenFeignServer</span><br><span class="line"></span><br><span class="line">server.port=<span class="number">7777</span></span><br><span class="line"></span><br><span class="line">eureka.instance.instance-id=OpenFeign</span><br><span class="line"></span><br><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//eurekaA:1111/eureka</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>在启动类中加入<code>@EnableEurekaClient</code>和<code>@EnableFeignClients</code></p>
<ul>
<li><code>@EnableFeignClients</code>申明该项目是Feign客户端，扫描对应的feign client。</li>
<li><code>@EnableEurekaClient</code>申明该项目是Eureka客户端，将注册到Eureka和拉取注册中心信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenFeignApplication</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(OpenFeignApplication.class, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>}</p>
</li>
<li>
<p>书写API接口</p>
<p>我们需要集中化管理API，就可以通过接口统一管理，需要新增提供者(Provdier)服务的接口，并添加<code>@FeignClient(name=&quot;PROVIDER-APPLICATION&quot;)</code>注解，其中name就是我们要访问的微服务的名称。比如hello方法中<code>@GetMapping(&quot;/hello&quot;)</code>和服务提供者的<code>hello</code>的接口路径是一样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//和注册中心的服务绑定</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;PROVIDER-APPLICATION&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//服务的接口名称以及请求方式</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="comment">//接口返回类型</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210914225806424.png" alt="image-20210914225806424"></p>
<p>不难发现使用OpenFegin调用接口更加方便，相较于使用RestTemplate，更加水到渠成，符合条理</p>
</li>
</ol>
<p>​		最后我们在Controller层调用OpenFeign的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloConreoller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HelloService helloService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> helloService.hello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
<p><strong>所有请求方式的案例</strong></p>
<ul>
<li>Controller(Consumer)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloConreoller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HelloService helloService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;test&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line">        String hello = helloService.hello();</span><br><span class="line">        System.out.println(<span class="string">&quot;hello()==========&gt;&quot;</span>+hello);</span><br><span class="line"></span><br><span class="line">        hello = helloService.hello(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;hello(\&quot;张三\&quot;)==========&gt;&quot;</span>+hello);</span><br><span class="line"></span><br><span class="line">        String name = helloService.name(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;name(\&quot;李四\&quot;)=============&gt;&quot;</span>+name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求头传递参数请将参数转码</span></span><br><span class="line">        String enable = URLEncoder.encode(<span class="string">&quot;你好请求头&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        String s = helloService.nameHeader(enable);</span><br><span class="line">        System.out.println(<span class="string">&quot;nameHeader(enable)=============&gt;&quot;</span>+s);</span><br><span class="line"></span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">1</span>);</span><br><span class="line">        user.setUsername(<span class="string">&quot;没写密码&quot;</span>);</span><br><span class="line">        User addUser = helloService.addUser(user);</span><br><span class="line">        System.out.println(<span class="string">&quot;addUser(user)=============&gt;&quot;</span>+addUser);</span><br><span class="line"></span><br><span class="line">        user.setId(<span class="number">2</span>);</span><br><span class="line">        user.setPassword(<span class="string">&quot;他骗你的，写密码了&quot;</span>);</span><br><span class="line">        User updateUser = helloService.updateUser(user);</span><br><span class="line">        System.out.println(<span class="string">&quot;updateUser(user)=============&gt;&quot;</span>+updateUser);</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; ages = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        Integer age = helloService.getAge(ages);</span><br><span class="line">        System.out.println(<span class="string">&quot;getAge(ages)=============&gt;&quot;</span>+age);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>OpenFeign接口(Consumer)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//和注册中心的服务绑定</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;PROVIDER-APPLICATION&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//服务的接口名称以及请求方式</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="comment">//接口返回类型</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/name&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/nameHeader&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">nameHeader</span><span class="params">(<span class="meta">@RequestHeader(&quot;nameHeader&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addUser&quot;)</span></span><br><span class="line">    <span class="function">User <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/updateUser&quot;)</span></span><br><span class="line">    <span class="function">User <span class="title">updateUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getAge&quot;)</span></span><br><span class="line">    <span class="function">Integer <span class="title">getAge</span><span class="params">(<span class="meta">@RequestParam(&quot;age&quot;)</span> List&lt;Integer&gt; age)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>API接口(Provider)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloConreoller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>+name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/name&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name+<span class="string">&quot;哈哈哈哈&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/nameHeader&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">nameHeader</span><span class="params">(<span class="meta">@RequestHeader(&quot;nameHeader&quot;)</span> String nameHeader)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line">        String decode = URLDecoder.decode(nameHeader, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> decode+<span class="string">&quot;Header&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">addUser</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/updateUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">updateUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getAge&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">(<span class="meta">@RequestParam(&quot;age&quot;)</span> List&lt;Integer&gt; age)</span></span>&#123;</span><br><span class="line">        System.out.println(age);</span><br><span class="line">        <span class="keyword">return</span> age.get(<span class="number">0</span>)+<span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><font color="red">值得注意的是OpenFeign接口</font></p>
<p><font color="red">凡是</font><code>key/value</code><font color="red">形式的参数全部需要加上</font><code>@RequestParam(&quot;参数名称&quot;) || @PathVariable(&quot;参数名称&quot;)</code></p>
<p><font color="red">JSON数据加上</font><code>@RequestBody</code><font color="red">注解</font></p>
<h3 id="继承特性">继承特性</h3>
<p>继承特性主体思想就是将接口提取成为一个模块，并在Provider模块和Consumer模块中继承接口模块，这样方便了接口的统一，在修改过程中不需要在去Provider模块和Consumer模块的接口，而是修改接口模块</p>
<p>缺点也显而易见，在分布式服务中，我们致力于将服务之间的耦合度降到最低，而实现继承特性，无疑增加了耦合度。</p>
<p>创建接口模块</p>
<ul>
<li>创建Maven模块(方引用)</li>
</ul>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210919232336198.png" alt="image-20210919232336198"></p>
<ul>
<li>在pom.xml文件中引入<font color="red">Web依赖</font>(需要<code>@XXXMapping</code>接口)和Commons依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.xpp011<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>OpenFeign-API<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.xpp011<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>在API模块中书写接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">//服务的接口名称以及请求方式</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="comment">//接口返回类型</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/name&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/nameHeader&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">nameHeader</span><span class="params">(<span class="meta">@RequestHeader(&quot;nameHeader&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addUser&quot;)</span></span><br><span class="line">    <span class="function">User <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/updateUser&quot;)</span></span><br><span class="line">    <span class="function">User <span class="title">updateUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getAge&quot;)</span></span><br><span class="line">    <span class="function">Integer <span class="title">getAge</span><span class="params">(<span class="meta">@RequestParam(&quot;age&quot;)</span> List&lt;Integer&gt; age)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在<code>Provider</code>模块<code>Consumer</code>模块中引入API模块</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.xpp011<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>OpenFeign-API<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>Provider</code>模块的Controller实现API接口</p>
<p><font color="red">注意，由于接口中以及写了</font><code>@XXXMapping</code><font color="red">接口</font>，所以Controller类中只需实现接口方法，不需要再写注解了</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloConreoller</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>+name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name+<span class="string">&quot;哈哈哈哈&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">nameHeader</span><span class="params">(<span class="meta">@RequestHeader(&quot;nameHeader&quot;)</span> String nameHeader)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line">        String decode = URLDecoder.decode(nameHeader, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> decode+<span class="string">&quot;Header&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>&#123;</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">updateUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">(<span class="meta">@RequestParam(&quot;age&quot;)</span> List&lt;Integer&gt; age)</span></span>&#123;</span><br><span class="line">        System.out.println(age);</span><br><span class="line">        <span class="keyword">return</span> age.get(<span class="number">0</span>)+<span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Consumer</code>模块的OpenFeign接口只需继承API模块的接口即可</li>
</ul>
<p><font color="red">注意加上</font><code>@FeignClient</code><font color="red">注解</font>，于服务绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//和注册中心的服务绑定</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;PROVIDER-APPLICATION&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="日志">日志</h3>
<p>OpenFeign中，我们可以使用日志来查看整个调用过程</p>
<p>级别</p>
<ol>
<li><code>NONE</code>:不开启日志</li>
<li><code>BASIC</code>:记录请求方法，URL，状态码，执行时间</li>
<li><code>HEADERS</code>:在<code>BASIC</code>基础上加上，响应头</li>
<li><code>FULL</code>:在<code>HEADERS</code>基础上，再增加body和请求元数据</li>
</ol>
<p>首先我们需要再Bean中配置日志级别</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenFeignConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启OpenFeign的日志功能</span></span><br><span class="line"><span class="comment">     * 级别</span></span><br><span class="line"><span class="comment">     * 1. `NONE`:不开启日志</span></span><br><span class="line"><span class="comment">     * 2. `BASIC`:记录请求方法，URL，状态码，执行时间</span></span><br><span class="line"><span class="comment">     * 3. `HEADERS`:在`BASIC`基础上加上，响应头</span></span><br><span class="line"><span class="comment">     * 4. `FULL`:在`HEADERS`基础上，再增加body和请求元数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">loggerLevel</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后在application.properties配置文件中指定包下的打印日志级别</p>
<blockquote>
<p>logging.level.cn.xpp011=debug</p>
</blockquote>
<p>以下就是<code>OpenFeign</code>打印的请求日志信息</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210920093306269.png" alt="image-20210920093306269"></p>
<h3 id="数据压缩">数据压缩</h3>
<p>数据压缩主要是将一些请求数据和响应数据过大时，进行数据压缩来提升传输效率</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启请求数据压缩</span></span><br><span class="line"><span class="meta">feign.compression.request.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#需要压缩的请求数据的类型</span></span><br><span class="line"><span class="meta">feign.compression.request.mime-types</span>=<span class="string">text/xml,application/json,application/xml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#请求数据开始压缩的最小阈值(默认2048B)</span></span><br><span class="line"><span class="meta">feign.compression.request.min-request-size</span>=<span class="string">2048</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#开启响应数据压缩</span></span><br><span class="line"><span class="meta">feign.compression.response.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
<h2 id="九，Resilience4j">九，Resilience4j</h2>
<p>官方文档:  <a target="_blank" rel="noopener" href="https://resilience4j.readme.io/">https://resilience4j.readme.io/</a></p>
<p>推荐文档:<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5531b66b777a">https://www.jianshu.com/p/5531b66b777a</a></p>
<h3 id="简介-4">简介</h3>
<p><strong>Resilience4j</strong>是一款轻量级，易于使用的容错库，其灵感来自于<strong>Netflix Hystrix</strong>，但是专为<strong>Java</strong> <strong>8</strong>和函数式编程而设计。轻量级，因为库只使用了<strong>Vavr</strong>，它没有任何其他外部依赖下。相比之下，<strong>Netflix Hystrix</strong>对<strong>Archaius</strong>具有编译依赖性，<strong>Archaius</strong>具有更多的外部库依赖性，例如<strong>Guava</strong>和<strong>Apache Commons Configuration</strong>。</p>
<p>要使用<strong>Resilience4j</strong>，不需要引入所有依赖，只需要选择你需要的。</p>
<p><strong>Resilience4j</strong>提供了以下的核心模块和拓展模块:</p>
<p><strong>核心模块：</strong></p>
<ul>
<li><strong>resilience4j-circuitbreaker: Circuit breaking</strong>——<strong>断路器</strong></li>
<li><strong>resilience4j-ratelimiter: Rate limiting</strong>——<strong>限流器</strong></li>
<li><strong>resilience4j-bulkhead: Bulkheading</strong></li>
<li><strong>resilience4j-retry: Automatic retrying (sync and async)</strong>——<strong>请求重试</strong></li>
<li><strong>resilience4j-cache: Result caching</strong></li>
<li><strong>resilience4j-timelimiter: Timeout handling</strong></li>
</ul>
<h3 id="CircuitBreaker">CircuitBreaker</h3>
<h4 id="简介-5">简介</h4>
<p><strong>CircuitBreaker</strong>通过具有三种正常状态的有限状态机实现：<strong>CLOSED</strong>，<strong>OPEN</strong>和<strong>HALF_OPEN</strong>以及两个特殊状态<strong>DISABLED</strong>和<strong>FORCED_OPEN</strong>。当熔断器关闭时，所有的请求都会通过熔断器。如果失败率超过设定的阈值，熔断器就会从关闭状态转换到打开状态，这时所有的请求都会被拒绝。当经过一段时间后，熔断器会从打开状态转换到半开状态，这时仅有一定数量的请求会被放入，并重新计算失败率，如果失败率超过阈值，则变为打开状态，如果失败率低于阈值，则变为关闭状态。</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/17742950-f8db8dc0ceb552d0.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/426/format/webp" alt="img"></p>
<p>Circuitbreaker状态机</p>
<p><strong>Resilience4j</strong>记录请求状态的数据结构和<strong>Hystrix</strong>不同，<strong>Hystrix</strong>是使用滑动窗口来进行存储的，而<strong>Resilience4j</strong>采用的是<em>Ring Bit Buffer</em>(环形缓冲区)<font color="red">现CircuitBreajer继续使用了滑动窗口作为缓存器</font>。<strong>Ring Bit Buffer</strong>在内部使用<strong>BitSet</strong>这样的数据结构来进行存储，<strong>BitSet</strong>的结构如下图所示：</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/17742950-9cedc9cd8d8d650f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/222/format/webp" alt="img"></p>
<p>环形缓冲区</p>
<p>每一次请求的成功或失败状态只占用一个<strong>bit</strong>位，与<strong>boolean</strong>数组相比更节省内存。<strong>BitSet</strong>使用<strong>long[]<strong>数组来存储这些数据，意味着</strong>16</strong>个值(<strong>64bit</strong>)的数组可以存储<strong>1024</strong>个调用状态。</p>
<p>计算失败率需要填满环形缓冲区。例如，如果环形缓冲区的大小为<strong>10</strong>，则必须至少请求满<strong>10</strong>次，才会进行故障率的计算，如果仅仅请求了<strong>9</strong>次，即使<strong>9</strong>个请求都失败，熔断器也不会打开。但是<em><strong>CLOSE*<strong>状态下的缓冲区大小设置为</strong>10</strong>并不意味着只会进入</em><em>10</em>*个 请求，在熔断器打开之前的所有请求都会被放入。</p>
<p>当故障率高于设定的阈值时，熔断器状态会从由<strong>CLOSE</strong>变为<strong>OPEN</strong>。这时所有的请求都会抛出<strong>CallNotPermittedException</strong>异常。当经过一段时间后，熔断器的状态会从<strong>OPEN</strong>变为<strong>HALF_OPEN</strong>，<strong>HALF_OPEN</strong>状态下同样会有一个<strong>Ring Bit Buffer</strong>，用来计算<strong>HALF_OPEN</strong>状态下的故障率，如果高于配置的阈值，会转换为<strong>OPEN</strong>，低于阈值则装换为<strong>CLOSE</strong>。与<strong>CLOSE</strong>状态下的缓冲区不同的地方在于，<strong>HALF_OPEN</strong>状态下的缓冲区大小会限制请求数，只有缓冲区大小的请求数会被放入。</p>
<p>除此以外，熔断器还会有两种特殊状态：<strong>DISABLED</strong>（始终允许访问）和<strong>FORCED_OPEN</strong>（始终拒绝访问）。这两个状态不会生成熔断器事件（除状态装换外），并且不会记录事件的成功或者失败。退出这两个状态的唯一方法是触发状态转换或者重置熔断器。</p>
<p>熔断器关于线程安全的保证措施有以下几个部分：</p>
<ul>
<li>熔断器的状态使用<strong>AtomicReference</strong>保存的</li>
<li>更新熔断器状态是通过无状态的函数或者原子操作进行的</li>
<li>更新事件的状态用<strong>synchronized</strong>关键字保护</li>
</ul>
<p>意味着同一时间只有一个线程能够修改熔断器状态或者记录事件的状态。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9mUm1lRHh6TWwwY29CbDhpY1dRYWlhUzkxMjBlb3NMeFBJcmpSOHJVanVibWR0ZGljNjVZOFpscFNwS0E4VVNaMm5WeXppY0lzak9pY0x0aHk0Zkh5aWNGNlVZdy82NDA?x-oss-process=image/format,png" alt="img"></p>
<h4 id="创建和配置断路器">创建和配置断路器</h4>
<p>您可以提供自己的自定义 断路器. 为了创建自定义全局 CircuitBreakerConfig，您可以使用 CircuitBreakerConfig 构建器。您可以使用构建器配置以下属性。<code>CircuitBreakerConfig</code>‘</p>
<table>
<thead>
<tr>
<th style="text-align:left">配置属性</th>
<th style="text-align:left">默认值</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">failureRateThreshold</td>
<td style="text-align:left">50</td>
<td style="text-align:left">配置失败率阈值百分比。当故障率等于或大于阈值时，断路器切换到开路并开始短路呼叫。</td>
</tr>
<tr>
<td style="text-align:left">slowCallRateThreshold</td>
<td style="text-align:left">100</td>
<td style="text-align:left">配置百分比阈值。当呼叫时长大于“slowCallDurationThreshold”时，CircuitBreaker认为该呼叫为慢速呼叫。当慢速呼叫的百分比大于等于该阈值时，CircuitBreaker会切换到开路，并开始短路呼叫。</td>
</tr>
<tr>
<td style="text-align:left">slowCallDurationThreshold</td>
<td style="text-align:left">60000 [ms]</td>
<td style="text-align:left">配置时长阈值，超过该阈值呼叫将被视为慢速呼叫，并提高慢速呼叫的速率。</td>
</tr>
<tr>
<td style="text-align:left">permittedNumberOfCalls InHalfOpenState</td>
<td style="text-align:left">10</td>
<td style="text-align:left">当断路器半打开时,配置允许调用的数量。</td>
</tr>
<tr>
<td style="text-align:left">maxWaitDurationInHalfOpenState</td>
<td style="text-align:left">0 [ms]</td>
<td style="text-align:left">值0表示断路器将在半开状态无限等待，直到所有允许的调用完成。</td>
</tr>
<tr>
<td style="text-align:left">slidingWindowType</td>
<td style="text-align:left">COUNT_BASED</td>
<td style="text-align:left">滑动窗口可以是基于计数的，也可以是基于时间的。如果滑动窗口是COUNT_BASED，则记录并聚合最后的’ slidingWindowSize ‘调用。如果滑动窗口是TIME_BASED，则记录并聚合最后一个’ slidingWindowSize '秒的调用。</td>
</tr>
<tr>
<td style="text-align:left">slidingWindowSize</td>
<td style="text-align:left">100</td>
<td style="text-align:left">设置断路器关闭时记录通话结果的滑动窗口的大小。</td>
</tr>
<tr>
<td style="text-align:left">minimumNumberOfCalls</td>
<td style="text-align:left">100</td>
<td style="text-align:left">配置CircuitBreaker在计算错误率或慢速呼叫率之前所需的最小呼叫数(每个滑动窗口周期)。例如，如果minimumNumberOfCalls为10，则必须至少记录10个呼叫，才能计算失败率。如果只有9个呼叫被记录，即使9个呼叫都失败了，断路器也不会切换到打开。</td>
</tr>
<tr>
<td style="text-align:left">waitDurationInOpenState</td>
<td style="text-align:left">60000 [ms]</td>
<td style="text-align:left">断路器从开路过渡到半开路所需的时间。</td>
</tr>
<tr>
<td style="text-align:left">automaticTransition FromOpenToHalfOpenEnabled</td>
<td style="text-align:left">false</td>
<td style="text-align:left">如果设置为true，则意味着CircuitBreaker将自动从开状态过渡到半开状态，不需要调用来触发过渡。创建一个线程来监视CircuitBreakers的所有实例，一旦waitDurationInOpenState通过，就将它们转换到HALF_OPEN。然而，如果设置为false，则转换到HALF_OPEN只在调用时发生，即使在waitDurationInOpenState被传递之后。这样做的好处是没有线程监视所有断路器的状态。</td>
</tr>
<tr>
<td style="text-align:left">recordExceptions</td>
<td style="text-align:left">empty</td>
<td style="text-align:left">记录为失败的异常列表，从而增加失败率。任何从列表中匹配或继承的异常都被视为失败，除非通过’ ignoreExceptions ‘显式忽略。<font color="red">如果你指定了一个异常列表，所有其他异常都算成功，除非它们被’ ignoreExceptions '显式忽略。</font></td>
</tr>
<tr>
<td style="text-align:left">ignoreExceptions</td>
<td style="text-align:left">empty</td>
<td style="text-align:left">一列被忽略的例外，既不能算作失败也不能算作成功。任何从列表中匹配或继承的异常都不会被视为失败或成功，即使异常是’ recordexception '的一部分。</td>
</tr>
<tr>
<td style="text-align:left">recordFailurePredicate</td>
<td style="text-align:left">throwable -&gt; true 默认情况下，所有异常都记录为失败。</td>
<td style="text-align:left">如果异常应该被记录为失败的定义谓词。如果异常应该被视为失败,则谓词必须返回true。谓词必须返回false,如果异常应该被视为成功,除非异常被“无知异常”显式地忽略。</td>
</tr>
<tr>
<td style="text-align:left">ignoreException</td>
<td style="text-align:left">throwable -&gt; false 默认情况下不忽略任何异常</td>
<td style="text-align:left">一个定义谓词,如果一个异常应该被忽略,而不是被视为失败或成功。如果异常应该被忽略,则谓词必须返回true。如果异常应该被视为失败,则谓词必须返回false。</td>
</tr>
</tbody>
</table>
<h4 id="依赖">依赖</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.github.resilience4j/resilience4j-circuitbreaker --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-circuitbreaker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="java配置断路器">java配置断路器</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//默认配置</span></span><br><span class="line">    CircuitBreakerRegistry breakerRegistry = CircuitBreakerRegistry.ofDefaults();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义配置</span></span><br><span class="line">    CircuitBreakerConfig build = CircuitBreakerConfig.custom()</span><br><span class="line">            <span class="comment">//熔断器关闭状态和半开状态使用的同一个失败率阈值</span></span><br><span class="line">            .failureRateThreshold(<span class="number">50</span>)</span><br><span class="line">            <span class="comment">//超时请求阈值</span></span><br><span class="line">            .slowCallRateThreshold(<span class="number">100</span>)</span><br><span class="line">            <span class="comment">//请求超时的阈值 超过一秒视为超时请求</span></span><br><span class="line">            .slowCallDurationThreshold(Duration.ofMillis(<span class="number">1000</span>))</span><br><span class="line">            <span class="comment">//如果置为true，当等待时间结束会自动由打开变为半开，若置为false，则需要一个请求进入来触发熔断器状态转换</span></span><br><span class="line">            .automaticTransitionFromOpenToHalfOpenEnabled(<span class="keyword">false</span>)</span><br><span class="line">            <span class="comment">//熔断器从打开状态转变为半开状态等待的时间</span></span><br><span class="line">            .waitDurationInOpenState(Duration.ofMillis(<span class="number">1000</span>))</span><br><span class="line">            <span class="comment">//【过时】熔断器关闭状态的缓冲区大小，不会限制线程的并发量，在熔断器发生状态转换前所有请求都会调用后端服务</span></span><br><span class="line">            <span class="comment">//.ringBufferSizeInClosedState(2)</span></span><br><span class="line">            <span class="comment">//【过时】熔断器半开状态的缓冲区大小，会限制线程的并发量，例如缓冲区为10则每次只会允许10个请求调用后端服务</span></span><br><span class="line">            <span class="comment">//.ringBufferSizeInHalfOpenState(2)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//滑动窗口的类型</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 如果滑动窗口为 COUNT_BASED，则记录并汇总最后一次调用。</span></span><br><span class="line"><span class="comment">             * 如果滑动窗口是 TIME_BASED，则记录和聚合最后几秒的调用。*/</span></span><br><span class="line">            .slidingWindowType(CircuitBreakerConfig.SlidingWindowType.COUNT_BASED)</span><br><span class="line">            <span class="comment">//最少调用次数  表示滑动窗口的周期大小，只有请求次数到达最少调用次数才满足开启断路器的第一要求</span></span><br><span class="line">            .minimumNumberOfCalls(<span class="number">2</span>)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">//装饰器模式</span></span><br><span class="line">    CircuitBreakerRegistry custom = CircuitBreakerRegistry.of(build);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为生成的配置起一个名字    可以生成多个CircuitBreaker共享一个配置实例</span></span><br><span class="line">    CircuitBreaker breaker = custom.circuitBreaker(<span class="string">&quot;nmae1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//装饰器模式 意为使用断路器breaker装饰第二个方法</span></span><br><span class="line">    CheckedFunction0&lt;String&gt; decorateCheckedSupplier = CircuitBreaker.decorateCheckedSupplier(breaker, () -&gt; <span class="string">&quot;hello Resilience4J&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行结果  map方法内的v为执行后的结果，可对结果二次操作</span></span><br><span class="line">    Try&lt;String&gt; result = Try.of(decorateCheckedSupplier).map(v -&gt; v + <span class="string">&quot;  hello CircuitBreaker&quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;=========第一次调用=========&quot;</span>);</span><br><span class="line">    CircuitBreakerUtil.getCircuitBreakerStatus(<span class="string">&quot;第一次调用&quot;</span>,breaker);</span><br><span class="line">    System.out.println(<span class="string">&quot;result是否成功==========&gt;&quot;</span>+result.isSuccess());</span><br><span class="line">    System.out.println(<span class="string">&quot;result结果==========&gt;&quot;</span>+result.get());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//展示断路器效果</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行失败一次</span></span><br><span class="line">    breaker.onError(<span class="number">0L</span>,TimeUnit.MINUTES,<span class="keyword">new</span> RuntimeException());</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;=========第二次失败调用=========&quot;</span>);</span><br><span class="line">    CircuitBreakerUtil.getCircuitBreakerStatus(<span class="string">&quot;第二次失败调用&quot;</span>,breaker);</span><br><span class="line">    <span class="comment">//满足断路器的要求   即失败率达到50%</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//滑动窗口大小为2  调用满两次  一次失败  断路器开启 拒绝一切请求</span></span><br><span class="line"></span><br><span class="line">    CheckedFunction0&lt;String&gt; decorateCheckedSupplier2 = CircuitBreaker.decorateCheckedSupplier(breaker, () -&gt; <span class="string">&quot;断路器开启&quot;</span>);</span><br><span class="line">    Try&lt;String&gt; result2 = Try.of(decorateCheckedSupplier2);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;=========第三次拦截调用=========&quot;</span>);</span><br><span class="line">    CircuitBreakerUtil.getCircuitBreakerStatus(<span class="string">&quot;第三次拦截调用&quot;</span>,breaker);</span><br><span class="line">    System.out.println(<span class="string">&quot;result2是否成功==========&gt;&quot;</span>+result2.isSuccess());</span><br><span class="line">    System.out.println(<span class="string">&quot;result2结果==========&gt;&quot;</span>+result2.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="CircuitBreaker工具类">CircuitBreaker工具类</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircuitBreakerUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取熔断器状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> circuitBreaker</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getCircuitBreakerStatus</span><span class="params">(String time, CircuitBreaker circuitBreaker)</span></span>&#123;</span><br><span class="line">        CircuitBreaker.Metrics metrics = circuitBreaker.getMetrics();</span><br><span class="line">        <span class="comment">// 失败百分比</span></span><br><span class="line">        <span class="keyword">float</span> failureRate = metrics.getFailureRate();</span><br><span class="line">        <span class="comment">// 缓冲区大小</span></span><br><span class="line">        <span class="keyword">int</span> bufferedCalls = metrics.getNumberOfBufferedCalls();</span><br><span class="line">        <span class="comment">// 当前缓冲区失败调用数量</span></span><br><span class="line">        <span class="keyword">int</span> failedCalls = metrics.getNumberOfFailedCalls();</span><br><span class="line">        <span class="comment">// 当前缓冲区成功调用数量</span></span><br><span class="line">        <span class="keyword">int</span> successCalls = metrics.getNumberOfSuccessfulCalls();</span><br><span class="line">        <span class="comment">// 断路器打开和半打开拒绝请求的数量</span></span><br><span class="line">        <span class="keyword">long</span> notPermittedCalls = metrics.getNumberOfNotPermittedCalls();</span><br><span class="line"></span><br><span class="line">        System.out.println(time + <span class="string">&quot;state=&quot;</span> +circuitBreaker.getState() + <span class="string">&quot; , metrics[ failureRate=&quot;</span> + failureRate +</span><br><span class="line">                <span class="string">&quot;, bufferedCalls=&quot;</span> + bufferedCalls +</span><br><span class="line">                <span class="string">&quot;, failedCalls=&quot;</span> + failedCalls +</span><br><span class="line">                <span class="string">&quot;, successCalls=&quot;</span> + successCalls +</span><br><span class="line">                <span class="string">&quot;, notPermittedCalls=&quot;</span> + notPermittedCalls +</span><br><span class="line">                <span class="string">&quot; ]&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 监听熔断器事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addCircuitBreakerListener</span><span class="params">(CircuitBreaker circuitBreaker)</span></span>&#123;</span><br><span class="line">        circuitBreaker.getEventPublisher()</span><br><span class="line">                .onSuccess(event -&gt; System.out.println(<span class="string">&quot;服务调用成功：&quot;</span> + event.toString()))</span><br><span class="line">                .onError(event -&gt; System.out.println(<span class="string">&quot;服务调用失败：&quot;</span> + event.toString()))</span><br><span class="line">                .onIgnoredError(event -&gt; System.out.println(<span class="string">&quot;服务调用失败，但异常被忽略：&quot;</span> + event.toString()))</span><br><span class="line">                .onReset(event -&gt; System.out.println(<span class="string">&quot;熔断器重置：&quot;</span> + event.toString()))</span><br><span class="line">                .onStateTransition(event -&gt; System.out.println(<span class="string">&quot;熔断器状态改变：&quot;</span> + event.toString()))</span><br><span class="line">                .onCallNotPermitted(event -&gt;System.out.println(<span class="string">&quot; 熔断器已经打开：&quot;</span> + event.toString()))</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台打印</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210920214244811.png" alt="image-20210920214244811"></p>
<h4 id="AOP式调用CircuitBreaker">AOP式调用CircuitBreaker</h4>
<p>首先在连接器方法上使用**@CircuitBreaker(name=“”,fallbackMethod=“”)<strong>注解，其中</strong>name<strong>是要使用的熔断器的名称，<strong>fallbackMethod</strong>是要使用的降级方法，降级方法必须和原方法放在同一个类中，且降级方法的返回值需要和原方法相同，输入参数需要添加额外的</strong>exception**参数，类似这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RemoteServiceConnector&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@CircuitBreaker(name = &quot;backendA&quot;, fallbackMethod = &quot;fallBack&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">process</span><span class="params">()</span> <span class="keyword">throws</span> TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">        List&lt;User&gt; users;</span><br><span class="line">        users = remoteServic.process();</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;User&gt; <span class="title">fallBack</span><span class="params">(Throwable throwable)</span></span>&#123;</span><br><span class="line">        log.info(throwable.getLocalizedMessage() + <span class="string">&quot;,方法被降级了~~&quot;</span>);</span><br><span class="line">        CircuitBreakerUtil.getCircuitBreakerStatus(<span class="string">&quot;降级方法中:&quot;</span>, circuitBreakerRegistry.circuitBreaker(<span class="string">&quot;backendA&quot;</span>));</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;User&gt; <span class="title">fallBack</span><span class="params">(CallNotPermittedException e)</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;熔断器已经打开，拒绝访问被保护方法~&quot;</span>);</span><br><span class="line">        CircuitBreakerUtil.getCircuitBreakerStatus(<span class="string">&quot;熔断器打开中:&quot;</span>, circuitBreakerRegistry.circuitBreaker(<span class="string">&quot;backendA&quot;</span>));</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>实例测试代码</strong></p>
<ul>
<li><strong>provider接口</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: demo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: Resilience4J供应接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: xpp011</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2021-09-21 11:44</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/resilience4j&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Resilience4JController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/name/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;resilience4j&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>&#123;</span><br><span class="line">        user.setUsername(<span class="string">&quot;resilience4j&quot;</span>);</span><br><span class="line">        user.setPassword(<span class="string">&quot;SpringCloud-G版发布&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/math/&#123;num&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">mathematics</span><span class="params">(<span class="meta">@PathVariable(&quot;num&quot;)</span> Integer num)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>/num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/runtime&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runTime</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;允许时异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>OpenFeign接口</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CircuitBreaker的OpenFeign接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/resilience4j&quot;)</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;PROVIDER-APPLICATION&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CircuitBreakerApi</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/name/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/math/&#123;num&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">mathematics</span><span class="params">(<span class="meta">@PathVariable(&quot;num&quot;)</span> Integer num)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/runtime&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runTime</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>CircuitBreaker控制器</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: demo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: CircuitBreaker断路器控制器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: xpp011</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2021-09-21 11:55</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/circuitbreaker&quot;)</span></span><br><span class="line"><span class="meta">@CircuitBreaker(name = &quot;breakerA&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircuitBreakerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircuitBreakerApi circuitBreakerApi;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircuitBreakerRegistry circuitBreakerRegistry;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/error&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CircuitBreakerUtil.getCircuitBreakerStatus(<span class="string">&quot;异常调用前&quot;</span>,circuitBreakerRegistry.circuitBreaker(<span class="string">&quot;breakerA&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>==<span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        circuitBreakerApi.runTime();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/errorArithmeticException&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CircuitBreakerUtil.getCircuitBreakerStatus(<span class="string">&quot;异常调用前&quot;</span>,circuitBreakerRegistry.circuitBreaker(<span class="string">&quot;breakerA&quot;</span>));</span><br><span class="line"><span class="comment">//        if (1==1) throw new ArithmeticException();</span></span><br><span class="line">        circuitBreakerApi.mathematics(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;errorArithmeticException&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/ok&quot;)</span></span><br><span class="line">    <span class="comment">//注意服务进行服务降级时，算本次调用成功</span></span><br><span class="line">    <span class="meta">@CircuitBreaker(name = &quot;breakerA&quot;,fallbackMethod = &quot;test2Connect&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CircuitBreakerUtil.getCircuitBreakerStatus(<span class="string">&quot;正常调用前&quot;</span>,circuitBreakerRegistry.circuitBreaker(<span class="string">&quot;breakerA&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>==<span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        circuitBreakerApi.name(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test2Connect</span><span class="params">(RuntimeException e)</span></span>&#123;</span><br><span class="line">        System.out.println(e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;运行时异常请稍后再试&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test2Connect</span><span class="params">(CallNotPermittedException e)</span></span>&#123;</span><br><span class="line">        System.out.println(e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;断路器启动,服务暂不可访问，请稍后重试&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@CircuitBreaker(name = &quot;breakerB&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/start&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CircuitBreakerUtil.getCircuitBreakerStatus(<span class="string">&quot;状态&quot;</span>,circuitBreakerRegistry.circuitBreaker(<span class="string">&quot;breakerA&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>application.yml配置</strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5555</span></span><br><span class="line"><span class="comment">#port: 6666  端口6666被各大浏览器收录为不安全端口，请不要使用6666端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Resilience4J</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">appname:</span> <span class="string">Resilience4J</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:1111/eureka</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Resilience4J配置</span></span><br><span class="line"><span class="attr">resilience4j:</span></span><br><span class="line">  <span class="comment">#circuitbreaker配置</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="comment">#修改默认的配置</span></span><br><span class="line">    <span class="attr">configs:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="comment">#断路器失败阈值百分比</span></span><br><span class="line">        <span class="attr">failureRateThreshold:</span> <span class="number">50</span></span><br><span class="line">        <span class="comment">#超时请求阈值百分比</span></span><br><span class="line">        <span class="attr">slowCallRateThreshold:</span> <span class="number">70</span></span><br><span class="line">        <span class="comment">#超时时长阈值 3秒</span></span><br><span class="line">        <span class="attr">slowCallDurationThreshold:</span> <span class="number">3000</span></span><br><span class="line">        <span class="comment">#断路器half_open时允许调用的数量</span></span><br><span class="line">        <span class="attr">permittedNumberOfCallsInHalfOpenState:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment">#滑动窗口缓冲区类型</span></span><br><span class="line">        <span class="comment">#如果滑动窗口是COUNT_BASED，则记录并聚合最后的&#x27; slidingWindowSize &#x27;调用。</span></span><br><span class="line">        <span class="comment">#如果滑动窗口是TIME_BASED，则记录并聚合最后一个&#x27; slidingWindowSize &#x27;秒的调用。</span></span><br><span class="line">        <span class="attr">slidingWindowType:</span> <span class="string">COUNT_BASED</span></span><br><span class="line">        <span class="comment">#断路器关闭时记录通话结果的滑动窗口的大小</span></span><br><span class="line">        <span class="attr">slidingWindowSize:</span> <span class="number">5</span></span><br><span class="line">        <span class="comment">#在计算错误率或者计算慢速呼叫率最小呼叫数</span></span><br><span class="line">        <span class="attr">minimumNumberOfCalls:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment">#断路器由open状态到half_open状态需要的时间 6秒</span></span><br><span class="line">        <span class="attr">waitDurationInOpenState:</span> <span class="number">60000</span></span><br><span class="line">        <span class="comment">#true 开启一个线程监听CircuitBreakers的所有实例，一旦waitDurationInOpenState通过，就将它们转换到HALF_OPEN。</span></span><br><span class="line">        <span class="comment">#false 转换到HALF_OPEN只在调用时发生，即使在waitDurationInOpenState被传递之后。</span></span><br><span class="line">        <span class="attr">automaticTransitionFromOpenToHalfOpenEnabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="comment">#记录为失败的异常列表，从而增加失败率</span></span><br><span class="line">        <span class="comment">#注意指定失败异常列表那么只有符合该异常列表的异常才被计入失败,其他异常都算成功，除非被ignoreException忽略</span></span><br><span class="line">        <span class="attr">recordExceptions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">java.lang.ArithmeticException</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">feign.FeignException</span></span><br><span class="line">        <span class="comment">#忽略的异常列表，不计入失败</span></span><br><span class="line">        <span class="attr">ignoreException:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">java.lang.RuntimeException</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#创建配置实例</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="comment">#实例A 覆盖一些默认配置</span></span><br><span class="line">      <span class="attr">breakerA:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">minimumNumberOfCalls:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">waitDurationInOpenState:</span> <span class="number">2000</span></span><br><span class="line">        <span class="attr">permittedNumberOfCallsInHalfOpenState:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">breakerB:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>
<h4 id="总结-3">总结</h4>
<ul>
<li>
<p>失败率的计算必须等环装满才会计算</p>
</li>
<li>
<p>白名单优先级高于黑名单且白名单上的异常会被忽略，不会占用缓冲环位置，即不会计入失败率计算，<font color="red">但是会计入成功率计算(与文档不符，还需测验)</font></p>
</li>
<li>
<p>熔断器打开时同样会计算失败率，当状态转换为半开时重置为**-1**</p>
</li>
<li>
<p>只要出现异常都可以调用降级方法，不论是在白名单还是黑名单</p>
</li>
<li>
<p>熔断器的缓冲环有两个，一个关闭时的缓冲环，一个半打开时的缓冲环</p>
</li>
<li>
<p>熔断器关闭时，直至熔断器状态转换前所有请求都会通过，不会受到限制</p>
</li>
<li>
<p>熔断器半开时，限制请求数为缓冲环的大小，当调用次数满足<code>Half_Open</code>缓存环大小时，会根据失败率选择转换状态为<code>CLOSED</code>、<code>OPEN</code></p>
</li>
<li>
<p>熔断器从打开到半开的转换默认还需要请求进行触发，也可通过<strong>automaticTransitionFromOpenToHalfOpenEnabled=true</strong>设置为自动触发</p>
</li>
<li>
<p>服务降级成功后，会将本次调用计入成功率</p>
</li>
<li>
<p><strong>recordExceptions</strong>异常失败列表,<font color="red">注意指定失败异常列表那么只有符合该异常列表的异常才被计入失败,其他异常都算成功，除非被ignoreException忽略</font></p>
</li>
<li>
<p><strong>ignoreException</strong>忽略异常列表,出现该列表异常，那本次调用不会计入失败率(与文档不服还需测试)</p>
</li>
<li>
<p>滑动窗口含义为记录最新的<code>slidingWindowSize</code>次调用，并在此窗口内计算失败率</p>
</li>
</ul>
<h3 id="Ratelimiter">Ratelimiter</h3>
<h4 id="简介-6">简介</h4>
<p>速率限制是一项必不可少的技术，可让您的 API 为规模做好准备并建立服务的高可用性和可靠性。而且，该技术还提供了大量不同的选项，用于处理检测到的剩余限制，或者您想要限制的请求类型。您可以简单地拒绝此超限请求，或者构建一个队列以稍后执行它们，或者以某种方式将这两种方法结合起来。</p>
<p><font color="red">一般限速器在provider供应者服务内实现，方便预估限速调用次数,客户端实现无法预估集体调用数量</font></p>
<h4 id="可配置参数">可配置参数</h4>
<table>
<thead>
<tr>
<th>配置参数</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>timeoutDuration</td>
<td>5[s]</td>
<td>线程等待权限的默认等待时间</td>
</tr>
<tr>
<td>limitRefreshPeriod</td>
<td>500[ns]</td>
<td>权限刷新的时间，每个周期结束后，RateLimiter将会把权限计数设置为limitForPeriod的值</td>
</tr>
<tr>
<td>limitForPeriod</td>
<td>50</td>
<td>一个限制刷新期间的可用权限数</td>
</tr>
</tbody>
</table>
<h4 id="pom依赖">pom依赖</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.github.resilience4j/resilience4j-circuitbreaker --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-ratelimiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="java配置Ratelimiter">java配置Ratelimiter</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRateLimiter</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//以下配置含义  1秒内限制请求2个  被限制住的请求在2秒后过期不再发起请求</span></span><br><span class="line">    RateLimiterConfig config = RateLimiterConfig.custom()</span><br><span class="line">            <span class="comment">//超时持续时间</span></span><br><span class="line">            .timeoutDuration(Duration.ofMillis(<span class="number">2000</span>))</span><br><span class="line">            <span class="comment">//一个周期的时间</span></span><br><span class="line">            .limitRefreshPeriod(Duration.ofMillis(<span class="number">1000</span>))</span><br><span class="line">            <span class="comment">//一个周期可以用的权限数量</span></span><br><span class="line">            .limitForPeriod(<span class="number">2</span>)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    RateLimiter ratelimiterA = RateLimiter.of(<span class="string">&quot;ratelimiterA&quot;</span>, config);</span><br><span class="line">    CheckedRunnable checkedRunnable = RateLimiter.decorateCheckedRunnable(ratelimiterA, () -&gt; System.out.println(<span class="keyword">new</span> Date()));</span><br><span class="line"></span><br><span class="line">    RateLimiterUtil.getRateLimiterStatus(<span class="string">&quot;执行前&quot;</span>,ratelimiterA);</span><br><span class="line">    Try.run(checkedRunnable)</span><br><span class="line">            .andThenTry(checkedRunnable)</span><br><span class="line">            .andThenTry(checkedRunnable)</span><br><span class="line">            .andThenTry(checkedRunnable)</span><br><span class="line">            .andThenTry(checkedRunnable)</span><br><span class="line">    ;</span><br><span class="line">    RateLimiterUtil.getRateLimiterStatus(<span class="string">&quot;执行后&quot;</span>,ratelimiterA);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="RateLimiter工具类">RateLimiter工具类</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimiterUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 获取rateLimiter的状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getRateLimiterStatus</span><span class="params">(String time, RateLimiter rateLimiter)</span></span>&#123;</span><br><span class="line">        RateLimiter.Metrics metrics = rateLimiter.getMetrics();</span><br><span class="line">        <span class="comment">// 当前时间可以使用的权限数</span></span><br><span class="line">        <span class="keyword">int</span> availablePermissions =  metrics.getAvailablePermissions();</span><br><span class="line">        <span class="comment">// 等待的请求数量</span></span><br><span class="line">        <span class="keyword">int</span> numberOfWaitingThreads = metrics.getNumberOfWaitingThreads();</span><br><span class="line"></span><br><span class="line">        System.out.println(time  + <span class="string">&quot;, metrics[ availablePermissions=&quot;</span> + availablePermissions +</span><br><span class="line">                <span class="string">&quot;, numberOfWaitingThreads=&quot;</span> + numberOfWaitingThreads + <span class="string">&quot; ]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 监听rateLimiter事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addRateLimiterListener</span><span class="params">(RateLimiter rateLimiter)</span></span>&#123;</span><br><span class="line">        rateLimiter.getEventPublisher()</span><br><span class="line">                .onSuccess(event -&gt; System.out.println(event.toString()))</span><br><span class="line">                .onFailure(event -&gt; System.out.println(event.toString()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AOP式调用RateLimiter">AOP式调用RateLimiter</h4>
<p>API</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimiterApi</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RateLimiterRegistry rateLimiterRegistry;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircuitBreakerApi circuitBreakerApi;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RateLimiter(name = &quot;rateLimiterA&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        circuitBreakerApi.name(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        <span class="comment">//限速器</span></span><br><span class="line">        RateLimiterUtil.getRateLimiterStatus(<span class="keyword">new</span> Date().toString(),rateLimiterRegistry.rateLimiter(<span class="string">&quot;rateLimiterA&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pom.yml配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5555</span></span><br><span class="line"><span class="comment">#port: 6666  端口6666被各大浏览器收录为不安全端口，请不要使用6666端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Resilience4J</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">appname:</span> <span class="string">Resilience4J</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:1111/eureka</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Resilience4J配置</span></span><br><span class="line"><span class="attr">resilience4j:</span></span><br><span class="line">  <span class="comment">#ratelimiter限速器配置</span></span><br><span class="line">  <span class="attr">ratelimiter:</span></span><br><span class="line">    <span class="comment">#默认配置</span></span><br><span class="line">    <span class="attr">configs:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="comment">#限速请求在队列中等待时间</span></span><br><span class="line">        <span class="attr">timeoutDuration:</span> <span class="number">1000</span></span><br><span class="line">        <span class="comment">#一个周期的时间</span></span><br><span class="line">        <span class="attr">limitRefreshPeriod:</span> <span class="number">2000</span></span><br><span class="line">        <span class="comment">#一个周期可调用的权限数</span></span><br><span class="line">        <span class="attr">limitForPeriod:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="comment">#实例配置</span></span><br><span class="line">      <span class="attr">rateLimiterA:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">limitForPeriod:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h4 id="总结-4">总结</h4>
<ul>
<li><font color="red">超出周期权限的请求会被放在队列中等待下一次周期，但如果请求过期，那么将不会在下一周期中调用过期请求</font></li>
<li>限速器在provider供应商实现，方便预估调用次数</li>
</ul>
<h3 id="Retry">Retry</h3>
<h4 id="简介-7">简介</h4>
<p>同熔断器一样，重试组件也提供了注册器，可以通过注册器获取实例来进行重试，同样可以跟熔断器配合使用。</p>
<h4 id="创建和配置Retry">创建和配置Retry</h4>
<p>您可以提供自定义的全局 RetryConfig。为了创建自定义全局 RetryConfig，您可以使用 RetryConfig 构建器。您可以使用构建器进行配置：</p>
<ul>
<li>最大尝试次数</li>
<li>连续尝试之间的等待时间</li>
<li>自定义 IntervalBiFunction，它根据尝试次数和结果或异常计算失败后的等待间隔。</li>
<li>一个自定义谓词，用于评估某个响应是否应该触发重试尝试</li>
<li>一个自定义谓词，用于评估异常是否应触发重试尝试</li>
<li>应触发重试尝试的异常列表</li>
<li>应该被忽略并且不会触发重试尝试的异常列表</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">配置属性</th>
<th style="text-align:left">默认值</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">maxAttempts</td>
<td style="text-align:left">3</td>
<td style="text-align:left">最大尝试次数（包括首次调用作为第一次尝试）</td>
</tr>
<tr>
<td style="text-align:left">waitDuration</td>
<td style="text-align:left">500 [毫秒]</td>
<td style="text-align:left">重试尝试之间的固定等待时间</td>
</tr>
<tr>
<td style="text-align:left">intervalFunction</td>
<td style="text-align:left">numOfAttempts -&gt; waitDuration</td>
<td style="text-align:left">用来改变重试时间间隔，可以选择指数退避或者随机时间间隔</td>
</tr>
<tr>
<td style="text-align:left">intervalBiFunction</td>
<td style="text-align:left">(numOfAttempts, Each&lt;throwable, result&gt;) -&gt; waitDuration</td>
<td style="text-align:left">根据尝试次数和结果或异常修改失败后等待间隔的函数。与 intervalFunction 一起使用时会抛出 IllegalStateException。</td>
</tr>
<tr>
<td style="text-align:left">retryOnResultPredicate</td>
<td style="text-align:left">result -&gt; false</td>
<td style="text-align:left">配置一个 Predicate 来评估是否应该重试结果。如果应重试结果，则谓词必须返回true，否则必须返回false。</td>
</tr>
<tr>
<td style="text-align:left">retryExceptionPredicate</td>
<td style="text-align:left">throwable -&gt; true</td>
<td style="text-align:left">配置一个 Predicate 来评估是否应该重试异常。如果应重试异常，则谓词必须返回true，否则必须返回false。</td>
</tr>
<tr>
<td style="text-align:left">retryExceptions</td>
<td style="text-align:left">empty</td>
<td style="text-align:left">需要重试的异常列表</td>
</tr>
<tr>
<td style="text-align:left">ignoreExceptions</td>
<td style="text-align:left">empty</td>
<td style="text-align:left">需要忽略的异常列表</td>
</tr>
<tr>
<td style="text-align:left">failAfterMaxRetries</td>
<td style="text-align:left">false</td>
<td style="text-align:left">当重试达到配置的 maxAttempts 并且结果仍未通过 retryOnResultPredicate 时启用或禁用抛出 MaxRetriesExceededException 的布尔值</td>
</tr>
</tbody>
</table>
<h4 id="pom依赖-2">pom依赖</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.resilience4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resilience4j-retry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Java配置Retry">Java配置Retry</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRetry</span><span class="params">()</span></span>&#123;</span><br><span class="line">    RetryConfig build = RetryConfig.custom()</span><br><span class="line">            <span class="comment">//最大重试次数</span></span><br><span class="line">            .maxAttempts(<span class="number">5</span>)</span><br><span class="line">            <span class="comment">//重试间隔</span></span><br><span class="line">            .waitDuration(Duration.ofMillis(<span class="number">1000</span>))</span><br><span class="line">            <span class="comment">//重试异常</span></span><br><span class="line">            .retryOnException(e -&gt; e <span class="keyword">instanceof</span> RuntimeException)</span><br><span class="line">            <span class="comment">//需要重试的异常列表</span></span><br><span class="line">            .retryExceptions(IOException.class, TimeoutException.class)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">//获取配置</span></span><br><span class="line">    Retry retry = Retry.of(<span class="string">&quot;retry&quot;</span>, build);</span><br><span class="line">    CheckedRunnable checkedRunnable = Retry.decorateCheckedRunnable(retry, <span class="keyword">new</span> CheckedRunnable() &#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="comment">//重试3次后不再抛异常</span></span><br><span class="line">            <span class="keyword">while</span> (count++ &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                System.out.println(count);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Void unused = Try.run(checkedRunnable).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Retry工具类">Retry工具类</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: demo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: Retry工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: xpp011</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2021-09-20 23:30</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 获取重试的状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getRetryStatus</span><span class="params">(String time, Retry retry)</span></span>&#123;</span><br><span class="line">        Retry.Metrics metrics = retry.getMetrics();</span><br><span class="line">        <span class="keyword">long</span> failedRetryNum = metrics.getNumberOfFailedCallsWithRetryAttempt();</span><br><span class="line">        <span class="keyword">long</span> failedNotRetryNum = metrics.getNumberOfFailedCallsWithoutRetryAttempt();</span><br><span class="line">        <span class="keyword">long</span> successfulRetryNum = metrics.getNumberOfSuccessfulCallsWithRetryAttempt();</span><br><span class="line">        <span class="keyword">long</span> successfulNotyRetryNum = metrics.getNumberOfSuccessfulCallsWithoutRetryAttempt();</span><br><span class="line"></span><br><span class="line">        System.out.println(time + <span class="string">&quot;state=&quot;</span> + <span class="string">&quot; metrics[ failedRetryNum=&quot;</span> + failedRetryNum +</span><br><span class="line">                <span class="string">&quot;, failedNotRetryNum=&quot;</span> + failedNotRetryNum +</span><br><span class="line">                <span class="string">&quot;, successfulRetryNum=&quot;</span> + successfulRetryNum +</span><br><span class="line">                <span class="string">&quot;, successfulNotyRetryNum=&quot;</span> + successfulNotyRetryNum +</span><br><span class="line">                <span class="string">&quot; ]&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 监听重试事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addRetryListener</span><span class="params">(Retry retry)</span></span>&#123;</span><br><span class="line">        retry.getEventPublisher()</span><br><span class="line">                .onSuccess(event -&gt; System.out.println(<span class="string">&quot;服务调用成功：&quot;</span> + event.toString()))</span><br><span class="line">                .onError(event -&gt; System.out.println(<span class="string">&quot;服务调用失败：&quot;</span> + event.toString()))</span><br><span class="line">                .onIgnoredError(event -&gt; System.out.println(<span class="string">&quot;服务调用失败，但异常被忽略：&quot;</span> + event.toString()))</span><br><span class="line">                .onRetry(event -&gt; System.out.println(<span class="string">&quot;重试：第&quot;</span> + event.getNumberOfRetryAttempts() + <span class="string">&quot;次&quot;</span>))</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>控制台</p>
<p><img src="/.cn//D:%5Cwin10%E6%A1%8C%E9%9D%A2%E5%AD%98%E6%94%BE%5CSpringCloud%5C%E7%AC%94%E8%AE%B0%5CSpringCloud.assets%5Cimage-20210920233734739.png" alt="image-20210920233734739"></p>
<p><font color="red">可以看到只要没有超过最大重试次数时调用成功，那么整个方法就是成功的</font></p>
<h4 id="AOP式调用ReTry">AOP式调用ReTry</h4>
<p><strong>实际测试代码</strong></p>
<h4 id="ReTry控制器">ReTry控制器</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: demo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: ReTry控制器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: xpp011</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2021-09-22 22:47</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/retry&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReTreyController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> cut=<span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CircuitBreakerApi circuitBreakerApi;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CircuitBreaker(name = &quot;breakerA&quot;)</span></span><br><span class="line">    <span class="meta">@Retry(name = &quot;retryA&quot;,fallbackMethod = &quot;testRetryError&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testRetry&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testRetry</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Date()+<span class="string">&quot;:&quot;</span>+cut);</span><br><span class="line">        <span class="comment">//Integer mathematics = circuitBreakerApi.mathematics(0);</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span>==<span class="number">1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArithmeticException(<span class="string">&quot;异常测试&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;调用成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testRetryError</span><span class="params">(Throwable t)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t.getMessage()+<span class="string">&quot;方法降级了&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testRetryError</span><span class="params">(CallNotPermittedException c)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c.getMessage()+<span class="string">&quot;断路器已打开&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ReTry工具类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReTryUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 获取重试的状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getRetryStatus</span><span class="params">(String time, Retry retry)</span></span>&#123;</span><br><span class="line">        Retry.Metrics metrics = retry.getMetrics();</span><br><span class="line">        <span class="keyword">long</span> failedRetryNum = metrics.getNumberOfFailedCallsWithRetryAttempt();</span><br><span class="line">        <span class="keyword">long</span> failedNotRetryNum = metrics.getNumberOfFailedCallsWithoutRetryAttempt();</span><br><span class="line">        <span class="keyword">long</span> successfulRetryNum = metrics.getNumberOfSuccessfulCallsWithRetryAttempt();</span><br><span class="line">        <span class="keyword">long</span> successfulNotyRetryNum = metrics.getNumberOfSuccessfulCallsWithoutRetryAttempt();</span><br><span class="line"></span><br><span class="line">        System.out.println(time + <span class="string">&quot;state=&quot;</span> + <span class="string">&quot; metrics[ failedRetryNum=&quot;</span> + failedRetryNum +</span><br><span class="line">                <span class="string">&quot;, failedNotRetryNum=&quot;</span> + failedNotRetryNum +</span><br><span class="line">                <span class="string">&quot;, successfulRetryNum=&quot;</span> + successfulRetryNum +</span><br><span class="line">                <span class="string">&quot;, successfulNotyRetryNum=&quot;</span> + successfulNotyRetryNum +</span><br><span class="line">                <span class="string">&quot; ]&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 监听重试事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addRetryListener</span><span class="params">(Retry retry)</span></span>&#123;</span><br><span class="line">        retry.getEventPublisher()</span><br><span class="line">                .onSuccess(event -&gt; System.out.println(<span class="string">&quot;服务调用成功：&quot;</span> + event.toString()))</span><br><span class="line">                .onError(event -&gt; System.out.println(<span class="string">&quot;服务调用失败：&quot;</span> + event.toString()))</span><br><span class="line">                .onIgnoredError(event -&gt; System.out.println(<span class="string">&quot;服务调用失败，但异常被忽略：&quot;</span> + event.toString()))</span><br><span class="line">                .onRetry(event -&gt; System.out.println(<span class="string">&quot;重试：第&quot;</span> + event.getNumberOfRetryAttempts() + <span class="string">&quot;次&quot;</span>))</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>application.yml配置信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5555</span></span><br><span class="line"><span class="comment">#port: 6666  端口6666被各大浏览器收录为不安全端口，请不要使用6666端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Resilience4J</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">appname:</span> <span class="string">Resilience4J</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:1111/eureka</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Resilience4J配置</span></span><br><span class="line"><span class="attr">resilience4j:</span></span><br><span class="line">  <span class="attr">retry:</span></span><br><span class="line">    <span class="attr">configs:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="comment">#最大尝试重试次数</span></span><br><span class="line">        <span class="attr">maxAttempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="comment">#每一次重试的间隔时间</span></span><br><span class="line">        <span class="attr">waitDuration:</span> <span class="number">500</span></span><br><span class="line">        <span class="comment">#需要重试的异常列表</span></span><br><span class="line">        <span class="attr">retryExceptions:</span></span><br><span class="line">        <span class="comment">#忽略重试的异常列表</span></span><br><span class="line">        <span class="attr">ignoreExceptions:</span></span><br><span class="line">          <span class="comment">#当断路器打开时应当放弃重试</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">io.github.resilience4j.circuitbreaker.CallNotPermittedException</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="attr">retryA:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">maxAttempts:</span> <span class="number">4</span></span><br><span class="line">        <span class="attr">waitDuration:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>
<h4 id="总结-5">总结</h4>
<ul>
<li>当断路器注解<code>@CircuitBreaker</code>和重试器<code>@Retry</code>一起使用时，每一次重试请求都会被断路器记录,</li>
<li>服务降级只会在重试失败后调用</li>
<li>调用服务降级后，会被断路器计入成功率</li>
</ul>
<h3 id="Resilience4j配置文件">Resilience4j配置文件</h3>
<p>注意当如果<strong>Retry</strong>、<strong>CircuitBreaker</strong>、<strong>RateLimiter</strong>同时注解在方法上，默认的顺序是<strong>Retry&gt;CircuitBreaker&gt;RateLimiter</strong>，<font color="red">即先控制并发再限流然后熔断最后重试</font></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5555</span></span><br><span class="line"><span class="comment">#port: 6666  端口6666被各大浏览器收录为不安全端口，请不要使用6666端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Resilience4J</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">appname:</span> <span class="string">Resilience4J</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:1111/eureka</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Resilience4J配置</span></span><br><span class="line"><span class="attr">resilience4j:</span></span><br><span class="line">  <span class="comment">#circuitbreaker断路器配置</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="comment">#修改默认的配置</span></span><br><span class="line">    <span class="attr">configs:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="comment">#断路器失败阈值百分比</span></span><br><span class="line">        <span class="attr">failureRateThreshold:</span> <span class="number">50</span></span><br><span class="line">        <span class="comment">#超时请求阈值百分比</span></span><br><span class="line">        <span class="attr">slowCallRateThreshold:</span> <span class="number">70</span></span><br><span class="line">        <span class="comment">#超时时长阈值 3秒</span></span><br><span class="line">        <span class="attr">slowCallDurationThreshold:</span> <span class="number">3000</span></span><br><span class="line">        <span class="comment">#断路器half_open时允许调用的数量</span></span><br><span class="line">        <span class="attr">permittedNumberOfCallsInHalfOpenState:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment">#滑动窗口缓冲区类型</span></span><br><span class="line">        <span class="comment">#如果滑动窗口是COUNT_BASED，则记录并聚合最后的&#x27; slidingWindowSize &#x27;调用。</span></span><br><span class="line">        <span class="comment">#如果滑动窗口是TIME_BASED，则记录并聚合最后一个&#x27; slidingWindowSize &#x27;秒的调用。</span></span><br><span class="line">        <span class="attr">slidingWindowType:</span> <span class="string">COUNT_BASED</span></span><br><span class="line">        <span class="comment">#断路器关闭时记录通话结果的滑动窗口的大小</span></span><br><span class="line">        <span class="attr">slidingWindowSize:</span> <span class="number">5</span></span><br><span class="line">        <span class="comment">#在计算错误率或者计算慢速呼叫率最小呼叫数</span></span><br><span class="line">        <span class="attr">minimumNumberOfCalls:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment">#断路器由open状态到half_open状态需要的时间 6秒</span></span><br><span class="line">        <span class="attr">waitDurationInOpenState:</span> <span class="number">60000</span></span><br><span class="line">        <span class="comment">#true 开启一个线程监听CircuitBreakers的所有实例，一旦waitDurationInOpenState通过，就将它们转换到HALF_OPEN。</span></span><br><span class="line">        <span class="comment">#false 转换到HALF_OPEN只在调用时发生，即使在waitDurationInOpenState被传递之后。</span></span><br><span class="line">        <span class="attr">automaticTransitionFromOpenToHalfOpenEnabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="comment">#记录为失败的异常列表，从而增加失败率</span></span><br><span class="line">        <span class="comment">#注意指定失败异常列表那么只有符合该异常列表的异常才被计入失败,其他异常都算成功，除非被ignoreException忽略</span></span><br><span class="line">        <span class="attr">recordExceptions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">java.lang.ArithmeticException</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">feign.FeignException</span></span><br><span class="line">        <span class="comment">#忽略的异常列表，不计入失败</span></span><br><span class="line">        <span class="attr">ignoreException:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">java.lang.RuntimeException</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#创建配置实例</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="comment">#实例A 覆盖一些默认配置</span></span><br><span class="line">      <span class="attr">breakerA:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">minimumNumberOfCalls:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">waitDurationInOpenState:</span> <span class="number">20000</span></span><br><span class="line">        <span class="attr">permittedNumberOfCallsInHalfOpenState:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">breakerB:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#retry重试器配置</span></span><br><span class="line">  <span class="attr">retry:</span></span><br><span class="line">    <span class="attr">configs:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="comment">#最大尝试重试次数</span></span><br><span class="line">        <span class="attr">maxAttempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="comment">#每一次重试的间隔时间</span></span><br><span class="line">        <span class="attr">waitDuration:</span> <span class="number">500</span></span><br><span class="line">        <span class="comment">#需要重试的异常列表</span></span><br><span class="line">        <span class="attr">retryExceptions:</span></span><br><span class="line">        <span class="comment">#忽略重试的异常列表</span></span><br><span class="line">        <span class="attr">ignoreExceptions:</span></span><br><span class="line">          <span class="comment">#当断路器打开时应当放弃重试</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">io.github.resilience4j.circuitbreaker.CallNotPermittedException</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="attr">retryA:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">maxAttempts:</span> <span class="number">4</span></span><br><span class="line">        <span class="attr">waitDuration:</span> <span class="number">3000</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#ratelimiter限速器配置</span></span><br><span class="line">  <span class="attr">ratelimiter:</span></span><br><span class="line">    <span class="comment">#默认配置</span></span><br><span class="line">    <span class="attr">configs:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="comment">#限速请求在队列中等待时间</span></span><br><span class="line">        <span class="attr">timeoutDuration:</span> <span class="number">1000</span></span><br><span class="line">        <span class="comment">#一个周期的时间</span></span><br><span class="line">        <span class="attr">limitRefreshPeriod:</span> <span class="number">2000</span></span><br><span class="line">        <span class="comment">#一个周期可调用的权限数</span></span><br><span class="line">        <span class="attr">limitForPeriod:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="comment">#实例配置</span></span><br><span class="line">      <span class="attr">rateLimiterA:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">limitForPeriod:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h2 id="十，服务监控">十，服务监控</h2>
<p>在微服务中，由于服务数量众多，那么服务出现故障的几率也会非常大，那么维护这些服务就成了至关重要的事情了，服务监控也就成了必然的事情了</p>
<p>服务监控部分不再赘述</p>
<p>这里直接看健康信息可视化工具</p>
<h3 id="Prometheus">Prometheus</h3>
<p>官网文档:<a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/first_steps/">https://prometheus.io/docs/introduction/first_steps/</a></p>
<h4 id="简单安装">简单安装</h4>
<p>下载Linux版的Prometheus后</p>
<p><strong>解压</strong></p>
<blockquote>
<p>tar -zxvf  prometheus-X.X.X.tar</p>
</blockquote>
<p><strong>进入工作目录</strong></p>
<blockquote>
<p>cd prometheus-2.30.1.linux-amd64/</p>
</blockquote>
<p><strong>修改<code>prometheus.yml</code>配置文件</strong></p>
<p><font color="red">注意，返回服务信息的URL所返回的数据必须是</font><code>Protobuf</code><font color="red">格式</font></p>
<p>文档地址: <code>https://prometheus.io/docs/instrumenting/exposition_formats/</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span> <span class="comment"># 拉取服务信息间隔</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># 每15秒评估规则一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alertmanager configuration</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="comment"># - alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - &quot;first_rules.yml&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;second_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it&#x27;s Prometheus itself.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># 监听的服务标签</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;prometheus&quot;</span></span><br><span class="line">    <span class="comment">#拉取服务信息的URL</span></span><br><span class="line">    <span class="comment">#该接口返回的数据必须是 Protobuf 文档连接地址https://prometheus.io/docs/instrumenting/exposition_formats/</span></span><br><span class="line">    <span class="comment">#该接口返回的数据必须是 Protobuf</span></span><br><span class="line">    <span class="comment">#该接口返回的数据必须是 Protobuf</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">&#x27;/actuator/prometheus&#x27;</span></span><br><span class="line">    <span class="comment"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class="line">    <span class="comment">#拉取信息间隔</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="comment">#监听的服务地址</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;192.168.32.1:8080&quot;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>启动Prometheus</strong></p>
<blockquote>
<p>./prometheus --config.file=prometheus.yml</p>
</blockquote>
<p><strong>监控服务配置</strong></p>
<p>引入prometheus依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.micrometer/micrometer-registry-prometheus --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>简单配置依赖</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="comment">#暴露所有端口</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="comment">#health任何时候可见</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">show-components:</span> <span class="string">always</span></span><br><span class="line">    <span class="comment">#prometheus普罗米修斯开启</span></span><br><span class="line">    <span class="attr">prometheus:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#开启metrics</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment">#开启普罗米修斯检测</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="attr">export:</span></span><br><span class="line">      <span class="attr">prometheus:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="Security配置">Security配置</h4>
<p>如果你的项目配置了<code>SpringSecurity</code>，请开放接口<code>/actuator/prometheus</code>的权限</p>
<p><strong>访问地址</strong></p>
<blockquote>
<p>prometheusIP:9090</p>
</blockquote>
<h3 id="Grafana">Grafana</h3>
<p>官网地址: <a target="_blank" rel="noopener" href="https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1&amp;platform=docker">https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1&amp;platform=docker</a></p>
<p>文档地址: <a target="_blank" rel="noopener" href="https://grafana.com/docs/grafana/latest/basics/">https://grafana.com/docs/grafana/latest/basics/</a></p>
<h4 id="Docker安装">Docker安装</h4>
<p>基于ubuntu镜像</p>
<blockquote>
<p>docker run -d --name=grafana -p 3000:3000 grafana/grafana-enterprise:8.1.5-ubuntu</p>
</blockquote>
<h4 id="添加Prometheus数据源">添加Prometheus数据源</h4>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211002203840220.png" alt="image-20211002203840220"></p>
<h4 id="添加仪表盘">添加仪表盘</h4>
<p>点击红框设置仪表盘展示信息</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211002222438403.png" alt="hongkuang"></p>
<p>在输入框填写<code>Prometheus</code>Sql语句即可将服务信息以图形化方式展示出来</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211002222617485.png" alt="image-20211002222617485"></p>
<h2 id="十一，服务网关">十一，服务网关</h2>
<p>Zuul已经闭源，这里不做描述</p>
<h3 id="网关简介">网关简介</h3>
<h4 id="一、什么是服务网关">一、什么是服务网关</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务网关 = 路由转发 + 过滤器</span><br></pre></td></tr></table></figure>
<p>1、路由转发：接收一切外界请求，转发到后端的微服务上去；</p>
<p>2、过滤器：在服务网关中可以完成一系列的横切功能，例如权限校验、限流以及监控等，这些都可以通过过滤器完成（其实路由转发也是通过过滤器实现的）。</p>
<h4 id="二、为什么需要服务网关">二、为什么需要服务网关</h4>
<p>上述所说的横切功能（以权限校验为例）可以写在三个位置：</p>
<ul>
<li>每个服务自己实现一遍</li>
<li>写到一个公共的服务中，然后其他所有服务都依赖这个服务</li>
<li>写到服务网关的前置过滤器中，所有请求过来进行权限校验</li>
</ul>
<p>第一种，缺点太明显，基本不用；第二种，相较于第一点好很多，代码开发不会冗余，但是有两个缺点：</p>
<ul>
<li>由于每个服务引入了这个公共服务，那么相当于在每个服务中都引入了相同的权限校验的代码，使得每个服务的jar包大小无故增加了一些，尤其是对于使用docker镜像进行部署的场景，jar越小越好；</li>
<li>由于每个服务都引入了这个公共服务，那么我们后续升级这个服务可能就比较困难，而且公共服务的功能越多，升级就越难，而且假设我们改变了公共服务中的权限校验的方式，想让所有的服务都去使用新的权限校验方式，我们就需要将之前所有的服务都重新引包，编译部署。</li>
</ul>
<p>而服务网关恰好可以解决这样的问题：</p>
<ul>
<li>将权限校验的逻辑写在网关的过滤器中，后端服务不需要关注权限校验的代码，所以服务的jar包中也不会引入权限校验的逻辑，不会增加jar包大小；</li>
<li>如果想修改权限校验的逻辑，只需要修改网关中的权限校验过滤器即可，而不需要升级所有已存在的微服务。</li>
</ul>
<p>所以，需要服务网关！！！</p>
<h4 id="三、服务网关技术选型">三、服务网关技术选型</h4>
<p><img src="https://pic1.zhimg.com/80/v2-7032af539f437112f77049540c43a4d4_720w.jpg" alt="img"></p>
<p>引入服务网关后的微服务架构如上，总体包含三部分：服务网关、open-service和service。</p>
<h5 id="1、总体流程">1、总体流程</h5>
<ul>
<li>服务网关、open-service和service启动时注册到注册中心上去；</li>
<li>用户请求时直接请求网关，网关做智能路由转发（包括服务发现，负载均衡）到open-service，这其中包含权限校验、监控、限流等操作</li>
<li>open-service聚合内部service响应，返回给网关，网关再返回给用户</li>
</ul>
<h5 id="2、引入网关的注意点">2、引入网关的注意点</h5>
<ul>
<li>增加了网关，多了一层转发（原本用户请求直接访问open-service即可），性能会下降一些（但是下降不大，通常，网关机器性能会很好，而且网关与open-service的访问通常是内网访问，速度很快）；</li>
<li>网关的单点问题：在整个网络调用过程中，一定会有一个单点，可能是网关、nginx、dns服务器等。防止网关单点，可以在网关层前边再挂一台nginx，nginx的性能极高，基本不会挂，这样之后，网关服务就可以不断的添加机器。但是这样一个请求就转发了两次，所以最好的方式是网关单点服务部署在一台牛逼的机器上（通过压测来估算机器的配置），而且nginx与zuul的性能比较，根据国外的一个哥们儿做的实验来看，其实相差不大，zuul是netflix开源的一个用来做网关的开源框架；</li>
<li>网关要尽量轻。</li>
</ul>
<h5 id="3、服务网关基本功能">3、服务网关基本功能</h5>
<ul>
<li>
<p>智能路由：接收外部一切请求，并转发到后端的对外服务open-service上去；</p>
</li>
<li>
<ul>
<li>注意：我们只转发外部请求，服务之间的请求不走网关，这就表示全链路追踪、内部服务API监控、内部服务之间调用的容错、智能路由不能在网关完成；当然，也可以将所有的服务调用都走网关，那么几乎所有的功能都可以集成到网关中，但是这样的话，网关的压力会很大，不堪重负。</li>
</ul>
</li>
<li>
<p>权限校验：只校验用户向open-service服务的请求，不校验服务内部的请求。服务内部的请求有必要校验吗？</p>
</li>
<li>
<p>API监控：只监控经过网关的请求，以及网关本身的一些性能指标（例如，gc等）；</p>
</li>
<li>
<p>限流：与监控配合，进行限流操作；</p>
</li>
<li>
<p>API日志统一收集：类似于一个aspect切面，记录接口的进入和出去时的相关日志</p>
</li>
<li>
<p>。。。后续补充</p>
</li>
</ul>
<p>上述功能是网关的基本功能，网关还可以实现以下功能：</p>
<ul>
<li>A|B测试：A|B测试时一块比较大的东西，包含后台实验配置、数据埋点（看转化率）以及分流引擎，在服务网关中，可以实现分流引擎，但是实际上分流引擎会调用内部服务，所以如果是按照上图的架构，分流引擎最好做在open-service中，不要做在服务网关中。</li>
<li>。。。后续补充</li>
</ul>
<h3 id="Gateway">Gateway</h3>
<p>文档地址:<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/</a></p>
<h4 id="简介-8">简介</h4>
<blockquote>
<p>Spring Cloud Gateway是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。</p>
</blockquote>
<h4 id="优点">优点</h4>
<p>​	Spring Cloud Gateway 可以看做是一个 Zuul 1.x 的升级版和代替品，比 Zuul 2 更早的使用 Netty 实现异步 IO，从而实现了一个简单、比 Zuul 1.x 更高效的、与 Spring Cloud 紧密配合的 API 网关。<br>
​	Spring Cloud Gateway 里明确的区分了 Router 和 Filter，并且一个很大的特点是内置了非常多的开箱即用功能，并且都可以通过 SpringBoot 配置或者手工编码链式调用来使用。<br>
​	比如内置了 10 种 Router，使得我们可以直接配置一下就可以随心所欲的根据 Header、或者 Path、或者 Host、或者 Query 来做路由。<br>
​	比如区分了一般的 Filter 和全局 Filter，内置了 20 种 Filter 和 9 种全局 Filter，也都可以直接用。当然自定义 Filter 也非常方便。</p>
<p><strong>最重要的几个概念</strong></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cDovL2Nvcy5yYWluMTAyNC5jb20vbWFya2Rvd24vaW1hZ2UtMjAxOTEwMDgxNjA3MTM4MjIucG5n?x-oss-process=image/format,png" alt="img"></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cDovL2Nvcy5yYWluMTAyNC5jb20vbWFya2Rvd24vaW1hZ2UtMjAxOTEwMDgxNjA4MDkxNDYucG5n?x-oss-process=image/format,png" alt="img"></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cDovL2Nvcy5yYWluMTAyNC5jb20vbWFya2Rvd24vaW1hZ2UtMjAxOTEwMDgxNjA4MjU3MzEucG5n?x-oss-process=image/format,png" alt="img"></p>
<h4 id="RouteProperties匹配">RouteProperties匹配</h4>
<h5 id="时间匹配">时间匹配</h5>
<p>Predicate 支持设置一个时间，在请求进行转发的时候，可以通过判断在这个时间之前或者之后进行转发。比如我们现在设置只有在 2021年 9 月 20 日才会转发到我的网站，在这之前不进行转发，我就可以这样配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after-router</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">After=2021-09-20T06:06:06+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
<p>Spring 是通过 ZonedDateTime 来对时间进行的对比，ZonedDateTime 是 Java 8 中日期时间功能里，用于表示带时区的日期与时间信息的类，ZonedDateTime 支持通过时区来设置时间，中国的时区是：Asia/Shanghai。</p>
<p>After Route Predicate 是指在这个时间之后的请求都转发到目标地址。上面的示例是指，请求时间在 2021年 9 月 20 日 6 点 6 分 6 秒之后的所有请求都转发到地址http://ityouknow.com。+08:00是指时间和 UTC 时间相差八个小时，时间地区为Asia/Shanghai。</p>
<p>添加完路由规则之后，访问地址http://localhost:8080会自动转发到http://httpbin.org。注意这里的转发只能转发到指定某个服务或者URL上，而不能转发到服务上某个具体的请求，比如:<a target="_blank" rel="noopener" href="http://httpbin.org/get%E6%98%AF%E4%B8%8D%E5%8F%AF%E8%A1%8C%E7%9A%84%E3%80%82">http://httpbin.org/get是不可行的。</a></p>
<p>Before Route Predicate 刚好相反，在某个时间之前的请求的请求都进行转发。我们把上面路由规则中的 After 改为 Before，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">Before-router</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Before=2021-10-20T06:06:06+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
<p>就表示在这个时间之前可以进行路由，在这时间之后停止路由，修改完之后重启项目再次访问地址http://localhost:8080，页面会报 404 没有找到地址。</p>
<p>除过在时间之前或者之后外，Gateway 还支持限制路由请求在某一个时间段范围内，可以使用 Between Route Predicate 来实现。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#        匹配两个具体时间之间的请求</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">Between-router</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Between=2021-10-04T21:42:06+08:00[Asia/Shanghai],2021-10-20T06:06:06+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
<p>这样设置就意味着在这个时间段内可以匹配到此路由，超过这个时间段范围则不会进行匹配。通过时间匹配路由的功能很酷，可以用在限时抢购的一些场景中。</p>
<h5 id="Cookie匹配">Cookie匹配</h5>
<p>Cookie Route Predicate 可以接收两个参数，一个是 Cookie name , 一个是正则表达式，路由规则会通过获取对应的 Cookie name 值和正则表达式去匹配，如果匹配上就会执行路由，如果没有匹配上则不执行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#       根据Cookie的name以及value的正则进行匹配</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cookie_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Cookie=Gateway,coo[A-Za-z]+</span></span><br></pre></td></tr></table></figure>
<p>以上符合配置的Cookie为</p>
<blockquote>
<p>name: Gateway</p>
<p>value:  coo开头的值</p>
</blockquote>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211004215809123.png" alt="image-20211004215809123"></p>
<p>Header Route Predicate 和 Cookie Route Predicate 一样，也是接收 2 个参数，一个 header 中属性名称和一个正则表达式，这个属性值和正则表达式匹配则执行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#       根据请求头匹配名称为X-Request-Id ,value和表达式\d+匹配</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">header-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br></pre></td></tr></table></figure>
<p>我们在Fiddler中拦截<code>localhost:8080/get</code>的请求，为其添加请求头，就可以发现请求成功</p>
<blockquote>
<p>X-Request-Id：123</p>
</blockquote>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211004221257312.png" alt="image-20211004221257312"></p>
<h5 id="Host匹配">Host匹配</h5>
<p>Host Route Predicate 接收一组参数，一组匹配的域名列表，这个模板是一个 ant 分隔的模板，用<code>.</code>号作为分隔符。它通过参数中的主机地址作为匹配规则。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#       根据请求头中的host字段匹配</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">host-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Host=*.org</span></span><br></pre></td></tr></table></figure>
<p>使用 curl 测试，命令行输入:</p>
<blockquote>
<p>curl <a target="_blank" rel="noopener" href="http://localhost:8080">http://localhost:8080</a>  -H “Host: <a target="_blank" rel="noopener" href="http://www.ityouknow.org">www.ityouknow.org</a>”<br>
curl <a target="_blank" rel="noopener" href="http://localhost:8080">http://localhost:8080</a>  -H “Host: <a target="_blank" rel="noopener" href="http://md.ityouknow.org">md.ityouknow.org</a>”</p>
</blockquote>
<p>经测试以上两种 host 均可匹配到 host_route 路由，去掉 host 参数则会报 404 错误。</p>
<h5 id="通过请求方式匹配">通过请求方式匹配</h5>
<p>可以通过是 POST、GET、PUT、DELETE 等不同的请求方式来进行路由。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#       根据请求方法</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">method-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET,POST</span></span><br></pre></td></tr></table></figure>
<p>通过不同的请求方式可以看到，<code>GET</code>可以通过请求，而<code>PUT</code>请求直接404</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211004223328304.png" alt="image-20211004223328304"></p>
<h5 id="通过请求路径匹配">通过请求路径匹配</h5>
<p>Path Route Predicate 接收一个匹配路径的参数来判断是否走路由。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#       根据请求路径匹配</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">path-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/get/**,/basic-auth/&#123;user&#125;/&#123;passwd&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="通过请求参数匹配">通过请求参数匹配</h5>
<p>Query Route Predicate 支持传入两个参数，一个是属性名一个为属性值，属性值可以是正则表达式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#       根据请求参数匹配</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">query-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Query=name,zhang[A-Za-z]+</span></span><br></pre></td></tr></table></figure>
<p>以下URL可以匹配成功</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/get/?name=zhanhsk">localhost:8080/get/?name=zhanhsk</a></p>
</blockquote>
<h5 id="通过请求-ip-地址进行匹配">通过请求 ip 地址进行匹配</h5>
<p>Predicate 也支持通过设置某个 ip 区间号段的请求才会路由，RemoteAddr Route Predicate 接受 cidr 符号 (IPv4 或 IPv6) 字符串的列表(最小大小为 1)，例如 192.168.0.1/16 (其中 192.168.0.1 是 IP 地址，16 是子网掩码)。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#       根据请求ip匹配</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">remoteaddr_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RemoteAddr=192.168.1.5/24</span></span><br></pre></td></tr></table></figure>
<h5 id="权重路由匹配">权重路由匹配</h5>
<p>该<code>Weight</code>有两个参数：<code>group</code>和<code>weight</code>（一个int）。权重是按组计算的。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#       根据权重匹配</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_high</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">8</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_low</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>该路由会将约 80% 的流量转发到http://httpbin.org，将约 20% 的流量<a target="_blank" rel="noopener" href="https://weighlow.org/">转发</a>到https://example.org</p>
<h4 id="结合Eureka注册中心">结合Eureka注册中心</h4>
<p><strong>引入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>yaml配置文件</strong></p>
<p>注意<code>Gateway</code>和<code>注册中心</code>整合时，<font color="red">务必开启注册中心客户端代理</font><code>spring.cloud.gateway.discovery,enabled=true</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment">#启动注册中心客户端代理</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#前往注册中心注册</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1111/eureka</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">4444</span></span><br></pre></td></tr></table></figure>
<p><strong>检查Eureka注册中心上的服务</strong></p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211004234409248.png" alt="image-20211004234409248"></p>
<p><strong>访问注册中心上的服务</strong></p>
<p>url的前缀<code>/PROVIDER-APPLICATION/</code>必须为注册中心上某个服务的名称,<font color="red">同时注意大小写</font></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:4444/PROVIDER-APPLICATION/provider/zhangsan">localhost:4444/PROVIDER-APPLICATION/provider/zhangsan</a></p>
</blockquote>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211004234509330.png" alt="image-20211004234509330"></p>
<h4 id="Filter过滤器">Filter过滤器</h4>
<p>Gateway的过滤器众多，这里不每个都看一遍，必要时查阅文档即可</p>
<ul>
<li>
<p><code>AddRequestHeader</code></p>
<blockquote>
<p>在转发请求网关下游服务时，在请求头添加<code>AddRequestHeader</code>所配置的参数</p>
</blockquote>
</li>
<li>
<p><code>AddRequestParameter</code></p>
<blockquote>
<p>在转发请求网关下游服务时，在参数体中添加<code>AddRequestParameter</code>所配置的参数</p>
</blockquote>
</li>
<li>
<p><code>AddResponseHeader</code></p>
<blockquote>
<p>在返回调用者之前，在响应头中添加<code>AddResponseHeader</code>配置的参数</p>
</blockquote>
</li>
<li>
<p><code>CircuitBreaker</code></p>
<blockquote>
<p>结合Resilience4j的CircuitBreaker断路器</p>
</blockquote>
<ol>
<li>
<p>引入依赖<font color="red">，注意一定是反应式</font><code>reactor</code>的<code>CircuitBreaker</code>的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-circuitbreaker-reactor-resilience4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>配置<code>CircuitBreaker</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Resilience4J配置</span></span><br><span class="line"><span class="attr">resilience4j:</span></span><br><span class="line">  <span class="comment">#circuitbreaker配置</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="comment">#修改默认的配置</span></span><br><span class="line">    <span class="attr">configs:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="comment">#断路器失败阈值百分比</span></span><br><span class="line">        <span class="attr">failureRateThreshold:</span> <span class="number">50</span></span><br><span class="line">        <span class="comment">#超时请求阈值百分比</span></span><br><span class="line">        <span class="attr">slowCallRateThreshold:</span> <span class="number">70</span></span><br><span class="line">        <span class="comment">#超时时长阈值 3秒</span></span><br><span class="line">        <span class="attr">slowCallDurationThreshold:</span> <span class="number">3000</span></span><br><span class="line">        <span class="comment">#断路器half_open时允许调用的数量</span></span><br><span class="line">        <span class="attr">permittedNumberOfCallsInHalfOpenState:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment">#滑动窗口缓冲区类型</span></span><br><span class="line">        <span class="comment">#如果滑动窗口是COUNT_BASED，则记录并聚合最后的&#x27; slidingWindowSize &#x27;调用。</span></span><br><span class="line">        <span class="comment">#如果滑动窗口是TIME_BASED，则记录并聚合最后一个&#x27; slidingWindowSize &#x27;秒的调用。</span></span><br><span class="line">        <span class="attr">slidingWindowType:</span> <span class="string">COUNT_BASED</span></span><br><span class="line">        <span class="comment">#断路器关闭时记录通话结果的滑动窗口的大小</span></span><br><span class="line">        <span class="attr">slidingWindowSize:</span> <span class="number">5</span></span><br><span class="line">        <span class="comment">#在计算错误率或者计算慢速呼叫率最小呼叫数</span></span><br><span class="line">        <span class="attr">minimumNumberOfCalls:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment">#断路器由open状态到half_open状态需要的时间 6秒</span></span><br><span class="line">        <span class="attr">waitDurationInOpenState:</span> <span class="number">60000</span></span><br><span class="line">        <span class="comment">#true 开启一个线程监听CircuitBreakers的所有实例，一旦waitDurationInOpenState通过，就将它们转换到HALF_OPEN。</span></span><br><span class="line">        <span class="comment">#false 转换到HALF_OPEN只在调用时发生，即使在waitDurationInOpenState被传递之后。</span></span><br><span class="line">        <span class="attr">automaticTransitionFromOpenToHalfOpenEnabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="comment">#记录为失败的异常列表，从而增加失败率</span></span><br><span class="line">        <span class="comment">#注意指定失败异常列表那么只有符合该异常列表的异常才被计入失败,其他异常都算成功，除非被ignoreException忽略</span></span><br><span class="line">        <span class="attr">recordExceptions:</span></span><br><span class="line">        <span class="comment">#忽略的异常列表，不计入失败</span></span><br><span class="line">        <span class="attr">ignoreException:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#创建配置实例</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">      <span class="comment">#实例A 覆盖一些默认配置</span></span><br><span class="line">      <span class="attr">breakerA:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">minimumNumberOfCalls:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">waitDurationInOpenState:</span> <span class="number">2000</span></span><br><span class="line">        <span class="attr">permittedNumberOfCallsInHalfOpenState:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">breakerB:</span></span><br><span class="line">        <span class="attr">baseConfig:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在router匹配中加入<code>CircuitBreaker</code>过滤器</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"><span class="comment">#       根据权重匹配</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_high</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://httpbin.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestHeader=name,zhangsan</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddResponseHeader=response-headers,test</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">CircuitBreaker=breakerA</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_low</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>最后，我们的断路器就在该router匹配中生效了，<font color="red">但是注意的是一定是</font><code>circuitbreaker-reactor-resilience4j</code>依赖而不是<code>circuitbreaker-resilience4j</code></p>
</li>
</ol>
</li>
<li>
<p><code>SaveSession</code></p>
<blockquote>
<p>将客户端的session信息，连同请求和session一起转发到下游服务上，确保安全详细信息能够发送到下游服务器</p>
</blockquote>
</li>
</ul>
<p>过滤器有很多，这里不一一赘述，如果有需求可以查阅<code>SpringColud Gateway</code><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories">官方文档</a></p>
<h4 id="Http超时配置">Http超时配置</h4>
<p>可以为所有路由配置 Http 超时（响应和连接），并为每个特定路由覆盖。</p>
<h5 id="全局超时配置">全局超时配置</h5>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">connect-timeout:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">response-timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>
<h5 id="特定路由覆盖">特定路由覆盖</h5>
<p>要配置每条路由超时：</p>
<ul>
<li><code>connect-timeout</code>必须以毫秒为单位指定。</li>
<li><code>response-timeout</code>必须以毫秒为单位指定。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">per_route_timeouts</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">pattern:</span> <span class="string">/delay/&#123;timeout&#125;</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">response-timeout:</span> <span class="number">200</span></span><br><span class="line">    <span class="attr">connect-timeout:</span> <span class="number">200</span></span><br></pre></td></tr></table></figure>
<h2 id="十二，SpringCoudConfig">十二，SpringCoudConfig</h2>
<h3 id="简介-9">简介</h3>
<p>Spring Cloud Config为分布式系统中的外部配置提供服务器和客户端支持。使用Config Server，您可以在所有环境中管理应用程序的外部属性。客户端和服务器上的概念映射与Spring <code>Environment</code>和<code>PropertySource</code>抽象相同，因此它们与Spring应用程序非常契合，但可以与任何以任何语言运行的应用程序一起使用。随着应用程序通过从开发人员到测试和生产的部署流程，您可以管理这些环境之间的配置，并确定应用程序具有迁移时需要运行的一切。服务器存储后端的默认实现使用git，因此它轻松支持标签版本的配置环境，以及可以访问用于管理内容的各种工具。可以轻松添加替代实现，并使用Spring配置将其插入。</p>
<h3 id="ConfigServer">ConfigServer</h3>
<h4 id="准备工作">准备工作</h4>
<p>首先，我们知道<code>Spring Clod Config</code>是结合<code>Git</code>使用的，所以我们需要创建一个可以存放Spring配置文件的仓库,</p>
<p>仓库的创建，以及配置文件的上传这里不赘述</p>
<p>我们直接来看创建好的仓库，内部包含四个配置文件，接下来我们使用<code>Spring Clod Config Server</code>服务来访问这些配置文件</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211006220125018.png" alt="image-20211006220125018"></p>
<h4 id="创建Spring-Clod-Config-Server服务">创建<code>Spring Clod Config Server</code>服务</h4>
<p><strong>引入依赖</strong><img src="http://typora.xpp011.cn/typora/img/image-20211006214022352.png" alt="image-20211006214022352"></p>
<p><strong>配置</strong></p>
<p>创建<code>Spring Clod Config Server</code>服务后，需要在启动类上加入<code>@EnableConfigServer</code>注解,声明这是一台配置服务</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211006222548407.png" alt="image-20211006222548407"></p>
<p><strong>application配置</strong></p>
<ul>
<li>{application}—&gt;<font color="red">占位符</font>，请求连接的client的<code>spring.application.name</code>属性值</li>
</ul>
<p><font color="red">注意！！！</font></p>
<blockquote>
<p>在yaml文件中单独使用占位符时必须使用``单引号括起来</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="comment">#git仓库连接地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/xpp011/SpringCloudConfig.git</span></span><br><span class="line">          <span class="comment">#占位符——client的spring.application.name属性值</span></span><br><span class="line">          <span class="comment">#这样client服务就可以去仓库对应的文件下寻找配置文件</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">&#x27;&#123;application&#125;&#x27;</span></span><br><span class="line">          <span class="comment">#仓库用户名以及密码</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">xpp011</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">&quot;@S-R-YXXXX&quot;</span></span><br><span class="line">          <span class="comment">#git连接超时时间</span></span><br><span class="line">          <span class="comment">#timeout: 4</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3333</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后我们就可以在浏览器中通过url访问配置文件了</p>
<p>以下几种方式的<code>URL</code>都可以访问到配置文件</p>
<ul>
<li>application—配置文件的应用名称</li>
<li>profile—配置文件的环境</li>
<li>label—git分支</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.properties</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties</span><br></pre></td></tr></table></figure>
<h3 id="ConfigClient">ConfigClient</h3>
<h4 id="创建项目">创建项目</h4>
<p>引入依赖</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211006233429203.png" alt="image-20211006233429203"></p>
<p><font color="red">注意</font></p>
<p>注意在<code>SpringBoot2.4</code>之后使用<code>bootstrap.yml | bootstrap.properties</code>引导文件需要引入<code>spring-cloud-starter-bootstrap</code>依赖</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;dependency&gt;</span></span><br><span class="line">    <span class="string">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line">    <span class="string">&lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;</span></span><br><span class="line"><span class="string">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果不使用<code>bootstrap.yml | bootstrap.properties</code>引导文件，配置<code>configServer</code>则在<code>application.yml</code>中加入以下属性</p>
<blockquote>
<p>spring.config.import=optional:configserver:<a target="_blank" rel="noopener" href="http://myhost:8888">http://myhost:8888</a></p>
</blockquote>
<h4 id="配置文件">配置文件</h4>
<p><strong><code>bootstrap.yml</code>配置</strong></p>
<p>在<code>bootstrap.yml</code>中需要配置<code>configserver</code>服务信息</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment">#应用名称对应仓库的配置文件的&#123;application&#125;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client1</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment">#git分支对应&#123;label&#125;</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">main</span></span><br><span class="line">      <span class="comment">#活跃的配置文件对应&#123;profile&#125;</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">      <span class="comment">#configServer服务的ip地址</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3333</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2222</span></span><br></pre></td></tr></table></figure>
<p><strong><code>application.yml</code>配置</strong></p>
<p>为了验证配置文件是否生效</p>
<p>我们自定义了两个属性<code>activate</code>和<code>serveractivate</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">activate:</span> <span class="string">&quot;null&quot;</span></span><br><span class="line"><span class="attr">serveractivate:</span> <span class="string">&quot;null&quot;</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2222</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认活跃的配置文件</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>
<h4 id="验证接口">验证接口</h4>
<p>我们在git仓库中的配置文件配置了不同的<code>serveractivate</code>属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;activate&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String activate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;serveractivate&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serveractivate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;activate=&gt;&quot;</span>+activate + <span class="string">&quot;\nserveractivate=&gt;&quot;</span>+serveractivate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="获取配置信息eureka"><strong>获取配置信息eureka</strong></h3>
<p>通过eureka获取配置信息的好处就是，<code>ConfigServer</code>服务可以随意改变坐标，而不用修改每一个<code>ConfigSlient</code>服务的配置文件</p>
<p>具体操作非常简单</p>
<p><strong>引入依赖</strong></p>
<p>首先我们需要将<code>ConfigServer</code>和<code>ConfigClient</code>注册到Eureka上去</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>配置<code>ConfigServer</code></strong></p>
<p><code>ConfigServer</code>的配置非常简单，只需简单配置以下<code>Eureka</code>的服务地址即可</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="comment">#git仓库连接地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/xpp011/SpringCloudConfig.git</span></span><br><span class="line">          <span class="comment">#占位符——client的spring.application.name属性值</span></span><br><span class="line">          <span class="comment">#这样client服务就可以去仓库对应的文件下寻找配置文件</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">&#x27;&#123;application&#125;&#x27;</span></span><br><span class="line">          <span class="comment">#仓库用户名以及密码</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">xpp011</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">&quot;@S-R-Y(Gitee)&quot;</span></span><br><span class="line">          <span class="comment">#git连接超时时间</span></span><br><span class="line">          <span class="comment">#timeout: 4</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3333</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></table></figure>
<p><strong>配置<code>ConfigClient</code></strong></p>
<p><code>ConfigClient</code>的配置第一步也是注册到<code>Eureka</code>上</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></table></figure>
<p>然后我们需要开启配置文件的服务发现</p>
<blockquote>
<p><code>spring.cloud.config.discovery.enabled=true</code>（默认为<code>false</code>）</p>
</blockquote>
<p>最后我们需要指定注册中心上<code>ConfigServer</code>的服务名称，也就是<code>ConfigServer</code>配置文件中属性<code>spring.application.name</code>的值的大写</p>
<p>我们也可以去eureka上去查看</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211007233342550.png" alt="image-20211007233342550"></p>
<p>配置属性</p>
<blockquote>
<p>spring.cloud.config.discovery.serviceId=CONFIG-SERVER       (默认服务 ID 是<code>configserver</code>)</p>
</blockquote>
<p>最后别忘了取消属性~~<code>spring.cloud.config.uri</code>~~我们已经不需要它了</p>
<p><strong><code>bootstrap.yml</code>文件完整配置</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment">#应用名称对应仓库的配置文件的&#123;application&#125;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client1</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment">#git分支对应&#123;label&#125;</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">main</span></span><br><span class="line">      <span class="comment">#活跃的配置文件对应&#123;profile&#125;</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">      <span class="comment">#configServer服务的ip地址</span></span><br><span class="line">      <span class="comment">#uri: http://CONFIG-SERVER:3333</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">CONFIG-SERVER</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2222</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1111/eureka</span></span><br></pre></td></tr></table></figure>
<h3 id="配置文件的加解密">配置文件的加解密</h3>
<p>在分布式环境下，一些由运维工程师掌握的敏感信息现在不得不写在配置文件中了，这样网传的程序员删库跑路的段子可能就成真了！但是在微服务中，我们又不太可能让运维工程师手动去维护这些信息，因为工作量太大了，那么一个好的办法，就是对这些配置信息进行加密，</p>
<h4 id="常见加密方法">常见加密方法</h4>
<p>说到加密，需要先和大家来捋一捋一些常见的加密策略，首先，从整体上来说，加密分为两大类：</p>
<ul>
<li>
<p>不可逆加密</p>
<blockquote>
<p>不可逆加密就是大家熟知的在 Spring Security 或者 Shiro 这一类安全管理框架中我们对密码加密经常采取的方案。这种加密算法的特点就是不可逆，即理论上无法使用加密后的密文推算出明文，常见的算法如 MD5 消息摘要算法以及 SHA 安全散列算法， SHA 又分为不同版本，这种不可逆加密相信大家在密码加密中经常见到。</p>
</blockquote>
</li>
<li>
<p>可逆加密</p>
<blockquote>
<p>可逆算法看名字就知道，这种算法是可以根据密文推断出明文的，可逆算法又分为两大类：</p>
<ul>
<li>对称加密</li>
</ul>
<blockquote>
<p>对称加密是指加密的密钥和解密的密钥一致，例如 A 和 B 之间要通信，为了防止别人偷听，两个人提前约定好一个密钥。每次发消息时， A 使用这个密钥对要发送的消息进行加密，B 收到消息后则使用相同的密钥对消息进行解密。这是对称加密，常见的算法有 DES、3DES、AES 等。</p>
</blockquote>
<ul>
<li>非对称加密</li>
</ul>
<blockquote>
<p>对称加密在一些场景下并不适用，特别是在一些一对多的通信场景下，于是又有了非对称加密，非对称加密就是加密的密钥和解密的密钥不是同一个，加密的密钥叫做公钥，这个可以公开告诉任何人，解密的密钥叫做私钥，只有自己知道。非对称加密不仅可以用来做加密，也可以用来做签名，使用场景还是非常多的，常见的加密算法是 RSA 。</p>
</blockquote>
</blockquote>
</li>
</ul>
<p>配置文件加密肯定是可逆加密，不然给我一个加密后的字符串，我拿着也没用，还是没法使用。可逆算法中的对称加密和非对称加密在 Spring Cloud Config 中都得到支持，下面我们就分别来看。</p>
<h4 id="对称加密">对称加密</h4>
<p>Java 中提供了一套用于实现加密、密钥生成等功能的包 JCE(Java Cryptography Extension)，这些包提供了对称、非对称、块和流密码的加密支持，但是默认的 JCE 是一个有限长度的 JCE ，我们需要到 Oracle 官网去下载一个不限长度的 JCE ：<br>
不限长度JCE下载地址</p>
<p>下载完成后，将下载文件解压，解压后的文件包含如下三个文件：<br>
<img src="http://typora.xpp011.cn/typora/img/image-20211010212147266.png" alt="image-20211010212147266"></p>
<p>将<code>local_policy.jar</code>和<code>US_export_policy.jar</code>两个文件拷贝到 JDK 的安装目录下，具体位置是 <code>%JAVA_HOME%\jre\lib\security</code> ，如果该目录下有同名文件，则直接覆盖即可。</p>
<p>然后我们在<code>ConfigServer</code>服务中配置对称加密的密钥</p>
<p>注意该配置需要加在<code>bootstrap.yml</code>引导文件中</p>
<p>此外我们还需要开启健康监控，方便查看暴露端点</p>
<p>所以我们需要引入以下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--开启bootstrap引导文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>bootstrap.yml</code>配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对称加密的密钥</span></span><br><span class="line"><span class="attr">encrypt:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">xpp011</span></span><br></pre></td></tr></table></figure>
<p>配置完成后启动服务，我们查看端点</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010214218994.png" alt="image-20211010214218994"></p>
<p>我们可以将需要加密的密码进行加密，得到密文后，写在目标配置文件中</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010214014644.png" alt="image-20211010214014644"></p>
<p><font color="red">注意</font></p>
<ul>
<li><font color="red">为了区分密文和正常的字符串，我们需要在密文前机加上</font><code>&#123;cipher&#125;</code><font color="red">前缀，标识它是一串密文</font></li>
<li>在<code>yaml</code><font color="red">配置文件中，具有特殊含义的字符一定要加上</font><font color="red">‘单引号</font></li>
</ul>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010214941171.png" alt="image-20211010214941171"></p>
<p>我们可以在<code>ConfigServer</code>服务上查看该配置文件</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010215344172.png" alt="image-20211010215344172"></p>
<h4 id="非对称加密">非对称加密</h4>
<p>当然我们也可以使用非对称加密的方式来对配置文件进行加密，非对称加密要求我们先有一个密钥，密钥的生成我们可以使用 JDK 中自带的 keytool。keytool 是一个 Java 自带的数字证书管理工具 ，keytool 将密钥（key）和证书 （certificates） 存在一个称为 keystore 的文件中。具体操作步骤如下：<br>
首先打开命令行窗口，输入如下命令：</p>
<blockquote>
<p>keytool -genkeypair -alias config-server -keyalg RSA -keystore D:\win10桌面存放\SpringCloud\config-server.keystore</p>
</blockquote>
<p>上面参数的解释如下:</p>
<ul>
<li>
<p>-genkeypair 表示生成密钥对</p>
</li>
<li>
<p>-alias 表示 keystore 关联的别名</p>
</li>
<li>
<p>-keyalg 表示指定密钥生成的算法</p>
</li>
<li>
<p>-keystore 指定密钥库的位置和名称</p>
<p>执行过程中，密钥库口令需要牢记，这个我们在后面还会用到。其它的信息可以输入也可以直接回车表示 Unknown ，自己做练习无所谓，实际开发中还是建议如实填写。</p>
</li>
</ul>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010222054367.png" alt="image-20211010222054367"></p>
<p>好了，这个命令执行完成后，在 <code>D:\win10桌面存放\SpringCloud</code>路径下就会生成一个名为 config-server.keystore 的文件，将这个文件直接拷贝到 <code>ConfigServer</code>服务项目的 classpath 下，如下:</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010222358996.png" alt="image-20211010222358996"></p>
<p>然后我们需要在<code>bootstrap.yml</code>配置文件中简单配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对称加密的密钥</span></span><br><span class="line"><span class="comment">#encrypt:</span></span><br><span class="line"><span class="comment">#  key: xpp011</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#非对称加密</span></span><br><span class="line"><span class="attr">encrypt:</span></span><br><span class="line">  <span class="attr">key-store:</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">config-server.keystore</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">config-server</span></span><br><span class="line">    <span class="comment">#生成证书时输入的口令</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xpp011</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">xpp011</span></span><br></pre></td></tr></table></figure>
<p><font color="red">注意：</font></p>
<p>如果无法加载证书，请检查<code>maven</code>生成target文件时是否把证书过滤掉了</p>
<p>服务启动完成后，访问接口<code>/encrypt</code>加密正文</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010223044389.png" alt="image-20211010223044389"></p>
<p>也可访问接口<code>/decrypt</code>，将密文解密</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010223305669.png" alt="image-20211010223305669"></p>
<p>同理，我们将密文写在git仓库的配置文件之中</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010223929087.png" alt="image-20211010223929087"></p>
<p>由此可以看出，所有的加密解密工作全部交给<code>ConfigServer</code>服务，而<code>ConfigClient</code>只负责获取配置</p>
<h3 id="安全管理">安全管理</h3>
<p>目前的 <code>ConfigServer</code> 存在很大的安全隐患，因为所有的数据都可以不经过 <code>ConfigClient </code>直接访问。出于数据安全考虑，我们要给 <code>ConfigServer</code> 中的接口加密。在 Spring Boot 项目中，项目加密方案当然首选 <code>Spring Security </code>，使用<code>Spring Security</code>也很简单，只需要在 <code>ConfigServer</code> 项目中添加如下依赖即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在<code>ConfigServer</code>的配置文件中简单配置一下<code>Security</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">xpp011</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xpp011</span></span><br></pre></td></tr></table></figure>
<p>注意此时，我们再去访问<code>ConfigServer</code>服务的接口就需要登录了，证明<code>ConfigServer</code>服务起到了保护作用</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211010231555727.png" alt="image-20211010231555727"></p>
<p>如果此时我们的<code>ConfigClient</code>不去配置登录信息的话就无法在<code>ConfigServer</code>拿取配置文件了</p>
<p>配置<code>ConfigClient</code>的<code>bootstrap.yml</code>文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment">#应用名称对应仓库的配置文件的&#123;application&#125;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client1</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="string">...</span></span><br><span class="line">      <span class="comment">#ConfigServer的登录信息</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">xpp011</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">xpp011</span></span><br></pre></td></tr></table></figure>
<h3 id="动态刷新">动态刷新</h3>
<p>在更改Git仓库的配置文件后，服务的配置发生了变化，此时服务不能及时的重启去加载新的配置文件，为了解决整个问题，我们需要让服务可以实现配置文件的动态刷新</p>
<h4 id="Autuator实现">Autuator实现</h4>
<p>该方法只是简单的实现了动态刷新，引用<code>Autuator</code>依赖只是为了使用其中的<code>/actuator/refresh</code>端点重启服务</p>
<p>在<code>ConfigClient</code>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>暴露<code>/refresh</code>端点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>
<p>更改配置文件后调用端点<code>/actuator/refresh</code>对应用进行重启，重加载配置文件</p>
<h3 id="客户端重试">客户端重试</h3>
<p>由于在分布式体系中，分区容错、网络波动的情况非常常见，在此期间注册中心，客户端服务，配置服务都有可能出现网络波动，那我的客户端请求不到配置就算了吗，肯定不是这样的，我们需要在网络波动的时候不断的请求我们的配置</p>
<h4 id="快速失败">快速失败</h4>
<p>首先我们需要配置客户端无法来连接配置服务器时快速失败，而不是略过，加载下一配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.config.fail-fast</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
<p>这样在我们的服务请求不到配置时，就直接抛异常快速失败</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211011233415816.png" alt="image-20211011233415816"></p>
<h4 id="请求重试">请求重试</h4>
<p>需要将<code>spring-retry</code>和添加<code>spring-boot-starter-aop</code>到我们的项目之中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.retry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-retry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>默认行为是重试六次，初始退避间隔为 1000 毫秒，后续退避的指数乘数为 1.1。可以通过设置<code>spring.cloud.config.retry.*</code>配置属性来配置这些属性（和其他属性）</p>
<p>可以看到，配置客户端重试非常简单，只需引入依赖，即可马上开箱即由</p>
<p>以下是，客户端在请求不到配置时，不断尝试请求</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211011233951478.png" alt="image-20211011233951478"></p>
<p>我们也可以配置<code>spring.cloud.config.retry.*</code>重试规则</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment">#应用名称对应仓库的配置文件的&#123;application&#125;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client1</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">			<span class="string">...</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="comment">#最大重试次数</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment">#重试间隔</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="number">2000</span></span><br><span class="line">        <span class="comment">#最大重试间隔</span></span><br><span class="line">        <span class="attr">max-interval:</span> <span class="number">10000</span></span><br><span class="line">        <span class="comment">#后续重试间隔的乘数(避免有规律的网络抖动)</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1.5</span></span><br></pre></td></tr></table></figure>
<p>配置详解</p>
<ul>
<li>
<p><code>max-attempts</code></p>
<blockquote>
<p>最大重试次数</p>
</blockquote>
</li>
<li>
<p><code>initial-interval</code></p>
<blockquote>
<p>重试间隔</p>
</blockquote>
</li>
<li>
<p><code>max-interval</code></p>
<blockquote>
<p>最大重试间隔</p>
</blockquote>
</li>
<li>
<p><code>multiplier</code></p>
<blockquote>
<p>后续退避的指数乘数</p>
</blockquote>
</li>
</ul>
<h2 id="十三，SpringCloudBus">十三，SpringCloudBus</h2>
<p>Spring Cloud Bus 将分布式系统的节点与轻量级消息代理连接起来。然后可以使用此代理来广播状态更改（例如配置更改）或其他管理指令。一个关键的想法是，总线就像一个用于横向扩展的 Spring Boot 应用程序的分布式执行器。但是，它也可以用作应用程序之间的通信渠道。该项目为 AMQP 代理或 Kafka 提供启动器作为传输。</p>
<h3 id="快速入门">快速入门</h3>
<p>如果需要使用<code>SpringCloudBus</code>消息总线，那么需要引入依赖<code>spring-cloud-starter-bus-amqp</code>或 添加<code>spring-cloud-starter-bus-kafka</code>，<code>SpringCloudBus</code>启动器涵盖了 <code>Rabbit</code> 和<code> Kafka</code>，因为这是两个最常见的实现。</p>
<blockquote>
<p>但是，<code>Spring Cloud Stream </code>非常灵活，并且与<code>spring-cloud-bus</code>很好的结合</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--由于Bus需要提供端点，需要健康检查的依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置<code>rabbitMq</code>以及<code>actuator</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.131</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">xpp011</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xpp011</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">      <span class="comment">#暴露端点</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="总线端点">总线端点</h3>
<h4 id="busrefresh">busrefresh</h4>
<ul>
<li>
<p><code>/actuator/busrefresh</code></p>
<blockquote>
<p>针对<code>ConfigServer</code>的接口由于通知接入<code>RabbitMq</code>的服务进行刷新配置重启操作</p>
</blockquote>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20181204172531555.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4Mjg4NjA2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><font color="red">注意</font></p>
<blockquote>
<p>busrefresh接口确实可以将客户端服务进行重新加载配置操作</p>
<p>但是注意如果需要有一个接口查看配置信息，如果以下代码块，使用<code>$</code>符号引用配置文件值,如果在配置未重新加载前获取该值，那么该值会一直保留重新加载前的值，即使服务重新加载配置后，该值还是保留原来jvm加载的值。</p>
<p>如果希望，该值可以随着配置文件的加载而加载，需要在该类上加上<code>@RefreshScope</code>注解即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;activate&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String activate;</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="busrefresh-2">busrefresh/**</h4>
<p>通过目标路径指定服务刷新配置</p>
<p>应用程序的每个实例都有一个服务 ID，它的值可以设置 <code>spring.cloud.bus.id</code>,默认值是从环境中构造的<code>spring.application.name</code>和 <code>server.port</code>（或<code>spring.application.index</code>，如果设置）的组合。ID的默认值以 的形式构造<code>app:index:id</code>，其中：</p>
<ul>
<li><code>app</code>是<code>vcap.application.name</code>，如果它存在，或者<code>spring.application.name</code></li>
<li><code>index</code>是<code>vcap.application.instance_index</code>, 如果存在, <code>spring.application.index</code>, <code>local.server.port</code>, <code>server.port</code>, 或<code>0</code>(按此顺序)。</li>
<li><code>id</code>是<code>vcap.application.instance_id</code>，如果存在，或者是一个随机值。(<font color="red">不存在则不参与改造ID</font>)</li>
</ul>
<p>HTTP 端点接受“目标”路径参数，例如 <code>busrefresh/client1:2222</code>，其中<code>destination</code>是服务 ID。如果该 ID 由总线上的一个实例拥有，它会处理该消息，而所有其他实例将忽略它。</p>
<h4 id="实例">实例</h4>
<p>我们启用两个客户端分别是<code>2222</code>和<code>2223</code>端口</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211012233333782.png" alt="image-20211012233333782"></p>
<p>更改Git仓库中的配置文件</p>
<p>然后通过<code>Postman</code>请求带有指定“目标”的路径</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211012233456226.png" alt="image-20211012233456226"></p>
<p>最后我们查看两个服务查看配置文件属性的接口,可以发现，成功指定了服务进行刷新配置</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211012233655669.png" alt="image-20211012233655669"></p>
<h2 id="十四，SpringCloudStream">十四，SpringCloudStream</h2>
<p>Spring Cloud Stream 是用于构建消息驱动的微服务应用程序的框架。Spring Cloud Stream 构建在 Spring Boot 的基础上，以创建独立的、生产级的 Spring 应用程序，并使用 Spring Integration 提供与消息代理的连接。它提供了来自多个供应商的中间件的自以为是的配置，介绍了持久发布订阅语义、消费者组和分区的概念。</p>
<p>通过简单地将 spring-cloud-stream 依赖项添加到应用程序的类路径，您将立即连接到通过提供的 spring-cloud-stream 绑定器公开的消息代理（稍后会详细介绍），并且您可以实现您的功能需求使用简单的基于传入消息执行</p>
<h3 id="快速开始">快速开始</h3>
<p>创建具有以下依赖的服务</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211013225729943.png" alt="image-20211013225729943"></p>
<p>创建一个消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageReceiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3.0支持函数式编程</span></span><br><span class="line"><span class="comment">     * 创建一个消费者，其参数Person会根据json解析并强制类型转换</span></span><br><span class="line"><span class="comment">     * 创建了一个名称为log-in-0的Exchanges</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Consumer&lt;Person&gt; <span class="title">log</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> person -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;log1=======&gt;&quot;</span>+person);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>简单配置一下<code>application.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.131</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">xpp011</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xpp011</span></span><br></pre></td></tr></table></figure>
<p>此时我们在<code>rabbitMq</code>发送消息时，该bean就会接收到</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211013232651862.png" alt="image-20211013232651862"></p>
<h3 id="自定义通道">自定义通道</h3>
<p>我们可以通过<code>SpringCloudStream3.0</code>的bean方式来创建供应商消费者</p>
<p><a name="rule"><strong>绑定输入输出的名称规则如下</strong></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Function&lt;String, String&gt; <span class="title">uppercase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> value -&gt; value.toUpperCase();</span><br><span class="line">	&#125;		</span><br></pre></td></tr></table></figure>
<ul>
<li>输入 - <code>&lt;functionName&gt; + -in- + &lt;index&gt;</code></li>
<li>输出 - <code>&lt;functionName&gt; + -out- + &lt;index&gt;</code></li>
</ul>
<p><code>in</code>和<code>out</code>对应于结合的类型（如<em>输入</em>或<em>输出</em>）</p>
<p><code>index</code>是输入或输出的结合的索引。对于典型的单个输入/输出函数，它始终为 0，因此它仅与<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#_functions_with_multiple_input_and_output_arguments">具有多个输入和输出参数的函数</a>相关。</p>
<p><strong>消费者</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerBeans</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义一个消费者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Consumer&lt;String&gt; <span class="title">now</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//将事件驱动得到的消息直接打印</span></span><br><span class="line">        <span class="keyword">return</span> s -&gt; System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>供应商</strong></p>
<p><code>Supplier</code>的默认触发调用方式是一秒执行一次，也就是说该供应商将会每一秒制造一次消息</p>
<p><strong>如果我们不想让<code>Supplier</code>采用轮询的方式制造消息，我们直接让该方法返回<code>null</code>即可</strong></p>
<blockquote>
<p>@Bean<br>
public Supplier<String> noPoll()    { return () -&gt; null;}</String></p>
</blockquote>
<p>具体可查看<a href="#trigger">触发方式</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SupplierBeans</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 轮询</span></span><br><span class="line"><span class="comment">     * 创建一个供应商bean用于生产消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Supplier&lt;String&gt; <span class="title">date</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> () -&gt; <span class="keyword">new</span> Date().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码我们创建好了供应商，消费者</p>
<p>接下来我们需要将他们两个进行绑定,绑定的名称规则需要符合<a href="#rule">名称规则</a></p>
<p><strong><code>application.yml</code></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.131</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">xpp011</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xpp011</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="comment">#将创建的生产者消费者捆绑到一起</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line">        <span class="attr">date-out-0:</span></span><br><span class="line">          <span class="comment">#保定到My-Topic的Exchanges</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">My-Topic</span></span><br><span class="line">        <span class="attr">now-in-0:</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">My-Topic</span></span><br><span class="line">    <span class="comment">#申明以下bean属于stream，一定要配置</span></span><br><span class="line">    <span class="attr">function:</span></span><br><span class="line">      <span class="attr">definition:</span> <span class="string">now;date</span></span><br></pre></td></tr></table></figure>
<p>值得注意的是，当我们创建多个类型的<code>java.util.function.[Supplier/Function/Consumer]</code>Bean时，我们需要通过<code>spring.cloud.function.definition</code>进行声明，同时这也是必须的</p>
<p><strong>效果</strong></p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211014233758209.png" alt="image-20211014233758209"></p>
<p><a name="trigger"><strong>触发方式</strong></a></p>
<p><code>Function</code>并且<code>Consumer</code>在涉及如何触发它们的调用时非常简单。它们是根据发送到它们绑定到的目的地的数据（事件）触发的。换句话说，它们是经典的事件驱动组件。</p>
<p>但是，<code>Supplier</code>在触发方面属于它自己的类别。由于根据定义，它是数据的源（源），它不订阅任何入站目的地，因此必须由一些其他机制触发。还有的问题<code>Supplier</code>实现方式中，这可能是<em>必要的</em>或<em>反应性</em>和其直接涉及这样的供应商的触发。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SupplierConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Supplier&lt;String&gt; <span class="title">stringSupplier</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> () -&gt; <span class="string">&quot;Hello from Supplier&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Supplier</code>每当<code>get()</code>调用其方法时，前面的bean 都会生成一个字符串。但是，谁调用这个方法，多久调用一次？该框架提供了一个默认的轮询机制（回答“谁？”的问题），它将触发供应商的调用，并且默认情况下它会每秒执行一次（回答“多久？”的问题）。换句话说，上述配置每秒生成一条消息，并且每条消息都发送到<code>output</code>由绑定器公开的目的地。要了解如何自定义轮询机制，请参阅<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#_polling_configuration_properties">轮询配置属性</a>部分。</p>
<h3 id="分组">分组</h3>
<p>当我们在两个服务内同时订阅了输入通道<code>now-in-0</code>，同时绑定的路由也是同一个，那么这两个服务都会同时消费输入通道<code>now-in-0</code>内的消息，也就是说一个通道的消息被消费了两次，那如果我们想要实现一个通道的消息只被消费一次该怎么办呢，</p>
<p>这时就有了分组的概念</p>
<p>使用配置将输入通道分到<code>g1</code>组</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">....</span></span><br><span class="line"> <span class="attr">stream:</span></span><br><span class="line">     <span class="attr">bindings:</span></span><br><span class="line">       <span class="comment">#供应商  绑定到名为my-topic的exchange</span></span><br><span class="line">       <span class="attr">date-out-0:</span></span><br><span class="line">         <span class="attr">destination:</span> <span class="string">my-topic</span></span><br><span class="line">         <span class="attr">group:</span> <span class="string">g1</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">#消费者  绑定到名为my-topic的exchange</span></span><br><span class="line">       <span class="attr">now-in-0:</span></span><br><span class="line">         <span class="attr">destination:</span> <span class="string">my-topic</span></span><br><span class="line">         <span class="attr">group:</span> <span class="string">g1</span></span><br></pre></td></tr></table></figure>
<p>可以看到，rabbitMq创建了一个<code>g1</code>队列，该队列下有两个消费者，对应着服务A和服务B</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211017230643101.png" alt="image-20211017230643101"></p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211017230810336.png" alt="image-20211017230810336"></p>
<p>此时，这两个消费者，会采用轮询的方式消费该队列的消息，而不再是一个消息被消费两次或者多次</p>
<p><font color="red">在未分组前，一个Consumer连接就是一个队列</font></p>
<h3 id="分区">分区</h3>
<p>由于分组无法决定那个连接消费消息，所以我们需要设置分组，来保证消息可以指定消费</p>
<p><strong>创建供应商</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SupplierBeans</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 非轮询方式，不产生任何消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Supplier&lt;Message&lt;String&gt;&gt; noPoll()&#123;</span><br><span class="line">        <span class="keyword">return</span> () -&gt; <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>创建消费者</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerBeans</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义一个消费者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Consumer&lt;Message&lt;String&gt;&gt; now()&#123;</span><br><span class="line">        <span class="comment">//将事件驱动得到的消息直接打印</span></span><br><span class="line">        <span class="keyword">return</span> s -&gt; System.out.println(s.getPayload()+<span class="string">&quot;\n&quot;</span>+</span><br><span class="line">                s.getHeaders().get(AmqpHeaders.CONSUMER_QUEUE));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.131</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">xpp011</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xpp011</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">#申明以下bean属于stream</span></span><br><span class="line">    <span class="attr">function:</span></span><br><span class="line">      <span class="attr">definition:</span> <span class="string">now;noPoll</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line">        <span class="comment">#消费者  绑定到名为my-topic的exchange</span></span><br><span class="line">        <span class="attr">now-in-0:</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">my-topic</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">myGroup</span></span><br><span class="line">          <span class="attr">consumer:</span></span><br><span class="line">            <span class="comment">#开启分组</span></span><br><span class="line">            <span class="attr">partitioned:</span> <span class="literal">true</span></span><br><span class="line">            <span class="comment">#所属分组下标</span></span><br><span class="line">            <span class="attr">instance-index:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#非轮询方式的Supplier</span></span><br><span class="line">        <span class="attr">noPoll-out-0:</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">my-topic</span></span><br><span class="line">          <span class="attr">producer:</span></span><br><span class="line">            <span class="comment">#partition-key-expression就是生产者的路由分配功能 依据该字段来分区到指定队列</span></span><br><span class="line">            <span class="attr">partition-key-expression:</span> <span class="string">headers[&#x27;partitionKey&#x27;]</span></span><br><span class="line">            <span class="comment">#分组的数量</span></span><br><span class="line">            <span class="attr">partition-count:</span> <span class="number">2</span></span><br><span class="line">            <span class="comment">#分组名称   可以配置多个</span></span><br><span class="line">            <span class="attr">required-groups:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">myGroup</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">poller:</span></span><br><span class="line">        <span class="comment">#单次轮询最大消息</span></span><br><span class="line">        <span class="attr">max-messages-per-poll:</span> <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>使用请求发送消息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NowController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StreamBridge streamBridge;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/send&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">(String outputName,String payload,Integer index)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">         		<span class="comment">//outputName——向那个路由发送消息</span></span><br><span class="line">            <span class="comment">//payload——有效载荷，消息体</span></span><br><span class="line">            <span class="comment">//index——消息头的partitionKey字段值，决定该消息被那一组消费</span></span><br><span class="line">            streamBridge.send(outputName,</span><br><span class="line">                    MessageBuilder.withPayload(payload)</span><br><span class="line">                    .setHeader(<span class="string">&quot;partitionKey&quot;</span>,index).build());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;发送成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>启动服务</strong></p>
<p>我们再创建一个服务,配置如下</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211018234828163.png" alt="image-20211018234828163"></p>
<p>配置完成后，分别启动两个项目</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211018234917430.png" alt="image-20211018234917430"></p>
<p><strong>讲解</strong></p>
<p>创建和配置好Bean后，我们来看一下<code>RabbitMq</code></p>
<p>可以看到，创建了一个名<code>my-topic</code>的路由,该路由下具有两个队列，这两个队列是分组队列，名称都是以<code>myGroup</code>为前缀，</p>
<p>这个是由<code>supplier</code>的<code>required-groups</code>配置决定的</p>
<p>那为什么是两个分组呢,这也是由<code>supplier</code>的<code>partition-count</code>的配置决定的</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211018233825488.png" alt="image-20211018233825488"></p>
<p>接下来我们详细查看这两个队列</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211018234719180.png" alt="image-20211018234719180"></p>
<p>可以看到，两个分组下各有一个连接，那么当我请求url</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/send?payload=%E8%B0%A2%E8%B0%A2%E4%BD%A0&amp;outputName=noPoll-out-0&amp;index=0">localhost:8080/send?payload=谢谢你&amp;outputName=noPoll-out-0&amp;index=0</a></p>
</blockquote>
<p>通过控制index的值，就可以指定消息被哪一组的连接消费了</p>
<p><strong>重点</strong></p>
<ul>
<li>分组是依靠消息头中的<code>partitionKey</code>实现的</li>
</ul>
<h3 id="外部数据发送到Supplier">外部数据发送到Supplier</h3>
<p>在某些情况下，实际数据源可能来自不是绑定器的外部（外国）系统。例如，数据源可能是经典的 REST 端点。我们如何将此类源与 spring-cloud-stream 使用的功能机制连接起来？</p>
<p>Spring Cloud Stream 提供了两种机制，让我们更详细地了解它们</p>
<p>在这里，对于这两个示例，我们将使用称为<code>delegateToSupplier</code>绑定到根 Web 上下文的标准 MVC 端点方法，通过两种不同的机制将传入请求委托给流 - 命令式（通过 StreamBridge）和反应式（通过 EmitterProcessor）。</p>
<p><strong>Supplicat以及Consumer还是以上配置</strong></p>
<h4 id="StreamBridge"><strong><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#_using_streambridge"> StreamBridge</a></strong></h4>
<ul>
<li>
<p><code>outputName</code></p>
<blockquote>
<p>输出通道名称</p>
</blockquote>
</li>
<li>
<p><code>payload</code></p>
<blockquote>
<p>消息体</p>
</blockquote>
</li>
</ul>
<p>当我们创建以下接口后，每当我们调用URL<code>localhost:8080/send?payload=谢谢你&amp;outputName=date-out-0</code>,都会在输出通道<code>date-out-0</code>发送一条<code>谢谢你</code>的消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NowController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StreamBridge streamBridge;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/send&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">(String outputName,String payload)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            streamBridge.send(outputName,payload);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;发送成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="EmitterProcessor">EmitterProcessor</h4>
<p>另一种可用于将任意数据发送到输出的方法是使用 Reactor API。</p>
<p>我们需要做的就是声明一个 从反应器 API<code>Supplier&lt;Flux&lt;whatever&gt;&gt;</code>返回<a target="_blank" rel="noopener" href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/EmitterProcessor.html">EmitterProcessor</a>（有关更多详细信息，请参阅<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#_reactive_functions_support">Reactive Functions 支持</a>）以有效地提供实际事件源（<em>外源</em>）和 spring-cloud-stream之间的桥梁。现在，您现在需要做的就是<code>EmitterProcessor</code>通过<code>EmitterProcessor#onNext(data)</code>操作提供数据。</p>
<p>例如，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">               SpringApplication.run(SampleApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EmitterProcessor&lt;String&gt; processor = EmitterProcessor.create();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApplicationRunner <span class="title">runner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Message&lt;String&gt; msg1 = MessageBuilder.withPayload(<span class="string">&quot;foo&quot;</span>)</span><br><span class="line">                .setHeader(<span class="string">&quot;*.events&quot;</span>, <span class="string">&quot;test1.events.billing&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        Message&lt;String&gt; msg2 = MessageBuilder.withPayload(<span class="string">&quot;bar&quot;</span>)</span><br><span class="line">                .setHeader(<span class="string">&quot;*.events&quot;</span>, <span class="string">&quot;test2.events.messages&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            <span class="keyword">this</span>.processor.onNext(msg1);</span><br><span class="line">            <span class="keyword">this</span>.processor.onNext(msg2);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Supplier&lt;Flux&lt;String&gt;&gt; supplier() &#123;</span><br><span class="line">               <span class="keyword">return</span> () -&gt; <span class="keyword">this</span>.processor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="十五，链路追踪">十五，链路追踪</h2>
<h3 id="Spring-Cloud-Sleuth"><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-sleuth/docs/current/reference/html/getting-started.html#getting-started-introducing-spring-cloud-sleuth">Spring Cloud Sleuth</a></h3>
<p>参考链接:<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/136593164">https://zhuanlan.zhihu.com/p/136593164</a></p>
<h4 id="简介-10">简介</h4>
<p>随着微服务架构的流行，服务按照不同的维度进行拆分，一次请求往往需要涉及到多个服务。互联网应用构建在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程语言来实现、有可能布在了几千台服务器，横跨多个不同的数据中心。因此，就需要一些可以帮助理解系统行为、用于分析性能问题的工具，以便发生故障的时候，能够快速定位和解决问题。在复杂的微服务架构系统中，几乎每一个前端请求都会形成一个复杂的分布式服务调用链路。一个请求完整调用链可能如下图所示：</p>
<p><img src="https://pic1.zhimg.com/80/v2-dda8eb422443d1fe51778449322c6710_720w.jpg" alt="img"></p>
<p>随着服务的越来越多，对调用链的分析会越来越复杂。它们之间的调用关系也许如下：</p>
<p><img src="https://pic3.zhimg.com/80/v2-5c0639334a2dd2ed64883842e0a5c9e6_720w.jpg" alt="img"></p>
<p>随着业务规模不断增大、服务不断增多以及频繁变更的情况下，面对复杂的调用链路就带来一系列问题：</p>
<ul>
<li>如何快速发现问题？</li>
<li>如何判断故障影响范围？</li>
<li>如何梳理服务依赖以及依赖的合理性？</li>
<li>如何分析链路性能问题以及实时容量规划？</li>
</ul>
<p>而链路追踪的出现正是为了解决这种问题，它可以在复杂的服务调用中定位问题，还可以在新人加入后台团队之后，让其清楚地知道自己所负责的服务在哪一环。</p>
<p>除此之外，如果某个接口突然耗时增加，也不必再逐个服务查询耗时情况，我们可以直观地分析出服务的性能瓶颈，方便在流量激增的情况下精准合理地扩容。</p>
<h4 id="什么是链路追踪">什么是链路追踪</h4>
<p>“链路追踪”一词是在 2010 年提出的，当时谷歌发布了一篇 Dapper 论文：<a href="https://link.zhihu.com/?target=http%3A//bigbully.github.io/Dapper-translation/">Dapper，大规模分布式系统的跟踪系统</a>，介绍了谷歌自研的分布式链路追踪的实现原理，还介绍了他们是怎么低成本实现对应用透明的。</p>
<p><strong>单纯的理解链路追踪，就是指一次任务的开始到结束，期间调用的所有系统及耗时（时间跨度）都可以完整记录下来。</strong></p>
<p>其实 Dapper 一开始只是一个独立的调用链路追踪系统，后来逐渐演化成了监控平台，并且基于监控平台孕育出了很多工具，比如实时预警、过载保护、指标数据查询等。</p>
<p>除了谷歌的 Dapper，还有一些其他比较有名的产品，比如阿里的鹰眼、大众点评的 CAT、Twitter 的 Zipkin、Naver（著名社交软件LINE的母公司）的 PinPoint 以及国产开源的 SkyWalking（已贡献给 Apache） 等。</p>
<h4 id="什么是-Sleuth">什么是 Sleuth</h4>
<p>Spring Cloud Sleuth 为 Spring Cloud 实现了分布式跟踪解决方案。兼容 Zipkin，HTrace 和其他基于日志的追踪系统，例如 ELK（Elasticsearch 、Logstash、 Kibana）。</p>
<p>Spring Cloud Sleuth 提供了以下功能：</p>
<ul>
<li><code>链路追踪</code>：通过 Sleuth 可以很清楚的看出一个请求都经过了那些服务，可以很方便的理清服务间的调用关系等。</li>
<li><code>性能分析</code>：通过 Sleuth 可以很方便的看出每个采样请求的耗时，分析哪些服务调用比较耗时，当服务调用的耗时随着请求量的增大而增大时， 可以对服务的扩容提供一定的提醒。</li>
<li><code>数据分析，优化链路</code>：对于频繁调用一个服务，或并行调用等，可以针对业务做一些优化措施。</li>
<li><code>可视化错误</code>：对于程序未捕获的异常，可以配合 Zipkin 查看。</li>
</ul>
<h4 id="术语">术语</h4>
<ol>
<li>
<p><strong>Span</strong>：基本工作单位，一次单独的调用链可以称为一个 Span，Dapper 记录的是 Span 的名称，以及每个 Span 的 ID 和父 ID，以重建在一次追踪过程中不同 Span 之间的关系，图中一个矩形框就是一个 Span，前端从发出请求到收到回复就是一个 Span。</p>
<p><img src="https://pic2.zhimg.com/80/v2-456c15a52635b52f91de335afeccba2d_720w.jpg" alt="img"></p>
<blockquote>
<p>开始跟踪的初始跨度称为<code>root span</code>。该跨度的 ID 的值等于跟踪 ID。</p>
</blockquote>
<p>Dapper 记录了 span 名称，以及每个 span 的 ID 和父 span ID，以重建在一次追踪过程中不同 span 之间的关系。如果一个 span 没有父 ID 被称为 root span。所有 span 都挂在一个特定的 Trace 上，也共用一个 trace id。</p>
<p><img src="https://pic4.zhimg.com/80/v2-412974ef70e7998f6537e394d40660df_720w.jpg" alt="img"></p>
</li>
<li>
<p><strong>Trace</strong>：一系列 Span 组成的树状结构，一个 Trace 认为是一次完整的链路，内部包含 n 多个 Span。Trace 和 Span 存在一对多的关系，Span 与 Span 之间存在父子关系。</p>
<p>举个例子：客户端调用服务 A 、服务 B 、服务 C 、服务 F，而每个服务例如 C 就是一个 Span，如果在服务 C 中另起线程调用了 D，那么 D 就是 C 的子 Span，如果在服务 D 中另起线程调用了 E，那么 E 就是 D 的子 Span，这个 C -&gt; D -&gt; E 的链路就是一条 Trace。如果链路追踪系统做好了，链路数据有了，借助前端解析和渲染工具，可以达到下图中的效果：</p>
<p><img src="https://pic2.zhimg.com/80/v2-613fbad15779ac22757cdaa2cab3f801_720w.jpg" alt="img"></p>
</li>
<li>
<p><strong>Annotation/Event</strong>：用来及时记录一个事件的存在，一些核心 annotations 用来定义一个请求的开始和结束。</p>
<ol>
<li><strong>cs-Client-Sent</strong>：客户端发送一个请求，这个注解描述了Span的开始</li>
<li><strong>sr-Server Received</strong>：服务端获得请求并准备开始处理它，如果将sr减去cs时间戳，便可得到网络传输的时间</li>
<li><strong>ss-Server Sent</strong>：服务端发送响应，该注解表明请求处理的完成（当请求返回客户端），用ss的时间戳减去sr时间戳，便可以得到服务器请求的时间</li>
<li><strong>cr-Client Received</strong>：客户端接收响应，此时Span结束，如果cr的时间戳减去cs时间戳，便可以得到整个请求所消耗的时间</li>
</ol>
</li>
</ol>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211019215225929.png" alt="image-20211019215225929"></p>
<p>每种颜色表示一个跨度（有七个跨度 - 从<strong>A</strong>到<strong>G</strong>）。请考虑以下注意事项：</p>
<blockquote>
<p>Trace Id = X<br>
Span Id = D<br>
Client Sent</p>
</blockquote>
<p>此注释表示当前跨度将<strong>Trace Id</strong>设置为<strong>X</strong>并将<strong>Span Id</strong>设置为<strong>D</strong>。此外，从 RPC 的角度来看，<code>Client Sent</code>事件发生了。</p>
<p>让我们考虑更多注意事项：</p>
<blockquote>
<p>Trace Id = X<br>
Span Id = A<br>
(no custom span)</p>
<p>Trace Id = X<br>
Span Id = C<br>
(custom span)</p>
</blockquote>
<p>您可以继续使用创建的跨度（带有<code>no custom span</code>指示的示例），也可以手动创建子跨度（带有<code>custom span</code>指示的示例）。</p>
<p>下图显示了跨度的父子关系：</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211019215515317.png" alt="image-20211019215515317"></p>
<h4 id="快速开始-2">快速开始</h4>
<h5 id="前提项目"><strong>前提项目</strong></h5>
<ul>
<li>
<p>Eureka</p>
</li>
<li>
<p>Provider</p>
<ul>
<li>
<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sleuth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SleuthController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(SleuthController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello sleuth&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/link-api&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">link</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String rsp = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/sleuth/api&quot;</span>, String.class);</span><br><span class="line">        log.info(rsp);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello sleuth&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">api</span><span class="params">()</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;调用api&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello api&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>一个注册中心，一个提供接口调用的服务,这两个项目可以参考以上笔记创建</p>
<h5 id="创建项目-2">创建项目</h5>
<p>首先我们创建<code>Slieuth</code>项目,引入以下依赖</p>
<ul>
<li>web</li>
<li>openfeign</li>
<li>eureka</li>
<li>sleuth</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>		</span><br></pre></td></tr></table></figure>
<h5 id="发起调用">发起调用</h5>
<p>我们向<code>Sleuth</code>服务发起请求<a target="_blank" rel="noopener" href="http://localhost:2222/link-api">localhost:2222/link-api</a></p>
<p>我们分别观察<code>Sleuth</code>服务和<code>Provider</code>服务的日志</p>
<p><strong>Sleuth</strong><br>
<img src="http://typora.xpp011.cn/typora/img/image-20211020225210766.png" alt="image-20211020225210766"></p>
<p><strong>Provider</strong></p>
<p>api接口链式调用,使用restTemple二次调用接口，打印两次</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211020225359060.png" alt="image-20211020225359060"></p>
<p>可以看到在日志中打印出来的<code>Trace</code>和<code>Span</code>的ID,在发起请求的<code>Sleuth</code>服务中可以看到生成了本次调用的<code>Trace</code>ID，但是并未生成<code>Span</code>ID(Span栏位使用了<code>Trace</code>ID)，而在<code>Provider</code>服务中，可以看到熟悉的<code>Trace</code>ID,但是每一次调用的<code>Span</code>ID不同。</p>
<p>所以Span组成了Trace，一个Trace记录了本次调用的调用链，可以结合一下这张图片理解。</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211019215225929.png" alt="image-20211019215225929"></p>
<h4 id="自定义Span">自定义Span</h4>
<h5 id="创建Span"><strong>创建Span</strong></h5>
<p>Spring Cloud Sleuth<code>Tracer</code>创建了一个实例。为了使用它，可以自动装配它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Tracer tracer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/api2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">api2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;=======&gt;调用api2&quot;</span>);</span><br><span class="line">    Span newSpan=tracer.nextSpan().name(<span class="string">&quot;calculateTax&quot;</span>);</span><br><span class="line">    <span class="comment">//将自定义Span，写入绑定到当前Trace</span></span><br><span class="line">    <span class="keyword">try</span>(Tracer.SpanInScope ws=tracer.withSpan(newSpan.start())) &#123;</span><br><span class="line">        <span class="comment">//标记Span</span></span><br><span class="line">        newSpan.tag(<span class="string">&quot;taxValue&quot;</span>,<span class="string">&quot;tag&quot;</span>);</span><br><span class="line">        <span class="comment">//记录事件</span></span><br><span class="line">        newSpan.event(<span class="string">&quot;createSpan&quot;</span>);</span><br><span class="line">        log.info(newSpan.toString());</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        newSpan.end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello api2&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自此我们就创建好了一个Span，并且我们可以在Span结束之前自定义它。</p>
<h5 id="连续Span">连续Span</h5>
<p>有时，您不想创建一个新的跨度，而是想继续一个。这种情况的一个例子可能如下：</p>
<ul>
<li><strong>AOP</strong>：如果在达到方面之前已经创建了一个跨度，您可能不想创建一个新的跨度。</li>
</ul>
<p>要继续跨度，您可以将跨度存储在一个线程中并将其传递给另一个线程，如下例所示。</p>
<p>我们只需将想要连续使用的Span，将参数转递给下一个方法即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连续使用Span，而不是新创建一个</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> span 上一个span</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">continued</span><span class="params">(Span span)</span></span>&#123;</span><br><span class="line">    span.tag(<span class="string">&quot;taxValue&quot;</span>,<span class="string">&quot;continued&quot;</span>);</span><br><span class="line">    span.event(<span class="string">&quot;连续使用Span&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;连续使用Span&quot;</span>);</span><br><span class="line">    father(span);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建父级Span的子级Span">创建父级Span的子级Span</h5>
<p>与连续使用 Span相似，我们需要将父级Span作为参数传递下去，</p>
<p>然后通过<code>Span childSpan = tracer.nextSpan(fatherSpan);</code>得到子级Span</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注意每次创建创建一次Span就要将其写入绑定到Trace</span></span><br><span class="line"><span class="comment"> * 为父级Span创建子级Span</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fatherSpan 父级Span</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">father</span><span class="params">(Span fatherSpan)</span></span>&#123;</span><br><span class="line">    Span childSpan = tracer.nextSpan(fatherSpan);</span><br><span class="line">  	<span class="comment">//try的语法糖，在()内的对象将自动实现close和finally代码块</span></span><br><span class="line">    <span class="keyword">try</span>(Tracer.SpanInScope ws = tracer.withSpan(childSpan))&#123;</span><br><span class="line">        childSpan.tag(<span class="string">&quot;taxValue&quot;</span>,<span class="string">&quot;father&quot;</span>);</span><br><span class="line">        childSpan.event(<span class="string">&quot;father&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;子级:&quot;</span>+childSpan.toString());</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        childSpan.end();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211021225253496.png" alt="image-20211021225253496"></p>
<p><font color="red">注意:</font></p>
<ul>
<li>
<p>只要我们在代码中创建了Span，就需要将其写入到<code>Trace</code>,</p>
<blockquote>
<p>tracer.withSpan(childSpan)</p>
</blockquote>
</li>
<li>
<p>创建的Span，需要手动关闭,否则该Span将不会报告(无效)</p>
<blockquote>
<p>span.end();</p>
</blockquote>
</li>
</ul>
<h5 id="注解"><strong>注解</strong></h5>
<p>如果您不想手动创建本地跨度，则可以使用<code>@NewSpan</code>注释。此外，我们提供了<code>@SpanTag</code>以自动化方式添加标签的注释。</p>
<p>现在我们可以考虑一些使用示例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NewSpan</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testMethod</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>注释不带任何参数的方法会导致创建一个新的跨度，其名称等于注释的方法名称。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NewSpan(&quot;customNameOnTestMethod4&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testMethod4</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>如果您在注释中提供值（直接或通过设置<code>name</code>参数），则创建的跨度将提供的值作为名称。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// method declaration</span></span><br><span class="line"><span class="meta">@NewSpan(name = &quot;customNameOnTestMethod5&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testMethod5</span><span class="params">(<span class="meta">@SpanTag(&quot;testTag&quot;)</span> String param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// and method execution</span></span><br><span class="line"><span class="keyword">this</span>.testBean.testMethod5(<span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="ZipKin">ZipKin</h3>
<h4 id="简介-11">简介</h4>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211021231318886.png" alt="image-20211021231318886"></p>
<p><a target="_blank" rel="noopener" href="https://zipkin.io/">Zipkin</a> 是 Twitter 公司开发贡献的一款开源的分布式实时数据追踪系统（Distributed Tracking System），基于 Google Dapper 的论文设计而来，其主要功能是聚集各个异构系统的实时监控数据。</p>
<p>它可以收集各个服务器上请求链路的跟踪数据，并通过 Rest API 接口来辅助我们查询跟踪数据，实现对分布式系统的实时监控，及时发现系统中出现的延迟升高问题并找出系统性能瓶颈的根源。除了面向开发的 API 接口之外，它还提供了方便的 UI 组件，每个服务向 Zipkin 报告计时数据，Zipkin 会根据调用关系生成依赖关系图，帮助我们直观的搜索跟踪信息和分析请求链路明细。Zipkin 提供了可插拔数据存储方式：In-Memory、MySql、Cassandra 以及 Elasticsearch。</p>
<p>分布式跟踪系统还有其他比较成熟的实现，例如：Naver 的 PinPoint、Apache 的 HTrace、阿里的鹰眼 Tracing、京东的 Hydra、新浪的 Watchman，美团点评的 CAT，Apache 的 SkyWalking 等。</p>
<p><a target="_blank" rel="noopener" href="https://mrhelloworld.com/resources/articles/spring/spring-cloud/sleuth/v2-a32471042408c726c7c944456f8e1e34_hd.jpg"><img src="https://mrhelloworld.com/resources/articles/spring/spring-cloud/sleuth/v2-a32471042408c726c7c944456f8e1e34_hd.jpg" alt="/resources/articles/spring/spring-cloud/sleuth/v2-a32471042408c726c7c944456f8e1e34_hd.jpg"></a></p>
<p></p>
<h4 id="工作原理">工作原理</h4>
<p></p>
<p><a target="_blank" rel="noopener" href="https://mrhelloworld.com/resources/articles/spring/spring-cloud/sleuth/zipkin.jpg"><img src="https://mrhelloworld.com/resources/articles/spring/spring-cloud/sleuth/zipkin.jpg" alt="/resources/articles/spring/spring-cloud/sleuth/zipkin.jpg"></a></p>
<p>共有四个组件构成了 Zipkin：</p>
<ul>
<li><code>Collector</code>：收集器组件，处理从外部系统发送过来的跟踪信息，将这些信息转换为 Zipkin 内部处理的 Span 格式，以支持后续的存储、分析、展示等功能。</li>
<li><code>Storage</code>：存储组件，处理收集器接收到的跟踪信息，默认将信息存储在内存中，可以修改存储策略使用其他存储组件，支持 MySQL，Elasticsearch 等。</li>
<li><code>Web UI</code>：UI 组件，基于 API 组件实现的上层应用，提供 Web 页面，用来展示 Zipkin 中的调用链和系统依赖关系等。</li>
<li><code>RESTful API</code>：API 组件，为 Web 界面提供查询存储中数据的接口。</li>
</ul>
<p></p>
<p>Zipkin 分为两端，一个是 Zipkin 服务端，一个是 Zipkin 客户端，客户端也就是微服务的应用，客户端会配置服务端的 URL 地址，一旦发生服务间的调用的时候，会被配置在微服务里面的 Sleuth 的监听器监听，并生成相应的 Trace 和 Span 信息发送给服务端。发送的方式有两种，一种是消息总线的方式如 RabbitMQ 发送，还有一种是 HTTP 报文的方式发送。</p>
<h4 id="前置准备"><strong>前置准备</strong></h4>
<p>这里我们使用<code>Elasticsearch </code>作为<code>ZipKin</code>的持久化库,使用<code>RabbitMQ</code>作为客户端和服务端消息传递的方式</p>
<p>注意:<code>Elasticsearch </code>和其可视化工具<code>Kibana</code>的<font color="red">大版本需要保持一致</font></p>
<p><strong>Elasticsearch</strong></p>
<p>dockerhub:<a target="_blank" rel="noopener" href="https://registry.hub.docker.com/_/elasticsearch?tab=description">https://registry.hub.docker.com/_/elasticsearch?tab=description</a></p>
<ul>
<li>拉取镜像</li>
</ul>
<blockquote>
<p>docker pull elasticsearch:7.14.2</p>
</blockquote>
<ul>
<li>启动服务</li>
</ul>
<blockquote>
<p>docker run -d --name elasticsearch --net ESwork -p 9200:9200 -p 9300:9300 -e “discovery.type=single-node” elasticsearch:7.14.2</p>
</blockquote>
<p>访问URL<code>192.168.32.131:9200</code>验证是否启动成功</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211023235811506.png" alt="image-20211023235811506"></p>
<p><strong>Kibana</strong></p>
<p>文档:<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/kibana/current/index.html">https://www.elastic.co/guide/cn/kibana/current/index.html</a></p>
<p>dockerhub:<a target="_blank" rel="noopener" href="https://registry.hub.docker.com/_/kibana?tab=description">https://registry.hub.docker.com/_/kibana?tab=description</a></p>
<ul>
<li>拉取镜像</li>
</ul>
<blockquote>
<p>docker pull kibana:7.14.2</p>
</blockquote>
<ul>
<li>启动服务</li>
</ul>
<blockquote>
<p>docker run -d --name kibana --net ESwork -p 5601:5601 -e ELASTICSEARCH_URL=192.168.32.131:9200 kibana:7.14.2</p>
</blockquote>
<ul>
<li>进入<code>Kibana</code>服务修改配置文件，设置<code>Elasticsearch</code>地址</li>
</ul>
<blockquote>
<p>docker   exec   -it   kibana bash</p>
<p>vi   /usr/share/kibana/config/kibana.yml</p>
</blockquote>
<p>​		将红框部分设置为<code>Elasticsearch</code>集群地址</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211023232332840.png" alt="image-20211023232332840"></p>
<p>接下来我们只需访问<code>http://192.168.32.131:5601</code>，点击左侧菜单的<code>Dev Tools</code>即可查询<code>Elasticsearch</code></p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211023232508959.png" alt="image-20211023232508959"></p>
<p><strong>RabbitMQ</strong></p>
<ul>
<li>拉取服务</li>
</ul>
<blockquote>
<p>docker pull rabbitmq:3-management</p>
</blockquote>
<ul>
<li>启动服务</li>
</ul>
<blockquote>
<p>docker run -d --name rabbit -p 5672:5762 -p 15672:15672 rabbitmq:3-management</p>
</blockquote>
<h4 id="安装ZipKin">安装ZipKin</h4>
<p>文档:<a target="_blank" rel="noopener" href="https://zipkin.io/">https://zipkin.io/</a></p>
<p>dockerhub:<a target="_blank" rel="noopener" href="https://registry.hub.docker.com/r/openzipkin/zipkin">https://registry.hub.docker.com/r/openzipkin/zipkin</a></p>
<ul>
<li>docker获取镜像</li>
</ul>
<blockquote>
<p>docker pull openzipkin/zipkin</p>
</blockquote>
<ul>
<li>启动服务</li>
</ul>
<blockquote>
<p>docker run -d -p 9411:9411 --name zipkin  -e ES_HOSTS=192.168.32.131 -e STORAGE_TYPE=elasticsearch -e ES_HTTP_LOGGING=BASIC -e RABBIT_URI=amqp://xpp011:xpp011@192.168.32.131:5672 openzipkin/zipkin:latest</p>
<ul>
<li>ES_HOSTS                            Elasticsearch服务地址</li>
<li>STORAGE_TYPE                   数据存储方式</li>
<li>ES_HTTP_LOGGING            日志打印级别</li>
<li><font color="red">RABBIT_URI</font>                        Rabbit连接地址 (amqp://账号:密码@连接地址)</li>
</ul>
</blockquote>
<p>访问URL<code>http://192.168.32.131:9411/zipkin</code>，验证是否启动成功</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211023235840371.png" alt="image-20211023235840371"></p>
<h4 id="创建ZipKin客户端">创建ZipKin客户端</h4>
<p><img src="https://mrhelloworld.com/resources/articles/spring/spring-cloud/sleuth/1569484-20190414155801823-317987095.png" alt="/resources/articles/spring/spring-cloud/sleuth/1569484-20190414155801823-317987095.png"></p>
<p><strong>引入以下依赖</strong></p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211024174147995.png" alt="image-20211024174147995"></p>
<p><strong>配置以下信息</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sleuth</span>                           <span class="comment">#服务名称</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span>                             <span class="comment">#rabbit端口</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.131</span>                   <span class="comment">#rabbit地址</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">xpp011</span>                       <span class="comment">#用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xpp011</span>                       <span class="comment">#密码</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">sender:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">rabbit</span>                         <span class="comment">#zipkin消息发送类型</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://192.168.32.131:9411</span>   <span class="comment">#zipkin地址</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1.0</span>                     <span class="comment">#数据收集采样率(默认0.1:10%) 过高的采样率会导致zipkin和sleuth过载</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2222</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1111/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>                <span class="comment">#是否将服务ip显示至注册中心</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>可视化</strong></p>
<p>配置完成后我们可以启动该服务</p>
<p>访问zipkin地址<code>http://192.168.32.131:9411/zipkin</code>,即可看到访问信息</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211024225729852.png" alt="image-20211024225729852"></p>
<p><strong>持久化</strong></p>
<p>查看Kibana<code>http://192.168.32.131:5601/</code>，根据图片菜单 查看<code>Elasticsearch</code>指标信息</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211024230719477.png" alt="image-20211024230719477"></p>
<h2 id="十六，Alibbaba">十六，Alibbaba</h2>
<h3 id="简介-12">简介</h3>
<p>Spring Cloud Alibaba 致力于提供微服务开发的一站式解决方案。此项目包含开发分布式应用微服务的必需组件，方便开发者通过 Spring Cloud 编程模型轻松使用这些组件来开发分布式应用服务。</p>
<p>依托 Spring Cloud Alibaba，只需要添加一些注解和少量配置，就可以将 Spring Cloud 应用接入阿里微服务解决方案，通过阿里中间件来迅速搭建分布式应用系统。</p>
<p></p>
<h3 id="Spring-Cloud-Alibaba-功能">Spring Cloud Alibaba 功能</h3>
<p></p>
<ol>
<li><strong>服务限流降级 Sentinel</strong>：支持 WebServlet，WebFlux，OpenFeign，RestTemplate，Dubbo，Gateway，Zuul 限流降级功能的接入。可以在运行时通过控制台实时修改限流降级规则，并且还支持限流降级度量指标监控。</li>
<li><strong>服务注册与发现 Nacos</strong>：适配 Spring Cloud 服务注册与发现标准，默认集成了 Ribbon 的支持。</li>
<li><strong>分布式配置管理 Nacos</strong>：支持分布式系统中的外部化配置，配置更改时自动刷新。</li>
<li><strong>RPC 服务 Dubbo</strong>：扩展 Spring Cloud 客户端 RestTemplate 和 OpenFeign 以支持调用 Dubbo RPC 服务。</li>
<li><strong>消息驱动 RocketMQ</strong>：基于 Spring Cloud Stream 为微服务应用构建消息驱动能力。</li>
<li><strong>分布式事务 Seata</strong>：支持高性能且易于使用的分布式事务解决方案。</li>
<li><strong>阿里云对象存储 OSS</strong>：大规模，安全，低成本，高度可靠的云存储服务。支持随时随地在任何应用程序中存储和访问任何类型的数据。</li>
<li><strong>分布式任务调度 SchedulerX</strong>：提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。同时提供分布式的任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有 Worker（schedulerx-client）上执行。</li>
<li><strong>阿里云短信服务 SMS</strong>：覆盖全球的短信服务，友好、高效、智能的通讯能力，帮助企业迅速搭建客户触达通道。</li>
</ol>
<p></p>
<h3 id="Spring-Cloud-Alibaba-组件">Spring Cloud Alibaba 组件</h3>
<p></p>
<ul>
<li><code>Nacos</code>：阿里巴巴开源产品，一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</li>
<li><code>Sentinel</code>：面向分布式服务架构的轻量级流量控制产品，把流量作为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</li>
<li><code>RocketMQ</code>：一款开源的分布式消息系统，基于高可用分布式集群技术，提供低延时的、高可靠的消息发布与订阅服务。</li>
<li><code>Dubbo</code>：Apache Dubbo™ 是一款高性能 Java RPC 框架。</li>
<li><code>Seata</code>：阿里巴巴开源产品，一个易于使用的高性能微服务分布式事务解决方案。</li>
<li><code>Alibaba Cloud ACM</code>：一款在分布式架构环境中对应用配置进行集中管理和推送的应用配置中心产品。</li>
<li><code>Alibaba Cloud OSS</code>：阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。您可以在任何应用、任何时间、任何地点存储和访问任意类型的数据。</li>
<li><code>Alibaba Cloud SchedulerX</code>：阿里中间件团队开发的一款分布式任务调度产品，提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。</li>
<li><code>Alibaba Cloud SMS</code>：覆盖全球的短信服务，友好、高效、智能的互联化通讯能力，帮助企业迅速搭建客户触达通道。</li>
</ul>
<p></p>
<h3 id="什么是注册中心">什么是注册中心</h3>
<p></p>
<p>服务注册中心是服务实现服务化管理的核心组件，类似于目录服务的作用，主要用来存储服务信息，譬如提供者 url 串、路由信息等。服务注册中心是微服务架构中最基础的设施之一。</p>
<p>注册中心可以说是微服务架构中的“通讯录”，它记录了服务和服务地址的映射关系。在分布式架构中，服务会注册到这里，当服务需要调用其它服务时，就到这里找到服务的地址，进行调用。</p>
<p>简单理解就是：在没有注册中心时候，服务间调用需要知道被当服务调方的具体地址（写死的 ip:port）。更换部署地址，就不得不修改调用当中指定的地址。而有了注册中心之后，每个服务在调用别人的时候只需要知道服务名称（软编码）就好，地址都会通过注册中心根据服务名称获取到具体的服务地址进行调用。</p>
<p><a target="_blank" rel="noopener" href="https://mrhelloworld.com/resources/articles/spring/spring-cloud/nacos/timg.jpg"><img src="https://mrhelloworld.com/resources/articles/spring/spring-cloud/nacos/timg.jpg" alt="/resources/articles/spring/spring-cloud/nacos/timg.jpg"></a></p>
<p>举个现实生活中的例子，比如说，我们手机中的通讯录的两个使用场景：</p>
<blockquote>
<p>当我想给张三打电话时，那我需要在通讯录中按照名字找到张三，然后就可以找到他的手机号拨打电话。—— 服务发现</p>
<p>李四办了手机号并把手机号告诉了我，我把李四的号码存进通讯录，后续，我就可以从通讯录找到他。—— 服务注册</p>
<p>通讯录 —— ？什么角色（服务注册中心）</p>
</blockquote>
<p>总结：服务注册中心的作用就是<strong>服务的注册</strong>和<strong>服务的发现</strong>。</p>
<p></p>
<h4 id="常见的注册中心">常见的注册中心</h4>
<p></p>
<ul>
<li>Netflix Eureka</li>
<li>Alibaba Nacos</li>
<li>HashiCorp Consul</li>
<li>Apache ZooKeeper</li>
<li>CoreOS Etcd</li>
<li>CNCF CoreDNS</li>
</ul>
<p></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Eureka</th>
<th>Nacos</th>
<th>Consul</th>
<th>Zookeeper</th>
</tr>
</thead>
<tbody>
<tr>
<td>CAP</td>
<td>AP</td>
<td>CP + AP</td>
<td>CP</td>
<td>CP</td>
</tr>
<tr>
<td>健康检查</td>
<td>Client Beat</td>
<td>TCP/HTTP/MYSQL/Client Beat</td>
<td>TCP/HTTP/gRPC/Cmd</td>
<td>Keep Alive</td>
</tr>
<tr>
<td>雪崩保护</td>
<td>有</td>
<td>有</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>自动注销实例</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>访问协议</td>
<td>HTTP</td>
<td>HTTP/DNS</td>
<td>HTTP/DNS</td>
<td>TCP</td>
</tr>
<tr>
<td>监听支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>多数据中心</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>跨注册中心同步</td>
<td>不支持</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>SpringCloud集成</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
</tbody>
</table>
<p></p>
<h4 id="为什么需要注册中心">为什么需要注册中心</h4>
<p></p>
<p>了解了什么是注册中心，那么我们继续谈谈，为什么需要注册中心。在分布式系统中，我们不仅仅是需要在注册中心找到服务和服务地址的映射关系这么简单，我们还需要考虑更多更复杂的问题：</p>
<ul>
<li>服务注册后，如何被及时发现</li>
<li>服务宕机后，如何及时下线</li>
<li>服务如何有效的水平扩展</li>
<li>服务发现时，如何进行路由</li>
<li>服务异常时，如何进行降级</li>
<li>注册中心如何实现自身的高可用</li>
</ul>
<p>这些问题的解决都依赖于注册中心。简单看，注册中心的功能有点类似于 DNS 服务器或者负载均衡器，而实际上，注册中心作为微服务的基础组件，可能要更加复杂，也需要更多的灵活性和时效性。所以我们还需要学习更多 Spring Cloud 微服务组件协同完成应用开发。</p>
<p></p>
<p>注册中心解决了以下问题：</p>
<ul>
<li>服务管理</li>
<li>服务之间的自动发现</li>
<li>服务的依赖关系管理</li>
</ul>
<p></p>
<h3 id="Nacos">Nacos</h3>
<p>文档:<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/what-is-nacos.html">什么是 Nacos</a></p>
<h4 id="简介-13">简介</h4>
<p>Nacos 是 Alibaba 公司推出的开源工具，用于实现分布式系统的服务发现与配置管理。英文全称 Dynamic Naming and Configuration Service，Na 为 Naming/NameServer 即注册中心，co 为 Configuration 即配置中心，Service 是指该注册/配置中心都是以服务为核心。服务（Service）是 Nacos 世界的一等公民。</p>
<blockquote>
<p>官网是这样说的：一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</p>
</blockquote>
<p>Nacos 致力于发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，可以快速实现动态服务发现、服务配置、服务元数据及流量管理。</p>
<p>Nacos 可以更敏捷和容易地构建、交付和管理微服务平台。 Nacos 是构建以“服务”为中心的现代应用架构的服务基础设施。</p>
<p>使用 Nacos 简化服务发现、配置管理、服务治理及管理的解决方案，让微服务的发现、管理、共享、组合更加容易。</p>
<p>Nacos 官网：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/">https://nacos.io/zh-cn/</a></p>
<p>Github：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos">https://github.com/alibaba/nacos</a></p>
<h4 id="安装-2">安装</h4>
<p><strong>docker安装</strong></p>
<blockquote>
<p>docker run --name nacos-e MODE=standalone -p 8848:8848 -d nacos/nacos-server:2.0.2</p>
</blockquote>
<p><strong>jar</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases%EF%BC%8C%E5%9C%A8Girhub%E4%B8%AD%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%8F%96%E5%90%84%E4%B8%AA%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6">https://github.com/alibaba/nacos/releases，在Girhub中可以获取各个环境的安装文件</a></p>
<p>环境</p>
<ul>
<li>JDK1.8+</li>
<li>Maven2.3+</li>
</ul>
<p>windowns将zip解压后，进入<code>bin</code>目录双击<code>startup.cmd</code>文件即可</p>
<p>访问<code>http://loaclhost:8848/nacos</code>,输入账户和密码(都是<code>nacos</code>)</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211028223900047.png" alt="image-20211028223900047"></p>
<h5 id="配置中心">配置中心</h5>
<p>在使用客户端拉取配置之前，我们需要先在<code>nacos</code>创建一个配置</p>
<p><strong>配置集 ID</strong></p>
<p>Nacos 中的某个配置集的 ID。配置集 ID 是组织划分配置的维度之一。Data ID 通常用于组织划分系统的配置集。一个系统或者应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识。Data ID 通常采用类 Java 包（如 com.taobao.tc.refund.log.level）的命名规则保证全局唯一性。此命名规则非强制。</p>
<p><strong>配置分组</strong></p>
<p>Nacos 中的一组配置集，是组织配置的维度之一。通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 DEFAULT_GROUP 。配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。</p>
<p>可以看到我们配置了一个名称为<code>example.yaml</code>分组为<code>DEFAULT_GREP</code>的配置文件</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211031175252944.png" alt="image-20211031175252944"></p>
<h4 id="nacos客户端">nacos客户端</h4>
<p>我们创建一个Spring项目,引入以下依赖</p>
<ul>
<li>spring-cloud-starter-bootstrap</li>
<li>spring-cloud-starter-alibaba-nacos-config</li>
<li>spring-boot-starter-web</li>
</ul>
<p>以下注释还对SpringCloud项目依赖结果做了说明</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--继承spring-boot-starter-parent的依赖--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--使用继承方式，实现复用，符合继承的都可以被使用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--项目坐标--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--模块名称--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--项目版本  SNAPSHOT快照版  RELEASE正式版 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nacos<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Nacos<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        集中定义依赖组件版本号，但不引入，</span></span><br><span class="line"><span class="comment">        在子工程中用到声明的依赖时，可以不加依赖的版本号，</span></span><br><span class="line"><span class="comment">        这样可以统一管理工程中用到的依赖版本</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--JDK版本--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-cloud版本号 Ilford版--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>2020.0.3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--项目依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 项目依赖管理 父项目只是声明依赖，子项目需要写明需要的依赖(可以省略版本信息) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--SpringCloud依赖--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<p>Server端安装启动完成后，我们开始创建客户端,针对<code>nacos</code>进行服务发现和配置拉取</p>
<h5 id="配置拉取"><strong>配置拉取</strong></h5>
<p>由于配置信息在配置中心中，启动时需要提取配置信息加载<code>applicat.yml</code>的配置，Spring提供了<code>booystrap.yml</code>引导配置文件</p>
<p>在<code>bootstrap.yml</code>中我需要提前申明应用名称，以及配置中心地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.131</span><span class="string">:8849</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br></pre></td></tr></table></figure>
<p>配置完成后就可以在配置中心拉取配置了</p>
<p>当然配置中心也支持不同环境<code>$&#123;spring.application.name&#125;-$&#123;profile&#125;.$&#123;file-extension:properties&#125;</code>的配置文件</p>
<p>我们在配置文件中配置<code>$&#123;spring.profiles.active&#125;</code>即可确认活跃的配置文件是那一项</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211031215829446.png" alt="image-20211031215829446"></p>
<h5 id="配置中心-2">配置中心</h5>
<p>nacos的配置中心和注册中心是一起的</p>
<p>这边我们直接在客户端导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>简单的配置<code>$&#123;spring.cloud.discovery.server-addr&#125;</code>注册中心地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment">#注册中心地址</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.131</span><span class="string">:8849</span></span><br></pre></td></tr></table></figure>
<p>查看<code>nacos</code>就可以发现服务已经注册上去了</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211031222347831.png" alt="image-20211031222347831"></p>
<h3 id="Sentinel">Sentinel</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/139b03e652059e88c8bdadc3722cc5c554a348d5/spring-cloud-alibaba-docs/src/main/asciidoc-zh/sentinel.adoc">文档</a></p>
<p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">Sentinel</a> 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">Sentinel</a> 具有以下特征:</p>
<ul>
<li><strong>丰富的应用场景</strong>： Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、实时熔断下游不可用应用等。</li>
<li><strong>完备的实时监控</strong>： Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li>
<li><strong>广泛的开源生态</strong>： Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li>
<li><strong>完善的 SPI 扩展点</strong>： Sentinel 提供简单易用、完善的 SPI 扩展点。您可以通过实现扩展点，快速的定制逻辑。例如定制规则管理、适配数据源等。</li>
</ul>
<h4 id="控制台">控制台</h4>
<p>Sentinel 控制台提供一个轻量级的控制台，它提供机器发现、单机资源实时监控、集群资源汇总，以及规则管理的功能。您只需要对应用进行简单的配置，就可以使用这些功能。</p>
<p>下载地址:<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a></p>
<p>下载完成后我们启动它</p>
<blockquote>
<p>java -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.8.2.jar</p>
</blockquote>
<p>访问<code>192.168.32.131:8080</code></p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211031231823009.png" alt="image-20211031231823009"></p>
<h4 id="客户端">客户端</h4>
<p>创建客户端连接到<code>Sentinel</code>控制台.</p>
<p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-sentinel --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>	</span><br></pre></td></tr></table></figure>
<p>配置<code>Sentinel</code>相关信息</p>
<ul>
<li>
<p><code>spring.cloud.sentinel.transport.port</code></p>
<blockquote>
<p>端口配置会在应用对应的机器上启动一个 Http Server，该 Server 会与 Sentinel 控制台做交互。比如 Sentinel 控制台添加了1个限流规则，会把规则数据 push 给这个 Http Server 接收，Http Server 再将规则注册到 Sentinel 中。</p>
</blockquote>
</li>
<li>
<p><code>spring.cloud.sentinel.transport.dashboard</code></p>
<blockquote>
<p>控制台地址</p>
</blockquote>
</li>
<li>
<p><code>spring.cloud.sentinel.log.dir</code></p>
<blockquote>
<p>日志输出地址</p>
</blockquote>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment">#会在该端口创建一个HTTP Server来保持与Sentinel通信</span></span><br><span class="line">        <span class="comment">#比如Sentinel的限流规则，该服务健康信息</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line">        <span class="comment">#Sentinel控制台地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">192.168</span><span class="number">.32</span><span class="number">.131</span><span class="string">:8080</span></span><br><span class="line">      <span class="attr">log:</span></span><br><span class="line">        <span class="comment">#日志输出地址</span></span><br><span class="line">        <span class="attr">dir:</span> <span class="string">D:\log\sentinel</span></span><br></pre></td></tr></table></figure>
<p>创建测试的Controller</p>
<ul>
<li>
<p><code>@SentinelResource</code></p>
<blockquote>
<p>@SentinelResource 注解用来标识资源是否被限流、降级。上述例子上该注解的属性 ‘hello’ 表示资源名。</p>
<p>@SentinelResource 还提供了其它额外的属性如 <code>blockHandler</code>，<code>blockHandlerClass</code>，<code>fallback</code> 用于表示限流或降级的操作，更多内容可以参考 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81">Sentinel注解支持</a>。</p>
</blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="comment">//@SentinelResource 注解用来标识资源是否被限流、降级。上述例子上该注解的属性 &#x27;hello&#x27; 表示资源名。</span></span><br><span class="line">    <span class="meta">@SentinelResource(&quot;hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;你好&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们的客户端就创建好了</p>
<p>注意当我们启动服务后，在控制台没有看到该服务，可以尝试请求一下服务接口，激活一下</p>
<h4 id="控制台创建规则">控制台创建规则</h4>
<p>在簇点链路菜单下可以针对某一资源创建<code>限流</code>、<code>熔断策略</code>、<code>热点</code>、<code>授权</code>等操作</p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211101211125724.png" alt="image-20211101211125724"></p>
<p>创建<code>限流规则</code></p>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211101210710702.png" alt="image-20211101210710702"></p>
<p><strong>测试</strong></p>
<p>我们连续接口<code>hello</code>15次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">        String rsp = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/hello&quot;</span>, String.class);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> Date()+rsp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://typora.xpp011.cn/typora/img/image-20211101211632460.png" alt="image-20211101211632460"></p>
<p>可以看到控制台是每一秒打印两次，也就是接口每一秒受理两次请求</p>

    </div>

    
    
    
    
    <div>
	    
		    
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
   <!-- JS库 sweetalert 引用本地路径 -->
  <script src="/js/sweetalert.min.js"></script>
  <p><span>文章作者:</span><a href="/" title="访问 xpp011 的个人博客">xpp011</a></p>
  <p><span>发布时间:</span>2021年11月04日 - 00:11</p>
  <p><span>原始链接:</span><a href="/2021/11/04/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="SpringCloud学习笔记">http://xpp011.cn/2021/11/04/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://xpp011.cn/2021/11/04/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
      $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
        });
    });  
</script>


	    
    </div>
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    赏个鸡腿? 半个也行!
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="xpp011 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="xpp011 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"><i class="fa fa-tag"></i> 笔记</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2021/11/04/hello-world/" rel="next" title="HelloWord">
      HelloWord <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#CAP-%E5%8E%9F%E5%88%99%E4%B8%8E-BASE-%E7%90%86%E8%AE%BA"><span class="nav-text">CAP 原则与 BASE 理论</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CAP-%E5%8E%9F%E5%88%99"><span class="nav-text">CAP 原则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CAP%E7%9A%84%E8%AF%81%E6%98%8E"><span class="nav-text">CAP的证明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%96%E8%88%8D%E7%AD%96%E7%95%A5"><span class="nav-text">取舍策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BASE-%E7%90%86%E8%AE%BA"><span class="nav-text">BASE 理论</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Basically-Available%EF%BC%88%E5%9F%BA%E6%9C%AC%E5%8F%AF%E7%94%A8%EF%BC%89"><span class="nav-text">Basically Available（基本可用）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Soft-state%EF%BC%88%E8%BD%AF%E7%8A%B6%E6%80%81%EF%BC%89"><span class="nav-text">Soft state（软状态）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Eventually-consistent%EF%BC%88%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%89"><span class="nav-text">Eventually consistent（最终一致性）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-2"><span class="nav-text">总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%EF%BC%8C%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="nav-text">一，微服务介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-text">什么是微服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E4%BD%93%E5%BA%94%E7%94%A8"><span class="nav-text">单体应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-text">微服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%B8%E5%9E%8B%E6%9E%B6%E6%9E%84"><span class="nav-text">微服务典型架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6"><span class="nav-text">微服务框架</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%EF%BC%8CSpringCloud%E4%BB%8B%E7%BB%8D"><span class="nav-text">二，SpringCloud介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFSpring-cloud"><span class="nav-text">什么是Spring cloud</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Cloud-%E7%9A%84%E7%89%88%E6%9C%AC"><span class="nav-text">Spring Cloud 的版本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%EF%BC%8CEureka"><span class="nav-text">三，Eureka</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94Eureka"><span class="nav-text">Spring Cloud 的服务发现框架——Eureka</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%92%E8%89%B2"><span class="nav-text">角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">基础概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka%E6%9E%B6%E6%9E%84"><span class="nav-text">Eureka架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka-%E4%B8%8E-Zookeeper-%E5%AF%B9%E6%AF%94"><span class="nav-text">Eureka 与 Zookeeper 对比</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAEurekaServer"><span class="nav-text">创建EurekaServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Eureka%E9%9B%86%E7%BE%A4"><span class="nav-text">Eureka集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAEurekaClient"><span class="nav-text">创建EurekaClient</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Provider"><span class="nav-text">Provider</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Consumer"><span class="nav-text">Consumer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1Ribbon"><span class="nav-text">客户端负载均衡Ribbon</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-RestTemplate"><span class="nav-text">什么是 RestTemplate?</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-Ribbon%EF%BC%9F"><span class="nav-text">为什么需要 Ribbon？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Nginx-%E5%92%8C-Ribbon-%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="nav-text">Nginx 和 Ribbon 的对比</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Ribbon-%E7%9A%84%E5%87%A0%E7%A7%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="nav-text">Ribbon 的几种负载均衡算法</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#a-name-ribbon-%E5%9B%9B%EF%BC%8CRibbon%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-a"><span class="nav-text">四，Ribbon源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%8E%E6%A0%B7%E4%BD%BF%E7%94%A8Spring-cloud-ribbon"><span class="nav-text">怎样使用Spring cloud ribbon</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%AF%B9%E5%BA%94%E4%BE%9D%E8%B5%96"><span class="nav-text">添加对应依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-text">定义配置类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#properties%E6%96%87%E4%BB%B6"><span class="nav-text">properties文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AAController-Ribbon-Client%E7%AB%AF"><span class="nav-text">定义一个Controller(Ribbon-Client端)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%AB%AFServer%E4%BB%A3%E7%A0%81-8081%E3%80%818082"><span class="nav-text">后端Server代码(8081、8082)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ribbon%E5%8E%9F%E7%90%86%E6%A6%82%E8%A7%88"><span class="nav-text">Ribbon原理概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-LoadBalanced%E6%B3%A8%E8%A7%A3%E6%A0%87%E8%AE%B0%E7%9A%84RestTemplate%E3%80%82"><span class="nav-text">获取@LoadBalanced注解标记的RestTemplate。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RestTemplate%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%8B%A6%E6%88%AA%E5%99%A8-filter"><span class="nav-text">RestTemplate添加一个拦截器(filter)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-text">定义一个拦截器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86%E6%8B%A6%E6%88%AA%E5%99%A8%E6%B7%BB%E5%8A%A0%E5%88%B0RestTemplate%E4%B8%AD"><span class="nav-text">将拦截器添加到RestTemplate中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ribbon%E9%80%89%E5%8F%96server%E5%8E%9F%E7%90%86%E6%A6%82%E8%A7%88"><span class="nav-text">Ribbon选取server原理概览</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%EF%BC%8CConsul"><span class="nav-text">五，Consul</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Consul-%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="nav-text">使用Consul 的优势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consul-%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">Consul 的调用过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consul-%E5%92%8C-eureka%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="nav-text">Consul 和 eureka的对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#windows%E5%AE%89%E8%A3%85"><span class="nav-text">windows安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux%E5%AE%89%E8%A3%85"><span class="nav-text">Linux安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"><span class="nav-text">注册服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%89%88"><span class="nav-text">集群版</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%EF%BC%8CHystrix"><span class="nav-text">六，Hystrix</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-text">Hystrix是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix%E4%B8%BA%E4%BA%86%E4%BB%80%E4%B9%88"><span class="nav-text">Hystrix为了什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix%E8%A7%A3%E5%86%B3%E4%BA%86%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98"><span class="nav-text">Hystrix解决了什么问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-text">Hystrix设计原则是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%AE%83%E7%9A%84%E7%9B%AE%E6%A0%87%E7%9A%84"><span class="nav-text">Hystrix是如何实现它的目标的</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%EF%BC%8COpenFeign"><span class="nav-text">八，OpenFeign</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BAOpenFigen%E5%BA%94%E7%94%A8"><span class="nav-text">构建OpenFigen应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%A7%E6%89%BF%E7%89%B9%E6%80%A7"><span class="nav-text">继承特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97"><span class="nav-text">日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%8E%8B%E7%BC%A9"><span class="nav-text">数据压缩</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%EF%BC%8CResilience4j"><span class="nav-text">九，Resilience4j</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-4"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CircuitBreaker"><span class="nav-text">CircuitBreaker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-5"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="nav-text">创建和配置断路器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96"><span class="nav-text">依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java%E9%85%8D%E7%BD%AE%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="nav-text">java配置断路器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CircuitBreaker%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-text">CircuitBreaker工具类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOP%E5%BC%8F%E8%B0%83%E7%94%A8CircuitBreaker"><span class="nav-text">AOP式调用CircuitBreaker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-3"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ratelimiter"><span class="nav-text">Ratelimiter</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-6"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="nav-text">可配置参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pom%E4%BE%9D%E8%B5%96"><span class="nav-text">pom依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java%E9%85%8D%E7%BD%AERatelimiter"><span class="nav-text">java配置Ratelimiter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RateLimiter%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-text">RateLimiter工具类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOP%E5%BC%8F%E8%B0%83%E7%94%A8RateLimiter"><span class="nav-text">AOP式调用RateLimiter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-4"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Retry"><span class="nav-text">Retry</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-7"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E9%85%8D%E7%BD%AERetry"><span class="nav-text">创建和配置Retry</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pom%E4%BE%9D%E8%B5%96-2"><span class="nav-text">pom依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Java%E9%85%8D%E7%BD%AERetry"><span class="nav-text">Java配置Retry</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Retry%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-text">Retry工具类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOP%E5%BC%8F%E8%B0%83%E7%94%A8ReTry"><span class="nav-text">AOP式调用ReTry</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ReTry%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-text">ReTry控制器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-5"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Resilience4j%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">Resilience4j配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7"><span class="nav-text">十，服务监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Prometheus"><span class="nav-text">Prometheus</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%AE%89%E8%A3%85"><span class="nav-text">简单安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Security%E9%85%8D%E7%BD%AE"><span class="nav-text">Security配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grafana"><span class="nav-text">Grafana</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Docker%E5%AE%89%E8%A3%85"><span class="nav-text">Docker安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0Prometheus%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-text">添加Prometheus数据源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="nav-text">添加仪表盘</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="nav-text">十一，服务网关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E5%85%B3%E7%AE%80%E4%BB%8B"><span class="nav-text">网关简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="nav-text">一、什么是服务网关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="nav-text">二、为什么需要服务网关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="nav-text">三、服务网关技术选型</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%E3%80%81%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="nav-text">1、总体流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E3%80%81%E5%BC%95%E5%85%A5%E7%BD%91%E5%85%B3%E7%9A%84%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="nav-text">2、引入网关的注意点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%E3%80%81%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD"><span class="nav-text">3、服务网关基本功能</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gateway"><span class="nav-text">Gateway</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-8"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%82%B9"><span class="nav-text">优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RouteProperties%E5%8C%B9%E9%85%8D"><span class="nav-text">RouteProperties匹配</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%8C%B9%E9%85%8D"><span class="nav-text">时间匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Cookie%E5%8C%B9%E9%85%8D"><span class="nav-text">Cookie匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Host%E5%8C%B9%E9%85%8D"><span class="nav-text">Host匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F%E5%8C%B9%E9%85%8D"><span class="nav-text">通过请求方式匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E8%AF%B7%E6%B1%82%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D"><span class="nav-text">通过请求路径匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E5%8C%B9%E9%85%8D"><span class="nav-text">通过请求参数匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E8%AF%B7%E6%B1%82-ip-%E5%9C%B0%E5%9D%80%E8%BF%9B%E8%A1%8C%E5%8C%B9%E9%85%8D"><span class="nav-text">通过请求 ip 地址进行匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9D%83%E9%87%8D%E8%B7%AF%E7%94%B1%E5%8C%B9%E9%85%8D"><span class="nav-text">权重路由匹配</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E5%90%88Eureka%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-text">结合Eureka注册中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Filter%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-text">Filter过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Http%E8%B6%85%E6%97%B6%E9%85%8D%E7%BD%AE"><span class="nav-text">Http超时配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E8%B6%85%E6%97%B6%E9%85%8D%E7%BD%AE"><span class="nav-text">全局超时配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%89%B9%E5%AE%9A%E8%B7%AF%E7%94%B1%E8%A6%86%E7%9B%96"><span class="nav-text">特定路由覆盖</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%EF%BC%8CSpringCoudConfig"><span class="nav-text">十二，SpringCoudConfig</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-9"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConfigServer"><span class="nav-text">ConfigServer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BASpring-Clod-Config-Server%E6%9C%8D%E5%8A%A1"><span class="nav-text">创建Spring Clod Config Server服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConfigClient"><span class="nav-text">ConfigClient</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="nav-text">创建项目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%8E%A5%E5%8F%A3"><span class="nav-text">验证接口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AFeureka"><span class="nav-text">获取配置信息eureka</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E5%8A%A0%E8%A7%A3%E5%AF%86"><span class="nav-text">配置文件的加解密</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E5%8A%A0%E5%AF%86%E6%96%B9%E6%B3%95"><span class="nav-text">常见加密方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86"><span class="nav-text">对称加密</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86"><span class="nav-text">非对称加密</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86"><span class="nav-text">安全管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="nav-text">动态刷新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Autuator%E5%AE%9E%E7%8E%B0"><span class="nav-text">Autuator实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%87%8D%E8%AF%95"><span class="nav-text">客户端重试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="nav-text">快速失败</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E9%87%8D%E8%AF%95"><span class="nav-text">请求重试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%EF%BC%8CSpringCloudBus"><span class="nav-text">十三，SpringCloudBus</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-text">快速入门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BA%BF%E7%AB%AF%E7%82%B9"><span class="nav-text">总线端点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#busrefresh"><span class="nav-text">busrefresh</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#busrefresh-2"><span class="nav-text">busrefresh&#x2F;**</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B"><span class="nav-text">实例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E5%9B%9B%EF%BC%8CSpringCloudStream"><span class="nav-text">十四，SpringCloudStream</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="nav-text">快速开始</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%80%9A%E9%81%93"><span class="nav-text">自定义通道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%BB%84"><span class="nav-text">分组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8C%BA"><span class="nav-text">分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81%E5%88%B0Supplier"><span class="nav-text">外部数据发送到Supplier</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#StreamBridge"><span class="nav-text"> StreamBridge</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EmitterProcessor"><span class="nav-text">EmitterProcessor</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%94%EF%BC%8C%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span class="nav-text">十五，链路追踪</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Sleuth"><span class="nav-text">Spring Cloud Sleuth</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-10"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span class="nav-text">什么是链路追踪</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-Sleuth"><span class="nav-text">什么是 Sleuth</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%AF%E8%AF%AD"><span class="nav-text">术语</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B-2"><span class="nav-text">快速开始</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%89%8D%E6%8F%90%E9%A1%B9%E7%9B%AE"><span class="nav-text">前提项目</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE-2"><span class="nav-text">创建项目</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%91%E8%B5%B7%E8%B0%83%E7%94%A8"><span class="nav-text">发起调用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Span"><span class="nav-text">自定义Span</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BASpan"><span class="nav-text">创建Span</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%9E%E7%BB%ADSpan"><span class="nav-text">连续Span</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%88%B6%E7%BA%A7Span%E7%9A%84%E5%AD%90%E7%BA%A7Span"><span class="nav-text">创建父级Span的子级Span</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B3%A8%E8%A7%A3"><span class="nav-text">注解</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZipKin"><span class="nav-text">ZipKin</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-11"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">工作原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87"><span class="nav-text">前置准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ZipKin"><span class="nav-text">安装ZipKin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAZipKin%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">创建ZipKin客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E5%85%AD%EF%BC%8CAlibbaba"><span class="nav-text">十六，Alibbaba</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-12"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Alibaba-%E5%8A%9F%E8%83%BD"><span class="nav-text">Spring Cloud Alibaba 功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Alibaba-%E7%BB%84%E4%BB%B6"><span class="nav-text">Spring Cloud Alibaba 组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-text">什么是注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-text">常见的注册中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-text">为什么需要注册中心</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos"><span class="nav-text">Nacos</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-13"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-2"><span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-text">配置中心</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nacos%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">nacos客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%8B%89%E5%8F%96"><span class="nav-text">配置拉取</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-2"><span class="nav-text">配置中心</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sentinel"><span class="nav-text">Sentinel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="nav-text">控制台</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%88%9B%E5%BB%BA%E8%A7%84%E5%88%99"><span class="nav-text">控制台创建规则</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="xpp011"
      src="/images/tx.png">
  <p class="site-author-name" itemprop="name">xpp011</p>
  <div class="site-description" itemprop="description">欢迎来到我的博客，希望你能在这里找到有用的东西</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xpp011" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xpp011" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:xpp011.com@gmail.com" title="E-Mail → mailto:xpp011.com@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=2500176776&website=www.oicqzone.com" title="QQ → tencent:&#x2F;&#x2F;AddContact&#x2F;?fromId&#x3D;45&amp;fromSubId&#x3D;1&amp;subcmd&#x3D;all&amp;uin&#x3D;2500176776&amp;website&#x3D;www.oicqzone.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>QQ</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="http://beian.miit.gov.cn/" rel="noopener" target="_blank">沪ICP备2020031160号 </a>
      <img src="http://www.beian.gov.cn/portal/download" style="display: inline-block;">
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xpp011</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">280k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:14</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> & <a href="/" class="theme-link">本人舔着脸皮</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'eVNijxVeOcgiNTyd7VSPh2gf-9Nh9j0Va',
      appKey     : 'Hw6LYhLKzYKiM1S4mmWuJpg4',
      placeholder: "吐槽点什么吧,如果你想被回复时得到邮件通知就把邮箱地址填上吧^_^。",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>

<script type="text/javascript" src="/js/background.js"></script>
</html>
